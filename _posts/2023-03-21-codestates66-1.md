---
title: JWT ì ìš©ì„ ìœ„í•œ ì‚¬ì „ ì‘ì—…
excerpt: JWT ì ìš©ì„ ìœ„í•œ ì‚¬ì „ ì‘ì—…
categories: Spring
tags: [codestates, Spring]
toc: true
toc_sticky: true
author_profile: true
sidebar_main: true
published : true
---
## ì˜ì¡´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
```
dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
	implementation 'org.springframework.boot:spring-boot-starter-validation'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	compileOnly 'org.projectlombok:lombok'
	runtimeOnly 'com.h2database:h2'
	annotationProcessor 'org.projectlombok:lombok'
	implementation 'org.mapstruct:mapstruct:1.5.2.Final'
	annotationProcessor 'org.mapstruct:mapstruct-processor:1.5.2.Final'
	implementation 'org.springframework.boot:spring-boot-starter-mail'
	implementation 'com.google.code.gson:gson'

	implementation 'org.springframework.boot:spring-boot-starter-security' // (1)

  // (2) JWT ê¸°ëŠ¥ì„ ìœ„í•œ jjwt ë¼ì´ë¸ŒëŸ¬ë¦¬
	implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
	runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.5'
	runtimeOnly	'io.jsonwebtoken:jjwt-jackson:0.11.5'
}
```
(1) : ì• í”Œë¦¬ì¼€ì´ì…˜ì— Spring Securityë¥¼ ì ìš©í•˜ê¸° ìœ„í•œ spring-boot-starter-security  
(2) :  Spring Security ê¸°ë°˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— JWTë¥¼ ì ìš©í•˜ê¸° ìœ„í•œ jjwt ë¼ì´ë¸ŒëŸ¬ë¦¬

## ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
http://localhost:8080 ì ‘ì†  

![1](https://user-images.githubusercontent.com/90169862/226529177-7e2ba59c-3cef-4c52-a4ac-560d1cad9dae.PNG)

Spring Securityê°€ ì œê³µí•˜ëŠ” ë¡œê·¸ì¸ í™”ë©´ì—ì„œ Username(name)ê³¼ Password(intelliJ ë¡œê·¸ì— ì¶œë ¥) ì…ë ¥

![2](https://user-images.githubusercontent.com/90169862/226529219-2c6afa4e-6f55-4bcc-b341-e27dead6fdc4.PNG)

ì •ìƒì ìœ¼ë¡œ ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ ì—ëŸ¬ í˜ì´ì§€ê°€ ì¶œë ¥
- ë¡œê·¸ì¸ ì¸ì¦ì—ëŠ” ì„±ê³µí–ˆì§€ë§Œ ê¸°ë³¸ì ìœ¼ë¡œ Controller ê°™ì€ ì—”ë“œí¬ì¸íŠ¸ê°€ ì—†ì–´ì„œ ë°œìƒí•˜ëŠ” 404 ì—ëŸ¬

### SecurityConfiguration ì¶”ê°€
```
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.crypto.factory.PasswordEncoderFactories;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;

import static org.springframework.security.config.Customizer.withDefaults;

@Configuration
public class SecurityConfiguration {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
                .headers().frameOptions().sameOrigin() // (1)
                .and()
                .csrf().disable()        // (2)
                .cors(withDefaults())    // (3)
                .formLogin().disable()   // (4)
                .httpBasic().disable()   // (5)
                .authorizeHttpRequests(authorize -> authorize
                        .anyRequest().permitAll()                // (6)
                );
        return http.build();
    }

    // (7)
    @Bean
    public PasswordEncoder passwordEncoder() {
        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
    }

    // (8)
    @Bean
    CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("*"));   // (8-1)
        configuration.setAllowedMethods(Arrays.asList("GET","POST", "PATCH", "DELETE"));  // (8-2)

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();   // (8-3)
        source.registerCorsConfiguration("/**", configuration);      // (8-4)    
        return source;
    }
}
```
<div style = "text-align : center">Spring Securityë¥¼ í†µí•´ ë³´ì•ˆì„ ê°•í™”í•˜ê¸° ìœ„í•œ ì´ˆê¸° Security Configuration</div><br>

(1) : .frameOptions().sameOrigin() - H2 ì›¹ ì½˜ì†”ì˜ í™”ë©´ ìì²´ê°€ ë‚´ë¶€ì ìœ¼ë¡œ íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ê°œë°œ í™˜ê²½ì—ì„œëŠ” H2 ì›¹ ì½˜ì†”ì„ ì •ìƒì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì¶”ê°€
  - ë™ì¼ ì¶œì²˜ë¡œë¶€í„° ë“¤ì–´ì˜¤ëŠ” requestë§Œ í˜ì´ì§€ ë Œë”ë§ í—ˆìš©

(2) : CSRF(Cross-Site Request Forgery) ê³µê²©ì— ëŒ€í•œ Spring Securityì— ëŒ€í•œ ì„¤ì • ë¹„í™œì„±í™”
  - ì„¤ì •í•˜ì§€ ì•Šì„ ì‹œ, 403 ì—ëŸ¬ë¡œ ì¸í•œ ì •ìƒì ì¸ ì ‘ì† ë¶ˆê°€ëŠ¥

(3) : CORS ì„¤ì • ì¶”ê°€
  - .cors(withDefaults()) : corsConfigurationSourceë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë“±ë¡ëœ Bean ì´ìš©
    - CORSë¥¼ ì²˜ë¦¬í•˜ëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•ì€ CorsFilterë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì¸ë° CorsConfigurationSource Beanì„ ì œê³µí•¨ìœ¼ë¡œì¨ CorsFilter ì ìš© ê°€ëŠ¥

> ##### ğŸ’¡ CORS(Cross-Origin Resource Sharing)
> ì¶œì²˜ê°€ ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ ê¸°ë°˜ HTTP í†µì‹ ì„ í•˜ë”ë¼ë„ ì„ íƒì ìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•˜ë„ë¡ ë¸Œë¼ìš°ì €ì— ì•Œë ¤ì£¼ëŠ” ì •ì±…
> - ì• í”Œë¦¬ì¼€ì´ì…˜ ê°„ì— ì¶œì²˜(Origin)ê°€ ë‹¤ë¥¼ ê²½ìš° ìŠ¤í¬ë¦½íŠ¸ ê¸°ë°˜ì˜ HTTP í†µì‹ (XMLHttpRequest, Fetch API)ì„ í†µí•œ ë¦¬ì†ŒìŠ¤ ì ‘ê·¼ì´ ì œí•œë¨

(4) : CSR(Client Side Rendering) ë°©ì‹ì—ì„œ ì£¼ë¡œ ì‚¬ìš©í•˜ëŠ” JSON í¬ë§·ìœ¼ë¡œ Usernameê³¼ Passwordë¥¼ ì „ì†¡í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•  ê²ƒì´ë¯€ë¡œ í¼ ë¡œê·¸ì¸ ë°©ì‹ ë¹„í™œì„±í™”

(5) : HTTP Basic ì¸ì¦ ë°©ì‹ ë¹„í™œì„±í™”
  - requestë¥¼ ì „ì†¡í•  ë•Œë§ˆë‹¤ Username/Password ì •ë³´ë¥¼ HTTP Headerì— ì‹¤ì–´ì„œ ì¸ì¦ì„ í•˜ëŠ” ë°©ì‹
  - ì—¬ê¸°ì„œëŠ” ì‚¬ìš© X

> ğŸ’¡ í¼ ë¡œê·¸ì¸ê³¼ HTTP Basic ì¸ì¦ì„ disableí•˜ë©´ í•´ë‹¹ ì¸ì¦ê³¼ ê´€ë ¨ëœ Security Filter(UsernamePasswordAuthenticationFilter, BasicAuthenticationFilter ë“±)ê°€ ë¹„í™œì„±í™”ë¨

(6) :  JWTë¥¼ ì ìš©í•˜ê¸° ì „ì´ë¯€ë¡œ ìš°ì„ ì€ ëª¨ë“  HTTP request ìš”ì²­ì— ëŒ€í•´ ì ‘ê·¼ í—ˆìš©

(7) :  PasswordEncoder Bean ê°ì²´ ìƒì„±

(8) : CorsConfigurationSource Bean ìƒì„±ì„ í†µí•´ êµ¬ì²´ì ì¸ CORS ì •ì±… ì„¤ì •
  - (8-1) : setAllowedOrigins() - ëª¨ë“  ì¶œì²˜(Origin)ì— ëŒ€í•´ ìŠ¤í¬ë¦½íŠ¸ ê¸°ë°˜ì˜ HTTP í†µì‹ ì„ í—ˆìš©í•˜ë„ë¡ ì„¤ì • 
    - ìš´ì˜ ì„œë²„ í™˜ê²½ì—ì„œ ìš”êµ¬ì‚¬í•­ì— ë§ê²Œ ë³€ê²½ ê°€ëŠ¥
  - (8-2) : setAllowedMethods() - íŒŒë¼ë¯¸í„°ë¡œ ì§€ì •í•œ HTTP Methodì— ëŒ€í•œ HTTP í†µì‹  í—ˆìš©
  - (8-3) : CorsConfigurationSource ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ í´ë˜ìŠ¤ì¸ UrlBasedCorsConfigurationSource í´ë˜ìŠ¤ì˜ ê°ì²´ ìƒì„±
  - (8-4) : ëª¨ë“  URLì— ì•ì—ì„œ êµ¬ì„±í•œ CORS ì •ì±…(CorsConfiguration)ì„ ì ìš©

  ## íšŒì› ê°€ì… ë¡œì§ ìˆ˜ì •

  ### MemberDto.Post í´ë˜ìŠ¤
  ```
  public class MemberDto {
    @Getter
    @AllArgsConstructor
    public static class Post {
        @NotBlank
        @Email
        private String email;

        // (1) íŒ¨ìŠ¤ì›Œë“œ í•„ë“œ ì¶”ê°€
        @NotBlank
        private String password;

        @NotBlank(message = "ì´ë¦„ì€ ê³µë°±ì´ ì•„ë‹ˆì–´ì•¼ í•©ë‹ˆë‹¤.")
        private String name;

        @Pattern(regexp = "^010-\\d{3,4}-\\d{4}$",
                message = "íœ´ëŒ€í° ë²ˆí˜¸ëŠ” 010ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” 11ìë¦¬ ìˆ«ìì™€ '-'ë¡œ êµ¬ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.")
        private String phone;
    }

    ...
    ...
  }
  ```
íšŒì› ë“±ë¡ ì‹œ, íšŒì›ì˜ íŒ¨ìŠ¤ì›Œë“œ ì •ë³´ë¥¼ ì „ë‹¬ë°›ê¸° ìœ„í•´ password í•„ë“œ ì¶”ê°€

> ğŸ’¡ ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì‚¬ìš©ìê°€ íšŒì› ê°€ì… ì‹œ, íŒ¨ìŠ¤ì›Œë“œë¥¼ í•œ ë²ˆë§Œ ì…ë ¥í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì‚¬ìš©ìê°€ ì…ë ¥í•œ íŒ¨ìŠ¤ì›Œë“œê°€ ë§ëŠ”ì§€ ì¬í™•ì¸í•˜ê¸° ìœ„í•´ íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥ í™•ì¸ í•„ë“œê°€ ì¶”ê°€ë¡œ ì¡´ì¬í•˜ëŠ” ê²½ìš°ê°€ ëŒ€ë¶€ë¶„ì´ê³ , ì…ë ¥í•œ ë‘ íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦í•˜ëŠ” ë¡œì§ì´ í•„ìš”
ë˜í•œ íŒ¨ìŠ¤ì›Œë“œì˜ ìƒì„± ê·œì¹™(ëŒ€/ì†Œë¬¸ì, íŒ¨ìŠ¤ì›Œë“œ ê¸¸ì´, íŠ¹ìˆ˜ ë¬¸ì í¬í•¨ ì—¬ë¶€ ë“±)ì— ëŒ€í•œ ìœ íš¨ì„± ê²€ì¦ë„ ì‹¤ì‹œ

###  Member ì—”í‹°í‹° í´ë˜ìŠ¤
```
@NoArgsConstructor
@Getter
@Setter
@Entity
public class Member extends Auditable {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long memberId;

    @Column(nullable = false, updatable = false, unique = true)
    private String email;

    // (1) ì¶”ê°€
    @Column(length = 100, nullable = false)
    private String password;

    ...
    ...

    // (2) ì¶”ê°€
    @ElementCollection(fetch = FetchType.EAGER)
    private List<String> roles = new ArrayList<>();

    ...
    ...
}
```

(1) : Member ì—”í‹°í‹° í´ë˜ìŠ¤ì— íŒ¨ìŠ¤ì›Œë“œ í•„ë“œ ì¶”ê°€
  - passwordëŠ” ì•”í˜¸í™” ë˜ì–´ ì €ì¥ë˜ê¸° ë•Œë¬¸ì— ì»¬ëŸ¼ì˜ ê¸¸ì´ëŠ” 100ìœ¼ë¡œ ì§€ì •
  - íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥ ê·œì¹™ì— ë”°ë¼ì„œ password ê¸¸ì´ëŠ” ë‹¬ë¼ì§ˆ ìˆ˜ 
  
(2) : @ElementCollection ì• ë„ˆí…Œì´ì…˜ì„ ì´ìš©í•´ ì‚¬ìš©ì ë“±ë¡ ì‹œ, ì‚¬ìš©ìì˜ ê¶Œí•œì„ ë“±ë¡í•˜ê¸° ìœ„í•œ ê¶Œí•œ í…Œì´ë¸” ìƒì„±

### ì‚¬ìš©ì ë“±ë¡ ì‹œ, íŒ¨ìŠ¤ì›Œë“œì™€ ì‚¬ìš©ì ê¶Œí•œ ì €ì¥
```
@Transactional
@Service
public class MemberService {
    private final MemberRepository memberRepository;
    private final ApplicationEventPublisher publisher;

    // (1) ì¶”ê°€
    private final PasswordEncoder passwordEncoder;
    private final CustomAuthorityUtils authorityUtils;

    // (2) ìƒì„±ì DIìš© íŒŒë¼ë¯¸í„° ì¶”ê°€
    public MemberService(MemberRepository memberRepository,
                         ApplicationEventPublisher publisher,
                         PasswordEncoder passwordEncoder,
                         CustomAuthorityUtils authorityUtils) {
        this.memberRepository = memberRepository;
        this.publisher = publisher;
        this.passwordEncoder = passwordEncoder;
        this.authorityUtils = authorityUtils;
    }

    public Member createMember(Member member) {
        verifyExistsEmail(member.getEmail());

        // (3) ì¶”ê°€: Password ì•”í˜¸í™”
        String encryptedPassword = passwordEncoder.encode(member.getPassword());
        member.setPassword(encryptedPassword);

        // (4) ì¶”ê°€: DBì— User Role ì €ì¥
        List<String> roles = authorityUtils.createRoles(member.getEmail());
        member.setRoles(roles);

        Member savedMember = memberRepository.save(member);

        publisher.publishEvent(new MemberRegistrationApplicationEvent(this, savedMember));
        return savedMember;
    }

    ...
    ...
}
```
(1), (2) : PasswordEncoderì™€ CustomAuthorityUtils í´ë˜ìŠ¤ DI 
(3) : íŒ¨ìŠ¤ì›Œë“œ ë‹¨ë°©í–¥ ì•”í˜¸í™”
(4) : ë“±ë¡í•˜ëŠ” ì‚¬ìš©ìì˜ ê¶Œí•œ ì •ë³´ ìƒì„±

