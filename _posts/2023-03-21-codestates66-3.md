---
title: JWTë¥¼ ì´ìš©í•œ ìê²© ì¦ëª… ë° ê²€ì¦ êµ¬í˜„
excerpt: ë¡œê·¸ì¸ ì¸ì¦ì— ì„±ê³µí•œ ì‚¬ìš©ìì—ê²Œ JWT ìƒì„± ë° ë°œê¸‰
categories: Spring
tags: [codestates, Spring]
toc: true
toc_sticky: true
author_profile: true
sidebar_main: true
published : true
---
JWTë¥¼ ì´ìš©í•œ ìê²© ì¦ëª… ë° ê²€ì¦ êµ¬í˜„
ì´ì „ ì±•í„°ì—ì„œ íšŒì› ê°€ì… ì‹œ ë“±ë¡í•œ ì´ë©”ì¼ ì£¼ì†Œì™€ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì´ìš©í•´ ë¡œê·¸ì¸ ì¸ì¦ì„ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰í•˜ë©´ response header(Authorization, Refresh)ë¥¼ í†µí•´ JWTë¥¼ ì „ë‹¬ë°›ì„ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.


ì´ë²ˆ ì‹œê°„ì—ëŠ” í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ JWTë¥¼ ì´ìš©í•´ ìê²© ì¦ëª…ì´ í•„ìš”í•œ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ request ì „ì†¡ ì‹œ, request headerë¥¼ í†µí•´ ì „ë‹¬ë°›ì€ JWTë¥¼ ì„œë²„ ì¸¡ì—ì„œ ê²€ì¦í•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•´ ë³´ê² ìŠµë‹ˆë‹¤.



JWT ê²€ì¦ ê¸°ëŠ¥ êµ¬í˜„
1ï¸âƒ£ JWT ê²€ì¦ í•„í„° êµ¬í˜„
JWT ê²€ì¦ì„ ìœ„í•´ ê°€ì¥ ë¨¼ì € í•´ì•¼ í•  ì‘ì—…ì€ JWTë¥¼ ê²€ì¦í•˜ëŠ” ì „ìš© Security Filterë¥¼ êµ¬í˜„í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.


JwtVerificationFilter

```java
package com.codestates.auth.filter;

import com.codestates.auth.jwt.JwtTokenizer;
import com.codestates.auth.utils.CustomAuthorityUtils;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.filter.OncePerRequestFilter;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;
import java.util.Map;

public class JwtVerificationFilter extends OncePerRequestFilter {  // (1)
    private final JwtTokenizer jwtTokenizer;
    private final CustomAuthorityUtils authorityUtils;

    // (2)
    public JwtVerificationFilter(JwtTokenizer jwtTokenizer,
                                 CustomAuthorityUtils authorityUtils) {
        this.jwtTokenizer = jwtTokenizer;
        this.authorityUtils = authorityUtils;
    }

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        Map<String, Object> claims = verifyJws(request); // (3)
        setAuthenticationToContext(claims);      // (4)

        filterChain.doFilter(request, response); // (5)
    }

    // (6)
    @Override
    protected boolean shouldNotFilter(HttpServletRequest request) throws ServletException {
        String authorization = request.getHeader("Authorization");  // (6-1)

        return authorization == null || !authorization.startsWith("Bearer");  // (6-2)
    }

    private Map<String, Object> verifyJws(HttpServletRequest request) {
        String jws = request.getHeader("Authorization").replace("Bearer ", ""); // (3-1)
        String base64EncodedSecretKey = jwtTokenizer.encodeBase64SecretKey(jwtTokenizer.getSecretKey()); // (3-2)
        Map<String, Object> claims = jwtTokenizer.getClaims(jws, base64EncodedSecretKey).getBody();   // (3-3)

        return claims;
    }

    private void setAuthenticationToContext(Map<String, Object> claims) {
        String username = (String) claims.get("username");   // (4-1)
        List<GrantedAuthority> authorities = authorityUtils.createAuthorities((List)claims.get("roles"));  // (4-2)
        Authentication authentication = new UsernamePasswordAuthenticationToken(username, null, authorities);  // (4-3)
        SecurityContextHolder.getContext().setAuthentication(authentication); // (4-4)
    }
}
```
[ì½”ë“œ 4-84] JWT ê²€ì¦ì„ ìœ„í•œ JwtVerificationFilter


ì½”ë“œ 4-84ëŠ” í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì „ì†¡ëœ request headerì— í¬í•¨ëœ JWTì— ëŒ€í•´ ê²€ì¦ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” JwtVerificationFilterì˜ ì½”ë“œì…ë‹ˆë‹¤.


ì½”ë“œì˜ ì„¤ëª…ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

Spring Securityì—ì„œëŠ” (1)ê³¼ ê°™ì´ OncePerRequestFilterë¥¼ í™•ì¥í•´ì„œ request ë‹¹ í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ëŠ” Security Filterë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

JWTì˜ ê²€ì¦ì€ request ë‹¹ ë‹¨ í•œ ë²ˆë§Œ ìˆ˜í–‰í•˜ë©´ ë˜ê¸° ë•Œë¬¸ì— JWT ì „ìš© Filterë¡œ ë§Œë“¤ê¸°ì—ëŠ” OncePerRequestFilterë¥¼ ì´ìš©í•˜ëŠ” ê²ƒì´ ì ì ˆí•˜ë‹¤ê³  ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ğŸ’¡ ì¸ì¦ê³¼ ê´€ë ¨ëœ FilterëŠ” ì„±ê³µì´ëƒ ì‹¤íŒ¨ëƒë¥¼ ë‹¨ í•œ ë²ˆë§Œ íŒë‹¨í•˜ë©´ ë©ë‹ˆë‹¤. ì„±ê³µë„ ì•„ë‹ˆê³  ì‹¤íŒ¨ë„ ì•„ë‹Œ ì–´ì¤‘ê°„í•œ ê²°ê³¼ëŠ” ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©° ì—¬ëŸ¬ ë²ˆ íŒë‹¨í•  í•„ìš”ë„ ì—†ëŠ” ê²ƒì…ë‹ˆë‹¤.


(2)ì™€ ê°™ì´ JwtTokenizerì™€ CustomAuthorityUtilsë¥¼ DI ë°›ìŠµë‹ˆë‹¤.

JwtTokenizerëŠ” JWTë¥¼ ê²€ì¦í•˜ê³  Claims(í† í°ì— í¬í•¨ëœ ì •ë³´)ë¥¼ ì–»ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

CustomAuthorityUtilsëŠ” JWT ê²€ì¦ì— ì„±ê³µí•˜ë©´ Authentication ê°ì²´ì— ì±„ìš¸ ì‚¬ìš©ìì˜ ê¶Œí•œì„ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.


(3)ì˜ verifyJws() ë©”ì„œë“œëŠ” JWTë¥¼ ê²€ì¦í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” private ë©”ì„œë“œì…ë‹ˆë‹¤.

(3-1)ì—ì„œëŠ” requestì˜ headerì—ì„œ JWTë¥¼ ì–»ê³  ìˆìŠµë‹ˆë‹¤.

ì´ì „ ì±•í„°ì—ì„œ í´ë¼ì´ì–¸íŠ¸ì˜ ë¡œê·¸ì¸ ì¸ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰ë˜ë©´, ì„œë²„ ì¸¡ì—ì„œ Authorization headerì— JWTë¥¼ ì¶”ê°€í–ˆë˜ ë¡œì§ì„ ë– ì˜¬ë ¤ ë³´ê¸° ë°”ëë‹ˆë‹¤.

ğŸ’¡ ì´ì „ ì±•í„°ì—ì„œ Authorization headerì— ì¶”ê°€ëœ JWTëŠ” response headerì— í¬í•¨ëœ ê²ƒì´ê³ , (3-1)ì—ì„œì˜ JWTëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ response headerë¡œ ì „ë‹¬ë°›ì€ JWTë¥¼ request headerì— ì¶”ê°€í•´ì„œ ì„œë²„ ì¸¡ì— ì „ì†¡í•œ ê²ƒì´ë¼ëŠ” ì‚¬ì‹¤ì„ ìŠì§€ ë§ˆì„¸ìš”!

ê·¸ë¦¬ê³  String í´ë˜ìŠ¤ì˜ replace() ë©”ì„œë“œë¥¼ ì´ìš©í•´ â€œBearer â€œë¶€ë¶„ì„ ì œê±°í•©ë‹ˆë‹¤.

ğŸ’¡ (3-1)ì—ì„œ ë³€ìˆ˜ëª…ì„ jwsë¡œ ì§€ì •í•œ ì´ìœ ëŠ” ì„œëª…ëœ JWTë¥¼ JWS(JSON Web Token Signed)ë¼ê³  ë¶€ë¥´ê¸° ë•Œë¬¸ì´ë¼ëŠ” ì  ì°¸ê³ í•˜ì„¸ìš”.

(3-2)ì—ì„œëŠ” JWT ì„œëª…(Signature)ì„ ê²€ì¦í•˜ê¸° ìœ„í•œ Secret Keyë¥¼ ì–»ìŠµë‹ˆë‹¤.

(3-3)ì—ì„œëŠ” JWTì—ì„œ Claimsë¥¼ íŒŒì‹± í•©ë‹ˆë‹¤.

ì—¬ê¸°ì„œ ê¸°ì–µí•´ì•¼ í•  ë¶€ë¶„ì€ JWTì—ì„œ Claimsë¥¼ íŒŒì‹± í•  ìˆ˜ ìˆë‹¤ëŠ” ì˜ë¯¸ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ì„œëª…(Signature) ê²€ì¦ì— ì„±ê³µí–ˆë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.

â­ ì¦‰, verify() ê°™ì€ ê²€ì¦ ë©”ì„œë“œê°€ ë”°ë¡œ ì¡´ì¬í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ Claimsê°€ ì •ìƒì ìœ¼ë¡œ íŒŒì‹±ì´ ë˜ë©´ ì„œëª… ê²€ì¦ ì—­ì‹œ ìì—°ìŠ¤ëŸ½ê²Œ ì„±ê³µí–ˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¼­ ê¸°ì–µí•˜ê¸° ë°”ëë‹ˆë‹¤.


(4)ì˜ setAuthenticationToContext() ë©”ì„œë“œëŠ” Authentication ê°ì²´ë¥¼ SecurityContextì— ì €ì¥í•˜ê¸° ìœ„í•œ private ë©”ì„œë“œì…ë‹ˆë‹¤.

(4-1)ì—ì„œëŠ” JWTì—ì„œ íŒŒì‹± í•œ Claimsì—ì„œ usernameì„ ì–»ìŠµë‹ˆë‹¤.

(4-2)ì—ì„œëŠ” JWTì˜ Claimsì—ì„œ ì–»ì€ ê¶Œí•œ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ List<GrantedAuthorityë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

(4-3)ì—ì„œëŠ” usernameê³¼ List<GrantedAuthorityë¥¼ í¬í•¨í•œ Authentication ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

(4-4)ì—ì„œëŠ” SecurityContextì— Authentication ê°ì²´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.


â­ JWTëŠ” í´ë¼ì´ì–¸íŠ¸ ì •ë³´ ë“±ì˜ ìƒíƒœë¥¼ ì €ì¥í•˜ì§€ ì•ŠëŠ” Statelessí•œ ë°©ì‹ì¸ë° SecurityContextì— Authenticationì„ ì €ì¥í•˜ê²Œ ë˜ë©´ ì„¸ì…˜ì˜ ìƒíƒœëŠ” ì–´ë–»ê²Œ ë˜ëŠ”ì§€ ê¶ê¸ˆí•´í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

SecurityContextì— Authenticationì„ ì €ì¥í•˜ê²Œ ë˜ë©´ Spring Securityì˜ ì„¸ì…˜ ì •ì±…(Session Policy)ì— ë”°ë¼ì„œ ì„¸ì…˜ì„ ìƒì„±í•  ìˆ˜ë„ ìˆê³ , ê·¸ë ‡ì§€ ì•Šì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

JWT í™˜ê²½ì—ì„œëŠ” ì„¸ì…˜ ì •ì±…(Session Policy) ì„¤ì •ì„ í†µí•´ ì„¸ì…˜ ìì²´ë¥¼ ìƒì„±í•˜ì§€ ì•Šë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.

ì„¸ì…˜ ì •ì±…(Session Policy)ì— ëŒ€í•´ì„œëŠ” ì´ì–´ì„œ ë°”ë¡œ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.


ë¬¸ì œì—†ì´ JWTì˜ ì„œëª… ê²€ì¦ì— ì„±ê³µí•˜ê³ , Security Contextì— Authenticationì„ ì €ì¥í•œ ë’¤ì—ëŠ” (5)ì™€ ê°™ì´ ë‹¤ìŒ(Next) Security Filterë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

(6)ì€ OncePerRequestFilterì˜ shouldNotFilter()ë¥¼ ì˜¤ë²„ë¼ì´ë“œ í•œ ê²ƒìœ¼ë¡œ, íŠ¹ì • ì¡°ê±´ì— ë¶€í•©í•˜ë©´(trueì´ë©´) í•´ë‹¹ Filterì˜ ë™ì‘ì„ ìˆ˜í–‰í•˜ì§€ ì•Šê³  ë‹¤ìŒ Filterë¡œ ê±´ë„ˆë›°ë„ë¡ í•´ì¤ë‹ˆë‹¤.

(6-1)ì—ì„œ Authorization headerì˜ ê°’ì„ ì–»ì€ í›„ì—

(6-2)ì—ì„œëŠ” Authorization headerì˜ ê°’ì´ nullì´ê±°ë‚˜ Authorization headerì˜ ê°’ì´ â€œBearerâ€ë¡œ ì‹œì‘í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ í•´ë‹¹ Filterì˜ ë™ì‘ì„ ìˆ˜í–‰í•˜ì§€ ì•Šë„ë¡ ì •ì˜í•©ë‹ˆë‹¤.

â­ ì´ ë§ì˜ ì˜ë¯¸ëŠ” JWTê°€ Authorization headerì— í¬í•¨ë˜ì§€ ì•Šì•˜ë‹¤ë©´ JWT ìê²©ì¦ëª…ì´ í•„ìš”í•˜ì§€ ì•Šì€ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ìš”ì²­ì´ë¼ê³  íŒë‹¨í•˜ê³  ë‹¤ìŒ(Next) Filterë¡œ ì²˜ë¦¬ë¥¼ ë„˜ê¸°ëŠ” ê²ƒì…ë‹ˆë‹¤.

â­ ë§Œì¼ JWT ìê²© ì¦ëª…ì´ í•„ìš”í•œ ë¦¬ì†ŒìŠ¤ ìš”ì²­ì¸ë° ì‹¤ìˆ˜ë¡œ JWTë¥¼ í¬í•¨í•˜ì§€ ì•Šì•˜ë‹¤ í•˜ë”ë¼ë„ ì´ ê²½ìš°ì—ëŠ” Authenticationì´ ì •ìƒì ìœ¼ë¡œ SecurityContextì— ì €ì¥ë˜ì§€ ì•Šì€ ìƒíƒœì´ê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ Security Filterë¥¼ ê±°ì³ ê²°êµ­ Exceptionì„ ë˜ì§€ê²Œ ë  ê²ƒì…ë‹ˆë‹¤.



2ï¸âƒ£ SecurityConfiguration ì„¤ì • ì—…ë°ì´íŠ¸
JwtVerificationFilterë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ì•„ë˜ì™€ ê°™ì€ ë‘ ê°€ì§€ ì„¤ì •ì„ SecurityConfigruationì— ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.

ì„¸ì…˜ ì •ì±… ì„¤ì • ì¶”ê°€

JwtVerificationFilter ì¶”ê°€


JwtVerificationFilterì—ì„œ JWTì˜ ìê²© ê²€ì¦ì— ì„±ê³µí•˜ê²Œ ë˜ë©´ ì¸ì¦ëœ Authentication ê°ì²´ë¥¼ SecurityContextì— ì €ì¥í•©ë‹ˆë‹¤. (ì½”ë“œ 4-84ì˜ (4)ë¥¼ ì°¸ê³ í•´ ì£¼ì„¸ìš”)

ê·¸ëŸ°ë° ì•ì—ì„œ ì–¸ê¸‰í•œ ê²ƒì²˜ëŸ¼ statelessí•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ì„¸ì…˜ ìœ ì§€ ì‹œê°„ì„ ì•„ì£¼ ì§§ê²Œ ê°€ì ¸ê°€ê¸° ìœ„í•œ(ê±°ì˜ ë¬´ìƒíƒœ) ì„¤ì •ì„ SecurityConfigruationì— ì¶”ê°€í•  í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.


ê·¸ë¦¬ê³  ì¶”ê°€ì ìœ¼ë¡œ JwtVerificationFilterë¥¼ Security Filter Chainì— ì¶”ê°€í•´ ë³´ê² ìŠµë‹ˆë‹¤.


SecurityConfiguration(V4)

```java
package com.codestates.config;

import com.codestates.auth.filter.JwtAuthenticationFilter;
import com.codestates.auth.filter.JwtVerificationFilter;
import com.codestates.auth.handler.MemberAuthenticationFailureHandler;
import com.codestates.auth.handler.MemberAuthenticationSuccessHandler;
import com.codestates.auth.jwt.JwtTokenizer;
import com.codestates.auth.utils.CustomAuthorityUtils;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.factory.PasswordEncoderFactories;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;

import static org.springframework.security.config.Customizer.withDefaults;

/**
 * SessionCreationPolicy ì„¤ì • ì¶”ê°€
 */
@Configuration
public class SecurityConfiguration {
    private final JwtTokenizer jwtTokenizer;
    private final CustomAuthorityUtils authorityUtils; // ì¶”ê°€

    public SecurityConfigurationV6(JwtTokenizer jwtTokenizer,
                                   CustomAuthorityUtils authorityUtils) {
        this.jwtTokenizer = jwtTokenizer;
        this.authorityUtils = authorityUtils;
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .headers().frameOptions().sameOrigin()
            .and()
            .csrf().disable()
            .cors(withDefaults())
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)  // (1) ì¶”ê°€
            .and()
            .formLogin().disable()
            .httpBasic().disable()
            .apply(new CustomFilterConfigurer())
            .and()
            .authorizeHttpRequests(authorize -> authorize
                    .anyRequest().permitAll()
            );
        return http.build();
    }

    ...
    ...

    public class CustomFilterConfigurer extends AbstractHttpConfigurer<CustomFilterConfigurer, HttpSecurity> {
        @Override
        public void configure(HttpSecurity builder) throws Exception {
            AuthenticationManager authenticationManager = builder.getSharedObject(AuthenticationManager.class);

            JwtAuthenticationFilter jwtAuthenticationFilter = new JwtAuthenticationFilter(authenticationManager, jwtTokenizer);
            jwtAuthenticationFilter.setFilterProcessesUrl("/v11/auth/login");
            jwtAuthenticationFilter.setAuthenticationSuccessHandler(new MemberAuthenticationSuccessHandler());
            jwtAuthenticationFilter.setAuthenticationFailureHandler(new MemberAuthenticationFailureHandler());

            JwtVerificationFilter jwtVerificationFilter = new JwtVerificationFilter(jwtTokenizer, authorityUtils);  // (2) ì¶”ê°€

            builder
                .addFilter(jwtAuthenticationFilter)
                .addFilterAfter(jwtVerificationFilter, JwtAuthenticationFilter.class);   // (3)ì¶”ê°€
        }
    }
}
```
[ì½”ë“œ 4-85] JWT ê²€ì¦ì„ ìœ„í•œ ì„¤ì • ì¶”ê°€(V4)


ì½”ë“œ 4-85ëŠ” JWT ê²€ì¦ì„ ìœ„í•œ ì¶”ê°€ ì„¤ì •ì´ í¬í•¨ëœ SecurityConfigurationì˜ ì½”ë“œ ì¼ë¶€ì…ë‹ˆë‹¤.


ì½”ë“œì˜ ì„¤ëª…ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

(1)ì˜ .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)ë¥¼ í†µí•´ì„œ ì„¸ì…˜ì„ ìƒì„±í•˜ì§€ ì•Šë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.

SessionCreationPolicyì˜ ì„¤ì •ê°’ìœ¼ë¡œëŠ” ì•„ë˜ì™€ ê°™ì´ ì´ ë„¤ ê°œì˜ ê°’ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

SessionCreationPolicy.*ALWAYS*

í•­ìƒ ì„¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.
SessionCreationPolicy.NEVER

ì„¸ì…˜ì„ ìƒì„±í•˜ì§€ ì•Šì§€ë§Œ ë§Œì•½ì— ì´ë¯¸ ìƒì„±ëœ ì„¸ì…˜ì´ ìˆë‹¤ë©´ ì‚¬ìš©í•©ë‹ˆë‹¤.
SessionCreationPolicy.*IF_REQUIRED*

í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì„¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.
SessionCreationPolicy.*STATELESS*

ì„¸ì…˜ì„ ìƒì„±í•˜ì§€ ì•Šìœ¼ë©°, SecurityContext ì •ë³´ë¥¼ ì–»ê¸° ìœ„í•´ ê²°ì½” ì„¸ì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
(2)ì—ì„œëŠ” JwtVerificationFilterì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ë©´ì„œ JwtVerificationFilterì—ì„œ ì‚¬ìš©ë˜ëŠ” ê°ì²´ë“¤ì„ ìƒì„±ìë¡œ DI í•´ì¤ë‹ˆë‹¤.

(3)ì—ì„œëŠ” JwtVerificationFilterë¥¼ JwtAuthenticationFilter ë’¤ì— ì¶”ê°€í•©ë‹ˆë‹¤.

JwtVerificationFilterëŠ” JwtAuthenticationFilterì—ì„œ ë¡œê·¸ì¸ ì¸ì¦ì— ì„±ê³µí•œ í›„ ë°œê¸‰ë°›ì€ JWTê°€ í´ë¼ì´ì–¸íŠ¸ì˜ request header(Authorization í—¤ë”)ì— í¬í•¨ë˜ì–´ ìˆì„ ê²½ìš°ì—ë§Œ ë™ì‘í•©ë‹ˆë‹¤.



ì„œë²„ ì¸¡ ë¦¬ì†ŒìŠ¤ì— ì—­í• (Role) ê¸°ë°˜ ê¶Œí•œ ì ìš©
ë¡œê·¸ì¸ ì¸ì¦ í›„, JWTë„ ë¬´ì‚¬íˆ ì˜ ë°œê¸‰ë˜ê³  ë°œê¸‰ëœ JWTë¥¼ ì´ìš©í•´ì„œ í´ë¼ì´ì–¸íŠ¸ì˜ ìê²© ì¦ëª…ì— ëŒ€í•œ ê²€ì¦ê¹Œì§€ ì˜ ë˜ëŠ” ê±¸ í™•ì¸í–ˆìŠµë‹ˆë‹¤.

ê·¸ëŸ°ë° Spring Security ìª½ì—ì„œ ì„œë²„ ì¸¡ ë¦¬ì†ŒìŠ¤ì— ì ì ˆí•œ ì ‘ê·¼ ê¶Œí•œ ì„¤ì •ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì•„ë¬´ë¦¬ JWTë¥¼ ì‚¬ìš©í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì˜ ìê²© ì¦ëª…ì´ í™•ì¸ëœë‹¤ í•˜ë”ë¼ë„ ê·¸ ì˜ë¯¸ê°€ í‡´ìƒ‰ë©ë‹ˆë‹¤.

JWTë¥¼ ì´ìš©í•œ ìê²© ì¦ëª…ì´ë¼ëŠ” ì˜ë¯¸ì—ëŠ” íŠ¹ì • ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì ì ˆí•œ ê¶Œí•œì„ ê°€ì¡ŒëŠ”ì§€ë¥¼ íŒë‹¨í•´ì•¼ í•œë‹¤ëŠ” ì˜ë¯¸ë„ í¬í•¨í•˜ê³  ìˆìœ¼ë‹ˆê¹Œìš”.


í˜„ì¬ê¹Œì§€ì˜ SecurityConfigurationì—ëŠ” ì•„ë˜ì˜ ì½”ë“œ 4-86ê³¼ ê°™ì´ ì‚¬ìš©ìì˜ ê¶Œí•œ ì—¬ë¶€ì— ìƒê´€ì—†ì´ í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ëª¨ë“  ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •ëœ ìƒíƒœì…ë‹ˆë‹¤.


ì ‘ê·¼ ê¶Œí•œ ì„¤ì •ì´ ë˜ì–´ ìˆì§€ ì•Šì€ SecurityConfiguration(V4)

```java
package com.codestates.config;

import com.codestates.auth.filter.JwtAuthenticationFilter;
import com.codestates.auth.handler.MemberAuthenticationFailureHandler;
import com.codestates.auth.handler.MemberAuthenticationSuccessHandler;
import com.codestates.auth.jwt.JwtTokenizer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.crypto.factory.PasswordEncoderFactories;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;

import static org.springframework.security.config.Customizer.withDefaults;

@Configuration
public class SecurityConfiguration {
    ...
    ...

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .headers().frameOptions().sameOrigin()
            .and()
            .csrf().disable()
            .cors(withDefaults())
            .formLogin().disable()
            .httpBasic().disable()
            .apply(new CustomFilterConfigurer())
            .and()
            .authorizeHttpRequests(authorize -> authorize
                    .anyRequest().permitAll()               // (1)
            );
        return http.build();
    }
    
    ...
    ...
}
```
[ì½”ë“œ 4-86] ì ‘ê·¼ ê¶Œí•œ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ ëª¨ë“  ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì ‘ê·¼ì´ í—ˆìš©ëœ ìƒíƒœ


ì½”ë“œ 4-86ì„ ë³´ë©´ (1)ê³¼ ê°™ì´ .anyRequest().permitAll()ë¥¼ í†µí•´ ì„œë²„ ì¸¡ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  requestì— ëŒ€í•´ì„œ ì ‘ê·¼ì„ í—ˆìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.


ì´ì œ ìš°ë¦¬ê°€ ì—¬íƒœê¹Œì§€ êµ¬í˜„í•´ ë³¸ ì»¤í”¼ ì£¼ë¬¸ ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¦¬ì†ŒìŠ¤ ì¤‘ì—ì„œ MemberControllerë¥¼ í†µí•´ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.


ìˆ˜ì •ëœ SecurityConfiguration(V5)

```java
package com.codestates.config;

import com.codestates.auth.filter.JwtAuthenticationFilter;
import com.codestates.auth.filter.JwtVerificationFilter;
import com.codestates.auth.handler.MemberAccessDeniedHandler;
import com.codestates.auth.handler.MemberAuthenticationEntryPoint;
import com.codestates.auth.handler.MemberAuthenticationFailureHandler;
import com.codestates.auth.handler.MemberAuthenticationSuccessHandler;
import com.codestates.auth.jwt.JwtTokenizer;
import com.codestates.auth.utils.CustomAuthorityUtils;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.factory.PasswordEncoderFactories;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.AuthenticationFailureHandler;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;

import static org.springframework.security.config.Customizer.withDefaults;

@Configuration
public class SecurityConfiguration {
    ...
    ...

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .headers().frameOptions().sameOrigin()
            .and()
            .csrf().disable()
            .cors(withDefaults())
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            .formLogin().disable()
            .httpBasic().disable()
            .apply(new CustomFilterConfigurer())
            .and()
            .authorizeHttpRequests(authorize -> authorize
                    .antMatchers(HttpMethod.POST, "/*/members").permitAll()         // (1) ì¶”ê°€
                    .antMatchers(HttpMethod.PATCH, "/*/members/**").hasRole("USER")  // (2) ì¶”ê°€
                    .antMatchers(HttpMethod.GET, "/*/members").hasRole("ADMIN")     // (3) ì¶”ê°€
                    .antMatchers(HttpMethod.GET, "/*/members/**").hasAnyRole("USER", "ADMIN")  // (4) ì¶”ê°€
                    .antMatchers(HttpMethod.DELETE, "/*/members/**").hasRole("USER")  // (5) ì¶”ê°€
                    .anyRequest().permitAll()
            );
        return http.build();
    }
    
    ...
    ...
}
```
[ì½”ë“œ 4-87] MemberControllerì— ëŒ€í•œ ì—­í• (Role) ê¸°ë°˜ì˜ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬


ì½”ë“œ 4-87ì€ MemberControllerë¥¼ í†µí•´ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë¦¬ì†ŒìŠ¤ì— ëŒ€í•´ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•œ SecurityConfiguration ì½”ë“œì˜ ì¼ë¶€ì…ë‹ˆë‹¤.


ì½”ë“œì— ëŒ€í•œ ì„¤ëª…ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

íšŒì› ë“±ë¡ì˜ ê²½ìš°, ì ‘ê·¼ ê¶Œí•œ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ ëˆ„êµ¬ë‚˜ ì ‘ê·¼ì´ ê°€ëŠ¥í•´ì•¼ í•˜ë¯€ë¡œ (1)ê³¼ ê°™ì´ íšŒì›ë“±ë¡ì— ì‚¬ìš©ë˜ëŠ” URL(â€/v11/membersâ€)ê³¼ HTTP Method(ì—¬ê¸°ì„œëŠ” POST)ì— í•´ë‹¹ëœë‹¤ë©´ ì ‘ê·¼ì„ í—ˆìš©í•©ë‹ˆë‹¤.

ì—¬ëŸ¬ë¶„ë“¤ì´ MemberControllerì˜ postMember() í•¸ë“¤ëŸ¬ ë©”ì„œë“œì˜ URLê³¼ HTTP Methodë¥¼ í™•ì¸í•´ ë³¸ë‹¤ë©´ (1)ì—ì„œ ì„¤ì •í•œ ì¡°ê±´ì´ ì´í•´ê°€ ë˜ë¦¬ë¼ ìƒê°í•©ë‹ˆë‹¤.


íšŒì› ì •ë³´ ìˆ˜ì •ì˜ ê²½ìš°, (2)ì™€ ê°™ì´ ì¼ë°˜ ì‚¬ìš©ì(USER) ê¶Œí•œë§Œ ê°€ì§„ ì‚¬ìš©ìë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤.

íšŒì› ì •ë³´ ìˆ˜ì • ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” MemberControllerì˜ patchMember() í•¸ë“¤ëŸ¬ ë©”ì„œë“œì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œ ë¶€ì—¬ ì„¤ì •ì´ë¼ëŠ” ì‚¬ì‹¤ì„ ê¸°ì–µí•˜ì„¸ìš”.

.antMatchers(HttpMethod.PATCH, "/*/members/**")ì—ì„œ â€˜**â€™ëŠ” í•˜ìœ„ URLë¡œ ì–´ë–¤ URLì´ ì˜¤ë”ë¼ë„ ë§¤ì¹˜ê°€ ëœë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.


ëª¨ë“  íšŒì› ì •ë³´ì˜ ëª©ë¡ì€ (3)ê³¼ ê°™ì´ ê´€ë¦¬ì(ADMIN) ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ì—¬ì•¼ í•  ê²ƒì…ë‹ˆë‹¤.

íšŒì› ì •ë³´ ëª©ë¡ ì¡°íšŒ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” MemberControllerì˜ getMembers() í•¸ë“¤ëŸ¬ ë©”ì„œë“œì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œ ë¶€ì—¬ ì„¤ì •ì— í•´ë‹¹í•©ë‹ˆë‹¤.


íŠ¹ì • íšŒì›ì— ëŒ€í•œ ì •ë³´ ì¡°íšŒëŠ” (4)ì™€ ê°™ì´ ì¼ë°˜ ì‚¬ìš©ì(USER)ì™€ ê´€ë¦¬ì(ADMIN) ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ì ëª¨ë‘ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë©´ ë  ê²ƒ ê°™êµ°ìš”.

íŠ¹ì • íšŒì› ì •ë³´ ì¡°íšŒ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” MemberControllerì˜ getMember() í•¸ë“¤ëŸ¬ ë©”ì„œë“œì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œ ë¶€ì—¬ ì„¤ì •ì— í•´ë‹¹í•©ë‹ˆë‹¤.


íŠ¹ì • íšŒì›ì„ ì‚­ì œí•˜ëŠ” ìš”ì²­ì€ (5)ì™€ ê°™ì´ í•´ë‹¹ ì‚¬ìš©ìê°€ íƒˆí‡´ ê°™ì€ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆì–´ì•¼ í•˜ë¯€ë¡œ ì¼ë°˜ ì‚¬ìš©ì(USER) ê¶Œí•œë§Œ ê°€ì§„ ì‚¬ìš©ìë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤.

íŠ¹ì • íšŒì› ì •ë³´ ì‚­ì œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” MemberControllerì˜ deleteMember() í•¸ë“¤ëŸ¬ ë©”ì„œë“œì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œ ë¶€ì—¬ ì„¤ì •ì— í•´ë‹¹í•©ë‹ˆë‹¤.


âœ… ì…€í”„ ë¯¸ë‹ˆ ì‹¤ìŠµ

ì½”ë“œ 4-87ì—ì„œëŠ” MemberControllerë¥¼ í†µí•´ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë¦¬ì†ŒìŠ¤ì— ëŒ€í•´ ì ‘ê·¼ ê¶Œí•œë§Œ ë¶€ì—¬ëœ ì±„ë¡œ ë‚˜ë¨¸ì§€ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ìš”ì²­ì€ ëª¨ë“œ ì ‘ê·¼ì´ ê°€ëŠ¥í•œ ìƒíƒœì…ë‹ˆë‹¤.

ê·¸ëŸ°ë° ìš°ë¦¬ê°€ ì§€ê¸ˆê» êµ¬í˜„í•œ ì»¤í”¼ ì£¼ë¬¸ ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ëŠ” ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ê°€ ë” ìˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ì—¬ëŸ¬ë¶„ë“¤ë„ ì•Œê³  ìˆì„ ê±°ë¼ ìƒê°í•©ë‹ˆë‹¤. ^^

CoffeeControllerì™€ OrderControllerë¥¼ í†µí•´ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì€ ì—¬ëŸ¬ë¶„ë“¤ì´ ì§ì ‘ í•œë²ˆ ì¶”ê°€í•´ ë³¼ ìˆ˜ ìˆë„ë¡ ì…€í”„ ë¯¸ë‹ˆ ì‹¤ìŠµìœ¼ë¡œ ë‚¨ê²¨ ë‘ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ^^



JWT ê²€ì¦ í…ŒìŠ¤íŠ¸
ì´ì œ JWTë¥¼ ì‚¬ìš©í•œ ìê²© ê²€ì¦ì´ ì •ìƒì ìœ¼ë¡œ ì˜ ì´ë£¨ì–´ì§€ëŠ”ì§€ ê°„ë‹¨í•˜ê²Œ í…ŒìŠ¤íŠ¸í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í›„, ì•„ë˜ì™€ ê°™ì€ ì¡°ê±´ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•´ ë³´ê² ìŠµë‹ˆë‹¤.


1ï¸âƒ£ JWTë¥¼ Authorization headerì— í¬í•¨í•˜ì§€ ì•Šì„ ê²½ìš°


[ê·¸ë¦¼ 4-24] JWTë¥¼ Authorization headerì— í¬í•¨í•˜ì§€ ì•Šì€ ê²½ìš°


[ê·¸ë¦¼ 4-24]ëŠ” JWTë¥¼ Authorization headerì— í¬í•¨í•˜ì§€ ì•Šì€ ì±„ MemberControllerì˜ getMember() í•¸ë“¤ëŸ¬ ë©”ì„œë“œì— requestë¥¼ ì „ì†¡í•œ ëª¨ìŠµì…ë‹ˆë‹¤.


response ê²°ê³¼ë¥¼ ë³´ë©´ Spring Securityì—ì„œ 403 statusë¥¼ ì „ë‹¬í•œ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

JWTê°€ Authorization headerì— í¬í•¨ë˜ì§€ ì•Šìœ¼ë©´ JwtVerificationFilterë¥¼ ê±´ë„ˆë›°ê²Œ ë˜ê³ , ë‚˜ë¨¸ì§€ Security Filterì—ì„œ ê¶Œí•œ ì²´í¬ë¥¼ í•˜ë©´ì„œ ì ì ˆí•œ ê¶Œí•œì´ ë¶€ì—¬ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— 403 statusê°€ ì „ë‹¬ë©ë‹ˆë‹¤.



2ï¸âƒ£ ìœ íš¨í•˜ì§€ ì•Šì€ JWTë¥¼ Authorization headerì— í¬í•¨í•  ê²½ìš°


[ê·¸ë¦¼ 4-25] ìœ íš¨í•˜ì§€ ì•Šì€ JWTë¥¼ Authorization headerì— í¬í•¨í•  ê²½ìš°


ì´ë²ˆì—ëŠ” [ê·¸ë¦¼ 4-25]ì™€ ê°™ì´ ìœ íš¨í•˜ì§€ ì•Šì€ JWTë¥¼ Authorization headerì— í¬í•¨í•˜ì—¬ MemberControllerì˜ getMember() í•¸ë“¤ëŸ¬ ë©”ì„œë“œì— requestë¥¼ ì „ì†¡í•œ ëª¨ìŠµì…ë‹ˆë‹¤.


ì—­ì‹œ Spring Securityì—ì„œ 403 statusë¥¼ ì „ë‹¬í•œ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


ìœ íš¨í•˜ì§€ ì•Šì€ JWTì˜ ê²½ìš° ì ‘ê·¼ ê¶Œí•œì— ëŒ€í•œ ì—ëŸ¬ë¥¼ ë‚˜íƒ€ë‚´ëŠ” 403 statusë³´ë‹¤ëŠ” JWTì˜ ê²€ì¦ì— ì‹¤íŒ¨í–ˆê¸° ë•Œë¬¸ì— ìê²© ì¦ëª…ì— ì‹¤íŒ¨í•œ ê²ƒê³¼ ê°™ìœ¼ë¯€ë¡œ UNAUTHORIZEDë¥¼ ì˜ë¯¸í•˜ëŠ” 401 statusê°€ ë” ì ì ˆí•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

ì´ ë¶€ë¶„ì€ ì´ì–´ì§€ëŠ” ì˜ˆì™¸ ì²˜ë¦¬ ë¶€ë¶„ì—ì„œ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.



3ï¸âƒ£ ê¶Œí•œì´ ë¶€ì—¬ë˜ì§€ ì•Šì€ ë¦¬ì†ŒìŠ¤ì— requestë¥¼ ì „ì†¡í•  ê²½ìš°


[ê·¸ë¦¼ 4-26] ê¶Œí•œì´ ë¶€ì—¬ë˜ì§€ ì•Šì€ ë¦¬ì†ŒìŠ¤ì— requestë¥¼ ì „ì†¡í•  ê²½ìš°


[ê·¸ë¦¼ 4-26]ì—ì„œëŠ” USER ê¶Œí•œë§Œ ë¶€ì—¬ëœ ì‚¬ìš©ìì˜ JWTë¥¼ Authorization headerì— ì¶”ê°€í•˜ê³ , ADMIN ê¶Œí•œì—ë§Œ ì ‘ê·¼ì´ í—ˆìš©ëœ MemberControllerì˜ getMembers() í•¸ë“¤ëŸ¬ ë©”ì„œë“œì— requestë¥¼ ì „ì†¡í•  ë•Œì˜ ê²°ê³¼ì…ë‹ˆë‹¤.


JwtVerificationFilterì—ì„œ JWTì˜ ìê²© ì¦ëª…ì€ ì •ìƒì ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆì§€ë§Œ ADMIN ê¶Œí•œì´ ì—†ëŠ” ì‚¬ìš©ìì´ë¯€ë¡œ 403 statusê°€ ì „ë‹¬ë©ë‹ˆë‹¤.



ì˜ˆì™¸ ì²˜ë¦¬
ì, ì´ì œ JWTë¥¼ ì‚¬ìš©í•˜ëŠ” ìê²© ê²€ì¦ì— ëŒ€í•œ êµ¬í˜„ì€ ëë‚œ ê±¸ê¹Œìš”? ^^

ì´ ìƒíƒœì—ì„œ ë§ˆë¬´ë¦¬í•˜ë”ë¼ë„ ë³´ì•ˆì ìœ¼ë¡œ í¬ê²Œ ë¬¸ì œ ë  ê±´ ì—†ìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ì¡°ê¸ˆ ë” ê¹”ë”í•œ ë§ˆë¬´ë¦¬ë¥¼ ìœ„í•´ì„œ ì˜ˆì™¸ ì²˜ë¦¬ì™€ ê´€ë ¨ëœ ë¡œì§ì„ ì¶”ê°€í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.



1ï¸âƒ£ JwtVerificationFilterì— ì˜ˆì™¸ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
JwtVerificationFilterì˜ ê²½ìš°, í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ì „ë‹¬ë°›ì€ JWTì˜ Claimsë¥¼ ì–»ëŠ” ê³¼ì •ì—ì„œ ë‚´ë¶€ì ìœ¼ë¡œ JWTì— ëŒ€í•œ ì„œëª…(Signature)ì„ ê²€ì¦í•©ë‹ˆë‹¤.

ê·¸ëŸ°ë° í˜„ì¬ JwtVerificationFilterì—ì„œëŠ” JWTì— ëŒ€í•œ ì„œëª…(Signature) ê²€ì¦ì— ì‹¤íŒ¨í•  ê²½ìš° throwë˜ëŠ” SignatureExceptionì— ëŒ€í•´ì„œ ì–´ë–¤ ì²˜ë¦¬ë„ í•˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  JWTê°€ ë§Œë£Œë  ê²½ìš°, ë°œìƒí•˜ëŠ” ExpiredJwtExceptionì— ëŒ€í•œ ì²˜ë¦¬ë„ ì´ë£¨ì–´ì§€ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.


JWT ê²€ì¦ ê³¼ì •ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” Exceptionì„ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ì˜ˆì™¸ ì²˜ë¦¬ ë¡œì§ì„ JwtVerificationFilterì— ì¶”ê°€í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

```java
package com.codestates.auth.filter;

import com.codestates.auth.jwt.JwtTokenizer;
import com.codestates.auth.utils.CustomAuthorityUtils;
import io.jsonwebtoken.ExpiredJwtException;
import io.jsonwebtoken.security.SignatureException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.filter.OncePerRequestFilter;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;
import java.util.Map;

public class JwtVerificationFilter extends OncePerRequestFilter {
    ...
    ...

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        // (1)
        try {
            Map<String, Object> claims = verifyJws(request);
            setAuthenticationToContext(claims);
        } catch (SignatureException se) {
            request.setAttribute("exception", se);
        } catch (ExpiredJwtException ee) {
            request.setAttribute("exception", ee);
        } catch (Exception e) {
            request.setAttribute("exception", e);
        }

        filterChain.doFilter(request, response);
    }
    
    ...
    ...
}
```
[ì½”ë“œ 4-88] ì˜ˆì™¸ ì²˜ë¦¬ ë¡œì§ì´ ì¶”ê°€ëœ JwtVerificationFilter


ì½”ë“œ 4-88ì—ì„œëŠ” JwtVerificationFilterì˜ doFilterInternal() ë©”ì„œë“œì— ì˜ˆì™¸ ì²˜ë¦¬ ë¡œì§ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.


ì˜ˆì™¸ ì²˜ë¦¬ ë¡œì§ì€ ê°„ë‹¨í•©ë‹ˆë‹¤.

(1)ê³¼ ê°™ì´ try~catch ë¬¸ìœ¼ë¡œ íŠ¹ì • ì˜ˆì™¸ íƒ€ì…ì˜ Exceptionì´ catch ë˜ë©´ í•´ë‹¹ Exceptionì„ request.setAttribute("exception", Exception ê°ì²´)ì™€ ê°™ì´ HttpServletRequestì˜ ì• íŠ¸ë¦¬ë·°íŠ¸(Attribute)ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.


ì´ë ‡ê²Œ ì¶”ê°€ëœ ì• íŠ¸ë¦¬ë·°íŠ¸ëŠ” ë°”ë¡œ ì•„ë˜ì—ì„œ ì„¤ëª…í•˜ëŠ” AuthenticationEntryPointì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ğŸ’¡JwtVerificationFilter ì˜ˆì™¸ ì²˜ë¦¬ì˜ í‚¤í¬ì¸íŠ¸ëŠ” ìš°ë¦¬ê°€ ì¼ë°˜ì ìœ¼ë¡œ ì•Œê³  ìˆëŠ” ì˜ˆì™¸ ì²˜ë¦¬ ë°©ì‹ê³¼ëŠ” ë‹¤ë¥´ê²Œ Exceptionì„ catchí•œ í›„ì— Exceptionì„ ë‹¤ì‹œ throw í•œë‹¤ë“ ì§€ í•˜ëŠ” ì²˜ë¦¬ë¥¼ í•˜ì§€ ì•Šê³ , ë‹¨ìˆœíˆ request.setAttribute()ë¥¼ ì„¤ì •í•˜ëŠ” ì¼ë°–ì— í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.


ì´ëŸ° ì‹ìœ¼ë¡œ ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ í•˜ê²Œ ë˜ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”?

ì˜ˆì™¸ê°€ ë°œìƒí•˜ê²Œ ë˜ë©´ SecurityContextì— í´ë¼ì´ì–¸íŠ¸ì˜ ì¸ì¦ ì •ë³´(Authentication ê°ì²´)ê°€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.


â­ SecurityContextì— í´ë¼ì´ì–¸íŠ¸ì˜ ì¸ì¦ ì •ë³´(Authentication ê°ì²´)ê°€ ì €ì¥ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ë‹¤ìŒ(next) Security Filter ë¡œì§ì„ ìˆ˜í–‰í•˜ë‹¤ ë³´ë©´ ê²°êµ­ì—ëŠ” Filter ë‚´ë¶€ì—ì„œ AuthenticationExceptionì´ ë°œìƒí•˜ê²Œ ë˜ê³ , ì´ AuthenticationExceptionì€ ë°”ë¡œ ì•„ë˜ì—ì„œ ì„¤ëª…í•˜ëŠ” AuthenticationEntryPointê°€ ì²˜ë¦¬í•˜ê²Œ ë©ë‹ˆë‹¤.


â­ SecurityContextì— í´ë¼ì´ì–¸íŠ¸ì˜ ì¸ì¦ ì •ë³´ê°€ ì±„ì›Œì§€ì§€ ì•Šì€ ìƒíƒœì—ì„œ Security Filter ë¡œì§ì„ ìˆ˜í–‰í•˜ê²Œ ë˜ë©´ Security Filter ì²´ì¸ì˜ Filter ë‚´ë¶€ì—ì„œ AuthenticationExceptionì´ ë°œìƒí•œë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¼­ ê¸°ì–µí•˜ì„¸ìš”!



2ï¸âƒ£ AuthenticationEntryPoint êµ¬í˜„
AuthenticationEntryPointëŠ” SignatureException, ExpiredJwtException ë“± Exception ë°œìƒìœ¼ë¡œ ì¸í•´ SecurityContextì— Authenticationì´ ì €ì¥ë˜ì§€ ì•Šì„ ê²½ìš° ë“± AuthenticationExceptionì´ ë°œìƒí•  ë•Œ í˜¸ì¶œë˜ëŠ” í•¸ë“¤ëŸ¬ ê°™ì€ ì—­í• ì„ í•©ë‹ˆë‹¤.


MemberAuthenticationEntryPoint

```java
package com.codestates.auth.handler;

import com.codestates.auth.utils.ErrorResponder;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.stereotype.Component;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@Slf4j
@Component
public class MemberAuthenticationEntryPoint implements AuthenticationEntryPoint {
    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException {
        Exception exception = (Exception) request.getAttribute("exception");
        ErrorResponder.sendErrorResponse(response, HttpStatus.UNAUTHORIZED);

        logExceptionMessage(authException, exception);
    }

    private void logExceptionMessage(AuthenticationException authException, Exception exception) {
        String message = exception != null ? exception.getMessage() : authException.getMessage();
        log.warn("Unauthorized error happened: {}", message);
    }
}
```
[ì½”ë“œ 4-89] AuthenticationEntryPointë¥¼ êµ¬í˜„í•œ MemberAuthenticationEntryPoint


ì½”ë“œ 4-89ëŠ” AuthenticationEntryPointë¥¼ êµ¬í˜„í•œ MemberAuthenticationEntryPointì…ë‹ˆë‹¤.


MemberAuthenticationEntryPoint í´ë˜ìŠ¤ëŠ” ì¸ì¦ ê³¼ì •ì—ì„œ AuthenticationException ì´ ë°œìƒí•  ê²½ìš° í˜¸ì¶œë˜ë©°, ì²˜ë¦¬í•˜ê³ ì í•˜ëŠ” ë¡œì§ì„ commence() ë©”ì„œë“œì— êµ¬í˜„í•˜ë©´ ë©ë‹ˆë‹¤.

ì½”ë“œ 4-89ì—ì„œëŠ” ì¸ì¦ ê³¼ì •ì—ì„œ AuthenticationException ë°œìƒí•˜ë©´ ErrorResponseë¥¼ ìƒì„±í•´ì„œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡í•©ë‹ˆë‹¤.


ErrorResponder

```java
package com.codestates.auth.utils;

import com.codestates.response.ErrorResponse;
import com.google.gson.Gson;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;

import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class ErrorResponder {
    public static void sendErrorResponse(HttpServletResponse response, HttpStatus status) throws IOException {
        Gson gson = new Gson();
        ErrorResponse errorResponse = ErrorResponse.of(status);
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        response.setStatus(status.value());
        response.getWriter().write(gson.toJson(errorResponse, ErrorResponse.class));
    }
}
```
[ì½”ë“œ 4-90] ErrorResponseë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡í•˜ê¸° ìœ„í•œ ErrorResponder í´ë˜ìŠ¤


ErrorResponder í´ë˜ìŠ¤ëŠ” ErrorResponseë¥¼ ì¶œë ¥ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.



3ï¸âƒ£ AccessDeniedHandler êµ¬í˜„
AccessDeniedHandlerëŠ” ì¸ì¦ì—ëŠ” ì„±ê³µí–ˆì§€ë§Œ í•´ë‹¹ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìœ¼ë©´ í˜¸ì¶œë˜ëŠ” í•¸ë“¤ëŸ¬ì…ë‹ˆë‹¤.

```java
package com.codestates.auth.handler;

import com.codestates.auth.utils.ErrorResponder;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.web.access.AccessDeniedHandler;
import org.springframework.stereotype.Component;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@Slf4j
@Component
public class MemberAccessDeniedHandler implements AccessDeniedHandler {
    @Override
    public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException) throws IOException, ServletException {
        ErrorResponder.sendErrorResponse(response, HttpStatus.FORBIDDEN);
        log.warn("Forbidden error happened: {}", accessDeniedException.getMessage());
    }
}
```
[ì½”ë“œ 4-91] AccessDeniedHandlerë¥¼ êµ¬í˜„í•œ MemberAccessDeniedHandler


ì½”ë“œ 4-91ì€ AccessDeniedHandlerë¥¼ êµ¬í˜„í•œ MemberAccessDeniedHandlerì…ë‹ˆë‹¤.

MemberAccessDeniedHandlerí´ë˜ìŠ¤ëŠ” ìš”ì²­í•œ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•´ ì ì ˆí•œ ê¶Œí•œì´ ì—†ìœ¼ë©´ í˜¸ì¶œë˜ëŠ” í•¸ë“¤ëŸ¬ë¡œì„œ, ì²˜ë¦¬í•˜ê³ ì í•˜ëŠ” ë¡œì§ì„ handle() ë©”ì„œë“œì— êµ¬í˜„í•˜ë©´ ë©ë‹ˆë‹¤.

ì½”ë“œ 4-91ì—ì„œëŠ” ì ì ˆí•œ ê¶Œí•œì¸ì§€ í™•ì¸í•˜ëŠ” ê³¼ì •ì—ì„œ AccessDeniedExceptionì´ ë°œìƒí•˜ë©´ ErrorResponseë¥¼ ìƒì„±í•´ì„œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡í•©ë‹ˆë‹¤.



4ï¸âƒ£ SecurityConfigurationì— AuthenticationEntryPoint ë° AccessDeniedHandler ì¶”ê°€
ì•ì—ì„œ êµ¬í˜„í•œ MemberAuthenticationEntryPointì™€ MemberAccessDeniedHandlerë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ SecurityConfigurationì— ì¶”ê°€í•´ ë³´ê² ìŠµë‹ˆë‹¤.



SecurityConfiguration(V6)

```java
package com.codestates.config;

import com.codestates.auth.filter.JwtAuthenticationFilter;
import com.codestates.auth.filter.JwtVerificationFilter;
import com.codestates.auth.handler.MemberAccessDeniedHandler;
import com.codestates.auth.handler.MemberAuthenticationEntryPoint;
import com.codestates.auth.handler.MemberAuthenticationFailureHandler;
import com.codestates.auth.handler.MemberAuthenticationSuccessHandler;
import com.codestates.auth.jwt.JwtTokenizer;
import com.codestates.auth.utils.CustomAuthorityUtils;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.factory.PasswordEncoderFactories;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;

import static org.springframework.security.config.Customizer.withDefaults;

/**
 * authenticationEntryPointì™€ accessDeniedHandler ì¶”ê°€
 */
@Configuration
public class SecurityConfiguration {
   ...
   ...

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .headers().frameOptions().sameOrigin()
            .and()
            .csrf().disable()
            .cors(withDefaults())
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            .formLogin().disable()
            .httpBasic().disable()
            .exceptionHandling()
            .authenticationEntryPoint(new MemberAuthenticationEntryPoint())  // (1) ì¶”ê°€
            .accessDeniedHandler(new MemberAccessDeniedHandler())            // (2) ì¶”ê°€
            .and()
            .apply(new CustomFilterConfigurer())
            .and()
            .authorizeHttpRequests(authorize -> authorize
                    .antMatchers(HttpMethod.POST, "/*/members").permitAll()
                    .antMatchers(HttpMethod.PATCH, "/*/members/**").hasRole("USER")
                    .antMatchers(HttpMethod.GET, "/*/members").hasRole("ADMIN")
                    .antMatchers(HttpMethod.GET, "/*/members/**").hasAnyRole("USER", "ADMIN")
                    .antMatchers(HttpMethod.DELETE, "/*/members/**").hasRole("USER")
                    .anyRequest().permitAll()
            );
        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
    }

    @Bean
    CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("*"));
        configuration.setAllowedMethods(Arrays.asList("GET","POST", "PATCH", "DELETE"));
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("\/**", configuration);         // ì£¼ì˜ ì‚¬í•­: ì½˜í…ì¸  í‘œì‹œ ì˜¤ë¥˜ë¡œ ì¸í•´ '/**'ë¥¼ '\/**'ë¡œ í‘œê¸°í–ˆìœ¼ë‹ˆ ì‹¤ì œ ì½”ë“œ êµ¬í˜„ ì‹œì—ëŠ” '\(ì—­ìŠ¬ë˜ì‹œ)'ë¥¼ ë¹¼ ì£¼ì„¸ìš”.
        return source;
    }

    public class CustomFilterConfigurer extends AbstractHttpConfigurer<CustomFilterConfigurer, HttpSecurity> {
        @Override
        public void configure(HttpSecurity builder) throws Exception {
            AuthenticationManager authenticationManager = builder.getSharedObject(AuthenticationManager.class);

            JwtAuthenticationFilter jwtAuthenticationFilter = new JwtAuthenticationFilter(authenticationManager, jwtTokenizer);
            jwtAuthenticationFilter.setFilterProcessesUrl("/v11/auth/login");
            jwtAuthenticationFilter.setAuthenticationSuccessHandler(new MemberAuthenticationSuccessHandler());
            jwtAuthenticationFilter.setAuthenticationFailureHandler(new MemberAuthenticationFailureHandler());

            JwtVerificationFilter jwtVerificationFilter = new JwtVerificationFilter(jwtTokenizer, authorityUtils);

            builder
                .addFilter(jwtAuthenticationFilter)
                .addFilterAfter(jwtVerificationFilter, JwtAuthenticationFilter.class);
        }
    }
}
```
[ì½”ë“œ 4-92] AuthenticationEntryPoint ë° AccessDeniedHandler ì¶”ê°€í•œ SecurityConfiguration


ì½”ë“œ 4-92ì˜ SecurityConfigurationì—ì„œëŠ” (1), (2)ì™€ ê°™ì´ MemberAuthenticationEntryPointì™€ MemberAccessDeniedHandlerê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.


ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•œ í›„, ìœ íš¨í•˜ì§€ ì•Šì€ JWT ë˜ëŠ” ë§Œë£Œëœ JWTë¥¼ Authorization headerì— ì¶”ê°€í•´ì„œ requestë¥¼ ì „ì†¡í•˜ë©´ ì•„ë˜ì˜ [ê·¸ë¦¼ 4-27]ê³¼ ê°™ì€ responseë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.



[ê·¸ë¦¼ 4-27] AuthenticationEntryPointì—ì„œ ì „ì†¡ëœ Error response


ë˜í•œ, ê¶Œí•œì´ ì—†ëŠ” ë¦¬ì†ŒìŠ¤ì— request ì „ì†¡ ì‹œ, ì•„ë˜ì˜ [ê·¸ë¦¼ 4-28]ê³¼ ê°™ì€ responseë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.



[ê·¸ë¦¼ 4-28] AccessDeniedHandlerì—ì„œ ì „ì†¡ëœ Error response


ë“œë””ì–´ JWTì— ëŒ€í•œ ê¸°ëŠ¥ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‘ğŸ‘

JWTëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ê°„ë‹¨í•˜ê²Œ ì ìš©í•  ìˆ˜ ìˆì§€ë§Œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆì— ìˆì–´ êµ‰ì¥íˆ ì¤‘ìš”í•œ ì—­í• ì„ í•©ë‹ˆë‹¤.


ë”°ë¼ì„œ ì´ë²ˆ ì‹œê°„ì— ì—¬ëŸ¬ë¶„ë“¤ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ì— JWTë¥¼ ì§ì ‘ ì ìš©í•´ ë´„ìœ¼ë¡œì¨ ê°€ê¹Œìš´ ë¯¸ë˜ì— ìˆì„ ì—¬ëŸ¬ë¶„ë“¤ì˜ í”„ë¡œì íŠ¸ ë˜ëŠ” ì‹¤ë¬´ì— JWTë¥¼ ì§ì ‘ ì‘ìš©í•˜ëŠ” ë° ë„ì›€ì´ ë˜ê¸¸ ë°”ëë‹ˆë‹¤.


ë§Œì•½ ì‹¤ë¬´ì—ì„œ Username/Password ê¸°ë°˜ ë¡œê·¸ì¸ ì¸ì¦ê³¼ JWT ìê²© ì¦ëª…ì— ëŒ€í•œ ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆë‹¤ë©´ ì—¬ëŸ¬ë¶„ë“¤ì´ í•´ì•¼ í•  ì‘ì—…ì´ í•˜ë‚˜ ë” ìˆìŠµë‹ˆë‹¤.

ë°”ë¡œ Spring Rest Docsë¥¼ ì´ìš©í•´ API ë¬¸ì„œë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
Spring Securityë¥¼ í†µí•´ ë³´ì•ˆì´ ì ìš©ëœ ìƒíƒœì—ì„œ API ë¬¸ì„œë¥¼ ì—…ë°ì´íŠ¸í• ì§€ëŠ” ì—¬ëŸ¬ë¶„ë“¤ì˜ ëª«ìœ¼ë¡œ ë‚¨ê²¨ë‘ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ^^



í•µì‹¬ í¬ì¸íŠ¸
JWTëŠ” JWS(JSON Web Token Signed)ë¼ê³ ë„ ë¶ˆë¦°ë‹¤.

SecurityContextì— Authenticationì„ ì €ì¥í•˜ê²Œ ë˜ë©´ Spring Securityì˜ ì„¸ì…˜ ì •ì±…(Session Policy)ì— ë”°ë¼ì„œ ì„¸ì…˜ì„ ìƒì„±í•  ìˆ˜ë„ ìˆê³ , ê·¸ë ‡ì§€ ì•Šì„ ìˆ˜ë„ ìˆë‹¤.

SecurityContextì— í´ë¼ì´ì–¸íŠ¸ì˜ ì¸ì¦ ì •ë³´(Authentication ê°ì²´)ê°€ ì €ì¥ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ë‹¤ìŒ(next) Security Filter ë¡œì§ì„ ìˆ˜í–‰í•˜ë‹¤ ë³´ë©´ ê²°êµ­ì—ëŠ” AuthenticationExceptionì´ ë°œìƒí•˜ê²Œ ë˜ê³ , ì´ AuthenticationExceptionì€ AuthenticationEntryPointê°€ ì²˜ë¦¬í•˜ê²Œ ëœë‹¤.

AccessDeniedHandlerëŠ” ì¸ì¦ì—ëŠ” ì„±ê³µí–ˆì§€ë§Œ í•´ë‹¹ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìœ¼ë©´ í˜¸ì¶œë˜ëŠ” í•¸ë“¤ëŸ¬ì´ë‹¤.



ì‹¬í™” í•™ìŠµ
AuthenticationEntryPointì— ëŒ€í•´ì„œ ë” ì•Œì•„ë³´ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ë§í¬ë¥¼ ì°¸ê³ í•´ ì£¼ì„¸ìš”.

https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/AuthenticationEntryPoint.html
AccessDeniedHandlerì— ëŒ€í•´ì„œ ë” ì•Œì•„ë³´ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ë§í¬ë¥¼ ì°¸ê³ í•´ ì£¼ì„¸ìš”.

https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/access/AccessDeniedHandler.html



