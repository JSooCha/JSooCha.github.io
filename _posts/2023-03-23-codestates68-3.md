---
title: OAuth 2ì™€ JWTë¥¼ ì´ìš©í•œ ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬í˜„
excerpt: Spring Securityì—ì„œì˜ OAuth2 ì¸ì¦
categories: Spring
tags: [codestates, Spring]
toc: true
toc_sticky: true
author_profile: true
sidebar_main: true
published : true
---

OAuth 2ì™€ JWTë¥¼ ì´ìš©í•œ ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬í˜„
ì—¬ëŸ¬ë¶„ë“¤ì´ ì´ì „ ì±•í„°ì—ì„œ êµ¬í˜„í•´ ë³¸ Hello, OAuth 2 ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ Googleì˜ OAuth 2 ì¸ì¦ ì‹œìŠ¤í…œì„ ì´ìš©í•´ ì‚¬ìš©ìì˜ ì¸ì¦ì„ ì²˜ë¦¬í•œ í›„, ë³´í˜¸ëœ HTML í˜ì´ì§€ë¥¼ ì œê³µí•˜ëŠ” SSR(Server Side Rendering) ë°©ì‹ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ì—ˆìŠµë‹ˆë‹¤.


ì´ë²ˆ ì‹œê°„ì—ëŠ” Frontendì™€ Backendê°€ ë¶„ë¦¬ëœ CSR(Client Side Rendering) ë°©ì‹ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— Googleì˜ OAuth 2 ì¸ì¦ ì‹œìŠ¤í…œì„ ì ìš©í•´ ë³´ê² ìŠµë‹ˆë‹¤.


ìš°ë¦¬ê°€ OAuth 2ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , Frontend ì¸¡ì—ì„œ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì§ì ‘ ë¡œê·¸ì¸ ì¸ì¦ ìš”ì²­ì„ ì „ì†¡í•˜ëŠ” ê²½ìš°ë¥¼ ìƒê°í•´ ë³´ì„¸ìš”.


Frontend ì¸¡ì—ì„œ ì „ì†¡í•œ ë¡œê·¸ì¸ ì¸ì¦ ìš”ì²­ì´ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰ë˜ë©´ ì¸ì¦ì— ì„±ê³µí–ˆìŒì„ ì¦ëª…í•  ìˆ˜ ìˆëŠ” ìê²© ì¦ëª… ì •ë³´ì¸ JWTë¥¼ Frontend ì¸¡ì— ì œê³µí–ˆë˜ ê²ƒ ê¸°ì–µ ë‚ ê±°ë¼ ìƒê°í•©ë‹ˆë‹¤.


CSR(Client Side Rendering) ë°©ì‹ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— OAuth 2 ì¸ì¦ ì‹œìŠ¤í…œì„ ë„ì…í•  ê²½ìš°ì—ë„ ë§ˆì°¬ê°€ì§€ë¡œ OAuth 2 ì¸ì¦ ì‹œìŠ¤í…œì„ í†µí•´ ì¸ì¦ì— ì„±ê³µí•œ ì‚¬ìš©ìì— ëŒ€í•œ ìê²© ì¦ëª… ì •ë³´ë¥¼ JWTë¡œ ì œê³µí•´ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


í•œë§ˆë””ë¡œ OAuth 2ì™€ JWTì˜ ì½œë¼ë³´ë ˆì´ì…˜ì¸ ì…ˆì…ë‹ˆë‹¤. ^^


CSR(Client Side Rendering) ë°©ì‹ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— OAuth 2 + JWTë¥¼ ì œëŒ€ë¡œ ì˜ ì ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ë¨¼ì € OAuth 2ì˜ ì¸ì¦ ì²˜ë¦¬ íë¦„ê³¼ JWTë¥¼ í†µí•œ ìê²© ì¦ëª… ì •ë³´ ì œê³µ ì‹œì ì— ëŒ€í•´ ì´í•´í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.



Frontendì™€ Backend ê°„ì˜ OAuth 2 ì¸ì¦ ì²˜ë¦¬ íë¦„


[ê·¸ë¦¼ 4-40] Frontendì™€ Backend ê°„ì˜ OAuth 2 ì¸ì¦ ì²˜ë¦¬ íë¦„


[ê·¸ë¦¼ 4-40]ì€ Frontendì™€ Backend ê°„ì˜ OAuth 2 ì¸ì¦ ì²˜ë¦¬ íë¦„ì…ë‹ˆë‹¤. ê·¸ë¦¼ì— ëŒ€í•œ ì„¤ëª…ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.


(1) Resource Ownerê°€ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ â€˜Google ë¡œê·¸ì¸ ë§í¬â€™ë¥¼ í´ë¦­í•©ë‹ˆë‹¤.


(2) Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ http://localhost:8080/oauth2/authorization/googleë¡œ requestë¥¼ ì „ì†¡í•©ë‹ˆë‹¤. ì´ URIì˜ requestëŠ” OAuth2LoginAuthenticationFilter ê°€ ì²˜ë¦¬í•©ë‹ˆë‹¤.


(3) Googleì˜ ë¡œê·¸ì¸ í™”ë©´ì„ ìš”ì²­í•˜ëŠ” URIë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•©ë‹ˆë‹¤. ì´ë•Œ Authorization Serverê°€ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ ìª½ìœ¼ë¡œ Authorization Codeë¥¼ ì „ì†¡í•  Redirect URI(http://localhost:8080/login/oauth2/code/google)ë¥¼ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤. Redirect URIëŠ” Spring Securityê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤.


(4) Google ë¡œê·¸ì¸ í™”ë©´ì„ ì˜¤í”ˆí•©ë‹ˆë‹¤.


(5) Resource Ownerê°€ Google ë¡œê·¸ì¸ ì¸ì¦ ì •ë³´ë¥¼ ì…ë ¥í•´ì„œ ë¡œê·¸ì¸ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.


(6) ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ (3)ì—ì„œ ì „ë‹¬í•œ Backend Redirect URI(http://localhost:8080/login/oauth2/code/google)ë¡œ Authorization Codeë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.


(7) Authorization Serverê°€ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì—ê²Œ Authorization Codeë¥¼ ì‘ë‹µìœ¼ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.


(8) Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì´ Authorization Serverì— Access Tokenì„ ìš”ì²­í•©ë‹ˆë‹¤.


(9) Authorization Serverê°€ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì—ê²Œ Access Tokenì„ ì‘ë‹µìœ¼ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.

ì—¬ê¸°ì—ì„œ Access Tokenì€ Google Resource Serverì—ê²Œ Resourceë¥¼ ìš”ì²­í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.


(10) Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì´ Resource Serverì— User Infoë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.

ì—¬ê¸°ì„œì˜ User InfoëŠ” Resource Ownerì— ëŒ€í•œ ì´ë©”ì¼ ì£¼ì†Œ, í”„ë¡œí•„ ì •ë³´ ë“±ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.


(11) Resource Serverê°€ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì— User Infoë¥¼ ì‘ë‹µìœ¼ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.


(12) Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì€ JWTë¡œ êµ¬ì„±ëœ Access Tokenê³¼ Refresh Tokenì„ ìƒì„±í•œ í›„, Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ì— JWT(Access Tokenê³¼ Refresh Token)ë¥¼ ì „ë‹¬í•˜ê¸° ìœ„í•´ Frontend ì• í”Œë¦¬ì¼€ì´ì…˜(http://localhost?access_token={jwt-access-token}&refresh_token={jwt-refresh-token})ìœ¼ë¡œ Redirectí•©ë‹ˆë‹¤.


â­ ë™ì‘ íë¦„ì´ ì•„ì£¼ ë³µì¡í•´ ë³´ì´ì§€ë§Œ (6)ë¶€í„° (11)ê¹Œì§€ëŠ” Spring Securityì—ì„œ ë‚´ë¶€ì ìœ¼ë¡œ ì•Œì•„ì„œ ì²˜ë¦¬í•´ ì£¼ê¸° ë•Œë¬¸ì— ê¸°ë³¸ì ìœ¼ë¡œëŠ” ìš°ë¦¬ê°€ ê±´ë“œë¦´ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.


Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ ê°„ì˜ OAuth 2 ì¸ì¦ ì²˜ë¦¬ íë¦„ì„ ì´í•´í–ˆë‹¤ë©´ ì´ì œ êµ¬í˜„í•´ ë³¼ ì°¨ë¡€ì…ë‹ˆë‹¤.


ê·¸ëŸ°ë° OAuth 2 ì¸ì¦ ì²˜ë¦¬ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ì„œëŠ” ì›¹ì„œë²„ì—ì„œ ì‹¤ì œë¡œ ì‹¤í–‰ë˜ëŠ” Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ì´ í•„ìš”í•©ë‹ˆë‹¤.


Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì‹¤í–‰ í™˜ê²½ì„ ë¨¼ì € ì¤€ë¹„í•´ ë´…ì‹œë‹¤.



Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤€ë¹„
1ï¸âƒ£ ì•„íŒŒì¹˜ ì›¹ì„œë²„ ì„¤ì¹˜ - Windows OS ì‚¬ìš©ì
Windows OS ì‚¬ìš©ìëŠ” ì•„ë˜ì˜ ìˆœì„œëŒ€ë¡œ Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í™˜ê²½ì„ ì¤€ë¹„í•©ë‹ˆë‹¤

ì•„ë˜ì˜ ë§í¬ì—ì„œ ì•„íŒŒì¹˜ ì›¹ì„œë²„ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.

https://www.apachelounge.com/download/
ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ì˜ ì••ì¶•ì„ í•´ì œí•©ë‹ˆë‹¤.

ì•„ë˜ì™€ ê°™ì´ Apache24 ë””ë ‰í† ë¦¬ë¥¼ C:\ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•©ë‹ˆë‹¤. ìµœì¢… ê²½ë¡œëŠ” C:\Apache24ê°€ ë©ë‹ˆë‹¤.




ì•„ë˜ì™€ ê°™ì´ httpd.conf íŒŒì¼ì„ ë©”ëª¨ì¥ ë“±ì˜ ì—ë””í„°ë¡œ ì˜¤í”ˆí•©ë‹ˆë‹¤.



ServerNameì„ ì£¼ì„ í•´ì œí•˜ê³  ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•©ë‹ˆë‹¤.

ServerName localhost:80

ë‚˜ë¨¸ì§€ëŠ” ë””í´íŠ¸ ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.


Ctrlê³¼ Alt í‚¤ ì‚¬ì´ì— ìˆëŠ” ìœˆë„ìš° í‚¤ + Së¥¼ ëˆ„ë¥¸ í›„, cmdë¡œ ê²€ìƒ‰í•´ì„œ ë§ˆìš°ìŠ¤ ì˜¤ë¥¸ìª½ ë²„íŠ¼ì„ ëˆŒëŸ¬ ëª…ë ¹ í”„ë¡¬í”„íŠ¸(cmd) ì°½ì„ ê´€ë¦¬ì ëª¨ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.

ì•„ë˜ì™€ ê°™ì´ C:\Apache24\bin ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•©ë‹ˆë‹¤.



ì•„ë˜ì™€ ê°™ì´ httpd.exe -k install ëª…ë ¹ì„ ì…ë ¥í•©ë‹ˆë‹¤.



ì•„ë˜ì™€ ê°™ì´ ApacheMonitor.exeë¥¼ ë”ë¸” í´ë¦­í•´ì„œ ì•„íŒŒì¹˜ ì›¹ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ì•„íŒŒì¹˜ ì›¹ì„œë²„ëŠ” ë°”íƒ•í™”ë©´ ì˜¤ë¥¸ìª½ í•˜ë‹¨ì˜ ë¹ ë¥¸ ì‹¤í–‰ ì°½ì—ì„œ ì‹¤í–‰/ì¤‘ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.






ì›¹ë¸Œë¼ìš°ì €ì—ì„œ http://localhostë¡œ ì ‘ì†í–ˆì„ ë•Œ ì•„ë˜ì™€ ê°™ì€ í™”ë©´ì´ ëœ¨ë©´ ì•„íŒŒì¹˜ ì›¹ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ì´ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤.





1ï¸âƒ£ ì•„íŒŒì¹˜ ì›¹ì„œë²„ ì„¤ì¹˜ - Mac OS ì‚¬ìš©ì
Mac OSëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì‹œìŠ¤í…œì— ì•„íŒŒì¹˜ê°€ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìµœì‹  ë²„ì „ì˜ Mac OSê°€ ì•„ë‹ ê²½ìš°ëŠ” homebrewë¥¼ ì´ìš©í•´ ë³„ë„ ì„¤ì¹˜ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•„ë˜ì˜ ìˆœì„œëŒ€ë¡œ Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í™˜ê²½ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.

ì‹œìŠ¤í…œì— ì„¤ì¹˜ë˜ì–´ ìˆëŠ” ì•„íŒŒì¹˜ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì„¤ì¹˜ í™•ì¸ì´ ë˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë‹¤ìŒ ë§í¬ë¥¼ ì°¸ê³ í•˜ì—¬ ì•„íŒŒì¹˜ ì›¹ ì„œë²„ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.

https://www.javatpoint.com/how-to-install-apache-on-mac
```
$ apachectl -v
```

ì•„íŒŒì¹˜ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

ì•„íŒŒì¹˜ë¥¼ ì‹¤í–‰í•  ë• ë°˜ë“œì‹œ sudoë¥¼ ë¶™ì—¬ì•¼ í•©ë‹ˆë‹¤.

ì‹¤í–‰ ì¤‘ì¸ ì•„íŒŒì¹˜ë¥¼ ì¢…ë£Œí•  ë• sudo apachectl stop ëª…ë ¹ì–´ë¡œ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```
$ sudo apachectl start
```
ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ http://localhostë¡œ ì ‘ì†í–ˆì„ ë•Œ ì•„ë˜ì™€ ê°™ì€ í™”ë©´ì´ ëœ¨ë©´ ì•„íŒŒì¹˜ ì›¹ ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.



2ï¸âƒ£ Frontend ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì•„íŒŒì¹˜ ì›¹ì„œë²„ì— ë°°í¬
ì•„ë˜ì˜ ì„¸ ê°œ HTML íŒŒì¼ì„ ì—ë””í„°ë¡œ ì‘ì„±í•œ í›„, ê° ìš´ì˜ì²´ì œì— ë§ëŠ” ê²½ë¡œì˜ ë””ë ‰í† ë¦¬ë¡œ ìœ„ì¹˜ì‹œí‚µë‹ˆë‹¤.


Windows OS ì‚¬ìš©ì : C:\Apache24\htdocs

Mac OS ì‚¬ìš©ì : /Library/WebServer/Documents

í˜„ì¬ ìœ„ì¹˜ì˜ í•˜ìœ„ ë””ë ‰í† ë¦¬ê°€ ì•„ë‹Œ ë£¨íŠ¸(/)ì˜ í•˜ìœ„ ê²½ë¡œì…ë‹ˆë‹¤.

í•´ë‹¹ ìœ„ì¹˜ì—ì„œ íŒŒì¼ì„ ì§ì ‘ ìƒì„±í•  ë• ë°˜ë“œì‹œ sudo ëª…ë ¹ì–´ë¥¼ ë¶™ì—¬ì•¼ í•©ë‹ˆë‹¤.

ë‹¤ë¥¸ ê²½ë¡œì—ì„œ í•´ë‹¹ ìœ„ì¹˜ë¡œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ì„ ì´ìš©í•´ ì´ë™í•  ë• ì•”í˜¸ì™€ í•¨ê»˜ í—ˆìš© ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ë©”ì‹œì§€ê°€ ëœ° ìˆ˜ ìˆìŠµë‹ˆë‹¤.

index.html

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OAuth2 + JWT Frontend</title>
</head>
<body>
    <h2>Welcome to OAuth 2.0 + JWT Spring Security</h2>
    <a href="http://localhost:8080/oauth2/authorization/google">Googleë¡œ ë¡œê·¸ì¸</a>
</body>
</html>
```
index.htmlì—ì„œ [Googleë¡œ ë¡œê·¸ì¸] ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ requestê°€ ì „ì†¡ë˜ê³ , Goolge ë¡œê·¸ì¸ í™”ë©´ì´ ì˜¤í”ˆë©ë‹ˆë‹¤.



receive-token.html

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OAuth2 + JWT My page</title>
</head>
<body>
    <script type="text/javascript">
        let accessToken = (new URL(location.href)).searchParams.get('access_token');
        let refreshToken = (new URL(location.href)).searchParams.get('refresh_token');

        localStorage.setItem("accessToken", accessToken)
        localStorage.setItem("refreshToken", refreshToken)

        location.href = 'my-page.html'
    </script>
</body>
</html>
```
receive-token.html ì€ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì „ë‹¬ë°›ì€ JWT Access Tokenê³¼ Refresh Tokenì„ ì›¹ë¸Œë¼ìš°ì €ì˜ LocalStorageì— ì €ì¥í•œ í›„, my-page.html ì´ë™í•©ë‹ˆë‹¤.



my-page.html

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OAuth2 + JWT My page</title>
</head>
<body>
    <h2>My Page</h2>
    <h3>ì•„ë˜ì˜ í† í°ì„ ì´ìš©í•´ì„œ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</h3>
    <p>
        <span>Access Token: </span><span id="accessToken" style="color: blue"></span>
    </p>
    <p>
        <span>Refresh Token: </span><span id="refreshToken" style="color: blue"></span>
    </p>
    <script type="text/javascript">
        let accessToken = localStorage.getItem('accessToken')
        let refreshToken = localStorage.getItem('refreshToken');

        document.getElementById("accessToken").textContent = accessToken;
        document.getElementById("refreshToken").textContent = refreshToken;
    </script>
</body>
</html>
```
my-page.htmlì—ì„œëŠ” LocalStorageì— ì €ì¥ëœ JWT Access Tokenê³¼ Refresh Tokenì„ ë¡œë“œí•´ì„œ ì›¹ ë¸Œë¼ìš°ì €ì— í‘œì‹œí•©ë‹ˆë‹¤.


ì´ì œ Frontend ìª½ì€ ì¤€ë¹„ê°€ ëë‚¬ìŠµë‹ˆë‹¤.



Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì— OAuth 2 ì¸ì¦ ê¸°ëŠ¥ ì ìš©
1ï¸âƒ£ JwtTokenizer ì¶”ê°€
ì œì¼ ë¨¼ì € í•  ì¼ì€ JWTë¥¼ ìƒì„±í•˜ê³  JWTë¥¼ ê²€ì¦í•´ ì£¼ëŠ” JwtTokenizerë¥¼ êµ¬í˜„í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. JwtTokenizerëŠ” ìš°ë¦¬ê°€ JWT ìœ ë‹›ì—ì„œ ì´ë¯¸ êµ¬í˜„í•œ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.


JwtTokenizer

```java
package com.codestates.oauth2_jwt.jwt;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jws;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.io.Decoders;
import io.jsonwebtoken.io.Encoders;
import io.jsonwebtoken.security.Keys;
import lombok.Getter;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import java.nio.charset.StandardCharsets;
import java.security.Key;
import java.util.Calendar;
import java.util.Date;
import java.util.Map;

@Component
public class JwtTokenizer {
    @Getter
    @Value("${jwt.key.secret}")
    private String secretKey;

    @Getter
    @Value("${jwt.access-token-expiration-minutes}")
    private int accessTokenExpirationMinutes;

    @Getter
    @Value("${jwt.refresh-token-expiration-minutes}")
    private int refreshTokenExpirationMinutes;

    public String encodeBase64SecretKey(String secretKey) {
        return Encoders.BASE64.encode(secretKey.getBytes(StandardCharsets.UTF_8));
    }

    public String generateAccessToken(Map<String, Object> claims,
                                      String subject,
                                      Date expiration,
                                      String base64EncodedSecretKey) {
        Key key = getKeyFromBase64EncodedKey(base64EncodedSecretKey);

        return Jwts.builder()
                .setClaims(claims)
                .setSubject(subject)
                .setIssuedAt(Calendar.getInstance().getTime())
                .setExpiration(expiration)
                .signWith(key)
                .compact();
    }

    public String generateRefreshToken(String subject, Date expiration, String base64EncodedSecretKey) {
        Key key = getKeyFromBase64EncodedKey(base64EncodedSecretKey);

        return Jwts.builder()
                .setSubject(subject)
                .setIssuedAt(Calendar.getInstance().getTime())
                .setExpiration(expiration)
                .signWith(key)
                .compact();
    }

    // ê²€ì¦ í›„, Claimsì„ ë°˜í™˜í•˜ëŠ” ìš©ë„
    public Jws<Claims> getClaims(String jws, String base64EncodedSecretKey) {
        Key key = getKeyFromBase64EncodedKey(base64EncodedSecretKey);

        Jws<Claims> claims = Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(jws);
        return claims;
    }

    // ë‹¨ìˆœíˆ ê²€ì¦ë§Œ í•˜ëŠ” ìš©ë„ë¡œ ì“°ì¼ ê²½ìš°
    public void verifySignature(String jws, String base64EncodedSecretKey) {
        Key key = getKeyFromBase64EncodedKey(base64EncodedSecretKey);

        Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(jws);
    }

    public Date getTokenExpiration(int expirationMinutes) {
        Calendar calendar = Calendar.getInstance();
        calendar.add(Calendar.MINUTE, expirationMinutes);
        Date expiration = calendar.getTime();

        return expiration;
    }

    private Key getKeyFromBase64EncodedKey(String base64EncodedSecretKey) {
        byte[] keyBytes = Decoders.BASE64.decode(base64EncodedSecretKey);
        Key key = Keys.hmacShaKeyFor(keyBytes);

        return key;
    }
}
```
[ì½”ë“œ 4-104] JwtTokenizer ì½”ë“œ


ì½”ë“œ 4-104ëŠ” JwtTokenizer ì½”ë“œì´ë©°, JWT ìœ ë‹›ì˜ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ì½”ë“œì— ëŒ€í•œ ë³„ë„ì˜ ì„¤ëª…ì€ ìƒëµí•˜ê² ìŠµë‹ˆë‹¤.



2ï¸âƒ£ application.yml ì„¤ì •
```yml
spring:
  h2:
    console:
      enabled: true
      path: /h2
  datasource:
    url: jdbc:h2:mem:test
  jpa:
    hibernate:
      ddl-auto: create  # (1) ìŠ¤í‚¤ë§ˆ ìë™ ìƒì„±
    show-sql: true      # (2) SQL ì¿¼ë¦¬ ì¶œë ¥
    properties:
      hibernate:
        format_sql: true  # (3) SQL pretty print
  sql:
    init:
      data-locations: classpath*:db/h2/data.sql
  security:
    oauth2:
      client:
        registration:
          google:
            clientId: ${G_CLIENT_ID}
            clientSecret: ${G_CLIENT_SECRET}
            scope:
              - email                              // (1)
              - profile                            // (2)
logging:
  level:
    org:
      springframework:
        orm:
          jpa: DEBUG
server:
  servlet:
    encoding:
      force-response: true
mail:
  address:
    admin: admin@gmail.com
jwt:
  key:
    secret: ${JWT_SECRET_KEY}               # ë¯¼ê°í•œ ì •ë³´ëŠ” ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ì—ì„œ ë¡œë“œí•œë‹¤.
  access-token-expiration-minutes: 30
  refresh-token-expiration-minutes: 420
```
[ì½”ë“œ 4-105] application.yml


ì½”ë“œ 4-105ëŠ” application.yml íŒŒì¼ì˜ ì½”ë“œì…ë‹ˆë‹¤.

ìš°ë¦¬ê°€ JWTì™€ OAuth2ë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— JWTì™€ OAuth2ì˜ ì„¤ì •ì´ í•©ì³ì§„ ëª¨ìŠµì…ë‹ˆë‹¤.

(1), (2)ì™€ ê°™ì´ scope ê°’ì„ ì§ì ‘ ì§€ì •í•˜ë©´ í•´ë‹¹ ë²”ìœ„ë§Œí¼ì˜ Resourceë¥¼ Client(ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜)ì— ì œê³µí•©ë‹ˆë‹¤.

(1)ì€ Resource Ownerì˜ ì´ë©”ì¼ ì •ë³´ë¥¼ ì˜ë¯¸í•˜ê³ , (2)ëŠ” Resource Ownerì˜ í”„ë¡œí•„ ì •ë³´ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.



3ï¸âƒ£ JwtVerificationFilter ì¶”ê°€
JwtVerificationFilterëŠ” OAuth 2 ì¸ì¦ì— ì„±ê³µí•˜ë©´ Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ ìª½ì—ì„œ requestë¥¼ ì „ì†¡í•  ë•Œë§ˆë‹¤ Authorization headerì— ì‹¤ì–´ ë³´ë‚´ëŠ” Access Tokenì— ëŒ€í•œ ê²€ì¦ì„ ìˆ˜í–‰í•˜ëŠ” Filterì…ë‹ˆë‹¤.

JWT ìœ ë‹›ì—ì„œ í•™ìŠµí•œ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë¯€ë¡œ [JWTë¥¼ ì´ìš©í•œ ìê²© ì¦ëª… ë° ê²€ì¦ êµ¬í˜„] ì±•í„°ë¥¼ ì°¸ê³ í•´ ì£¼ì„¸ìš”.



4ï¸âƒ£ AuthenticationSuccessHandler êµ¬í˜„
AuthenticationSuccessHandlerëŠ” OAuth 2 ì¸ì¦ì— ì„±ê³µí•˜ë©´ í˜¸ì¶œë˜ëŠ” í•¸ë“¤ëŸ¬ì…ë‹ˆë‹¤.

ì—¬ê¸°ì—ì„œ JWTë¥¼ ìƒì„±í•˜ê³ , Frontend ìª½ìœ¼ë¡œ JWTë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•´ Redirect í•˜ëŠ” ë¡œì§ì„ êµ¬í˜„í•˜ë©´ ë©ë‹ˆë‹¤.


AuthenticationSuccessHandler

```java
package com.codestates.oauth2_jwt.auth.handler;

import com.codestates.member.entity.Member;
import com.codestates.member.service.MemberService;
import com.codestates.oauth2_jwt.jwt.JwtTokenizer;
import com.codestates.oauth2_jwt.utils.CustomAuthorityUtils;
import com.codestates.stamp.Stamp;
import org.springframework.security.core.Authentication;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.security.web.authentication.SimpleUrlAuthenticationSuccessHandler;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.util.UriComponentsBuilder;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.net.URI;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class OAuth2MemberSuccessHandler extends SimpleUrlAuthenticationSuccessHandler {   // (1)
    private final JwtTokenizer jwtTokenizer;
    private final CustomAuthorityUtils authorityUtils;
    private final MemberService memberService;

    // (2)
    public OAuth2MemberSuccessHandler(JwtTokenizer jwtTokenizer,
                                      CustomAuthorityUtils authorityUtils,
                                      MemberService memberService) {
        this.jwtTokenizer = jwtTokenizer;
        this.authorityUtils = authorityUtils;
        this.memberService = memberService;
    }

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
        var oAuth2User = (OAuth2User)authentication.getPrincipal();
        String email = String.valueOf(oAuth2User.getAttributes().get("email")); // (3)
        List<String> authorities = authorityUtils.createRoles(email);           // (4)

        saveMember(email);  // (5)
        redirect(request, response, email, authorities);  // (6)
    }

    private void saveMember(String email) {
        Member member = new Member(email);
        member.setStamp(new Stamp());
        memberService.createMember(member);
    }

    private void redirect(HttpServletRequest request, HttpServletResponse response, String username, List<String> authorities) throws IOException {
        String accessToken = delegateAccessToken(username, authorities);  // (6-1)
        String refreshToken = delegateRefreshToken(username);     // (6-2)

        String uri = createURI(accessToken, refreshToken).toString();   // (6-3)
        getRedirectStrategy().sendRedirect(request, response, uri);   // (6-4)
    }

    private String delegateAccessToken(String username, List<String> authorities) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("username", username);
        claims.put("roles", authorities);

        String subject = username;
        Date expiration = jwtTokenizer.getTokenExpiration(jwtTokenizer.getAccessTokenExpirationMinutes());

        String base64EncodedSecretKey = jwtTokenizer.encodeBase64SecretKey(jwtTokenizer.getSecretKey());

        String accessToken = jwtTokenizer.generateAccessToken(claims, subject, expiration, base64EncodedSecretKey);

        return accessToken;
    }

    private String delegateRefreshToken(String username) {
        String subject = username;
        Date expiration = jwtTokenizer.getTokenExpiration(jwtTokenizer.getRefreshTokenExpirationMinutes());
        String base64EncodedSecretKey = jwtTokenizer.encodeBase64SecretKey(jwtTokenizer.getSecretKey());

        String refreshToken = jwtTokenizer.generateRefreshToken(subject, expiration, base64EncodedSecretKey);

        return refreshToken;
    }

    private URI createURI(String accessToken, String refreshToken) {
        MultiValueMap<String, String> queryParams = new LinkedMultiValueMap<>();
        queryParams.add("access_token", accessToken);
        queryParams.add("refresh_token", refreshToken);

        return UriComponentsBuilder
                .newInstance()
                .scheme("http")
                .host("localhost")
//                .port(80)
                .path("/receive-token.html")
                .queryParams(queryParams)
                .build()
                .toUri();
    }

}
```
[ì½”ë“œ 4-106] OAuth2MemberSuccessHandler


ì½”ë“œ 4-106ì€ OAuth2 ì¸ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰ë˜ë©´ í˜¸ì¶œë˜ëŠ” í•¸ë“¤ëŸ¬ì¸ OAuth2MemberSuccessHandler ì½”ë“œì…ë‹ˆë‹¤.

â­ OAuth2MemberSuccessHandler í´ë˜ìŠ¤ëŠ” OAuth 2 ì¸ì¦ í›„, Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ ìª½ìœ¼ë¡œ JWTë¥¼ ì „ì†¡í•˜ëŠ” í•µì‹¬ ì—­í• ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.


ì½”ë“œ ì„¤ëª…ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

(1)ê³¼ ê°™ì´ SimpleUrlAuthenticationSuccessHandlerë¥¼ ìƒì†í•˜ë©´ Redirectë¥¼ ì†ì‰½ê²Œ í•  ìˆ˜ ìˆëŠ” getRedirectStrategy().sendRedirect() ê°™ì€ APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

(2)ì™€ ê°™ì´ í•„ìš”í•œ ê°ì²´ë¥¼ DI ë°›ìŠµë‹ˆë‹¤.

DIëŠ” ì •ë§ ì—¬ëŸ¬ë¶„ë“¤ì—ê²Œ ì§€ê²¹ë„ë¡ ì–¸ê¸‰í•˜ëŠ” ë‚´ìš©ì´ê¸° ë•Œë¬¸ì— ì´ì œëŠ” ëª¨ë¥¸ë‹¤ê³  ì–˜ê¸°í•˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤. ^^;


(3)ì—ì„œëŠ” Authentication ê°ì²´ë¡œë¶€í„° ì–»ì–´ë‚¸ OAuth2User ê°ì²´ë¡œë¶€í„° Resource Ownerì˜ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì–»ê³  ìˆìŠµë‹ˆë‹¤.

(4)ì—ì„œëŠ” CustomAuthorityUtilsë¥¼ ì´ìš©í•´ ê¶Œí•œ ì •ë³´ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤. CustomAuthorityUtilsì˜ ì½”ë“œëŠ” JWTì—ì„œ ì‚¬ìš©í•œ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë¯€ë¡œ ë ˆí¼ëŸ°ìŠ¤ ì½”ë“œë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

(5)ì—ì„œëŠ” Resource Ownerì˜ ì´ë©”ì¼ ì£¼ì†Œë¥¼ DBì— ì €ì¥í•©ë‹ˆë‹¤. OAuth 2ì˜ íŠ¹ì„±ìƒ Resource Ownerì˜ í¬ë¦¬ë´ì…œ(Credential)ì„ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê´€ë¦¬í•˜ì§€ëŠ” ì•Šì§€ë§Œ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ Resource(ì»¤í”¼ ì •ë³´, ì£¼ë¬¸ ì •ë³´)ì™€ ì—°ê´€ ê´€ê³„ë¥¼ ë§ºê¸° ìœ„í•´ì„œ ìµœì†Œí•œì˜ ì •ë³´ëŠ” Backend ì• í”Œë¦¬ì¼€ì´ì…˜ ìª½ì—ì„œ ê´€ë¦¬í•´ë„ ë¬´ë°©í•©ë‹ˆë‹¤.

(6)ì—ì„œëŠ” Access Tokenê³¼ Refresh Tokenì„ ìƒì„±í•´ì„œ Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì „ë‹¬í•˜ê¸° ìœ„í•´ Redirectí•©ë‹ˆë‹¤.

(6-1)ê³¼ (6-2)ì—ì„œëŠ” JWT Access Tokenê³¼ Refresh Tokenì„ ìƒì„±í•©ë‹ˆë‹¤. JWT ìœ ë‹›ì—ì„œ ì´ë¯¸ ì´ìš©í•œ ì½”ë“œì™€ ë™ì¼í•œ ì½”ë“œì…ë‹ˆë‹¤.

(6-3)ì—ì„œëŠ” Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ ìª½ì˜ URLì„ ìƒì„±í•©ë‹ˆë‹¤. createURI() ë©”ì„œë“œì—ì„œ UriComponentsBuilderë¥¼ ì´ìš©í•´ Access Tokenê³¼ Refresh Tokenì„ í¬í•¨í•œ URLì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ğŸ’¡ UriComponentsBuilderì—ì„œ Port ì„¤ì •ì„ í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ì€ 80 í¬íŠ¸ë€ ê±¸ ê¸°ì–µí•˜ì„¸ìš”.

(6-4)ì—ì„œëŠ” SimpleUrlAuthenticationSuccessHandlerì—ì„œ ì œê³µí•˜ëŠ” sendRedirect() ë©”ì„œë“œë¥¼ ì´ìš©í•´ Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ ìª½ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•©ë‹ˆë‹¤.



SecurityConfigiguration ì„¤ì •
SecurityConfigurationì˜ ì½”ë“œê°€ ê¸¸ì–´ ë³´ì´ì§€ë§Œ ì‚¬ì‹¤ìƒ ì—¬ëŸ¬ë¶„ë“¤ì´ ì´ë¯¸ ì´ ì „ ìœ ë‹›ì—ì„œ ëª¨ë‘ í•™ìŠµí•œ ë‚´ìš©ì´ë¼ëŠ” ì‚¬ì‹¤ì„ ê¸°ì–µí•˜ê¸° ë°”ëë‹ˆë‹¤.


SecurityConfiguration(V2)

```java
package com.codestates.oauth2_jwt.config;

import com.codestates.member.service.MemberService;
import com.codestates.oauth2_jwt.auth.filter.JwtVerificationFilter;
import com.codestates.oauth2_jwt.auth.handler.MemberAccessDeniedHandler;
import com.codestates.oauth2_jwt.auth.handler.MemberAuthenticationEntryPoint;
import com.codestates.oauth2_jwt.jwt.JwtTokenizer;
import com.codestates.oauth2_jwt.auth.handler.OAuth2MemberSuccessHandler;
import com.codestates.oauth2_jwt.utils.CustomAuthorityUtils;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;

import static org.springframework.security.config.Customizer.withDefaults;

@Configuration
public class SecurityConfiguration {
    private final JwtTokenizer jwtTokenizer;
    private final CustomAuthorityUtils authorityUtils;
    private final MemberService memberService;

    public SecurityConfiguration(JwtTokenizer jwtTokenizer,
                                   CustomAuthorityUtils authorityUtils,
                                   MemberService memberService) {
        this.jwtTokenizer = jwtTokenizer;
        this.authorityUtils = authorityUtils;
        this.memberService = memberService;
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .headers().frameOptions().sameOrigin()
            .and()
            .csrf().disable()
            .cors(withDefaults())
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            .formLogin().disable()
            .httpBasic().disable()
            .exceptionHandling()  // ì¶”ê°€
            .authenticationEntryPoint(new MemberAuthenticationEntryPoint())  // ì¶”ê°€
            .accessDeniedHandler(new MemberAccessDeniedHandler())            // ì¶”ê°€
            .and()
            .apply(new CustomFilterConfigurer())  // ì¶”ê°€
            .and()
                .authorizeHttpRequests(authorize -> authorize // url authorization ì „ì²´ ì¶”ê°€
//                        .antMatchers(HttpMethod.POST, "/*/members").permitAll()    // OAuth 2ë¡œ ë¡œê·¸ì¸í•˜ë¯€ë¡œ íšŒì› ì •ë³´ ë“±ë¡ í•„ìš” ì—†ìŒ.
//                        .antMatchers(HttpMethod.PATCH, "/*/members/**").hasRole("USER") // OAuth 2ë¡œ ë¡œê·¸ì¸í•˜ë¯€ë¡œ íšŒì› ì •ë³´ ìˆ˜ì • í•„ìš” ì—†ìŒ.
//                        .antMatchers(HttpMethod.GET, "/*/members").hasRole("ADMIN")  // OAuth 2ë¡œ ë¡œê·¸ì¸í•˜ë¯€ë¡œ íšŒì› ì •ë³´ ìˆ˜ì • í•„ìš” ì—†ìŒ.
//                        .antMatchers(HttpMethod.GET, "/*/members/**").hasAnyRole("USER", "ADMIN")  // OAuth 2ë¡œ ë¡œê·¸ì¸í•˜ë¯€ë¡œ íšŒì› ì •ë³´ ìˆ˜ì • í•„ìš” ì—†ìŒ.
//                        .antMatchers(HttpMethod.DELETE, "/*/members/**").hasRole("USER") // OAuth 2ë¡œ ë¡œê·¸ì¸í•˜ë¯€ë¡œ íšŒì› ì •ë³´ ìˆ˜ì • í•„ìš” ì—†ìŒ.
                        .antMatchers(HttpMethod.POST, "/*/coffees").hasRole("ADMIN")
                        .antMatchers(HttpMethod.PATCH, "/*/coffees/**").hasRole("ADMIN")
                        .antMatchers(HttpMethod.GET, "/*/coffees/**").hasAnyRole("USER", "ADMIN")
                        .antMatchers(HttpMethod.GET, "/*/coffees").permitAll()
                        .antMatchers(HttpMethod.DELETE, "/*/coffees").hasRole("ADMIN")
                        .antMatchers(HttpMethod.POST, "/*/orders").hasRole("USER")
                        .antMatchers(HttpMethod.PATCH, "/*/orders").hasAnyRole("USER", "ADMIN")
                        .antMatchers(HttpMethod.GET, "/*/orders/**").hasAnyRole("USER", "ADMIN")
                        .antMatchers(HttpMethod.DELETE, "/*/orders").hasRole("USER")
                        .anyRequest().permitAll()
            )
            .oauth2Login(oauth2 -> oauth2
                    .successHandler(new OAuth2MemberSuccessHandler(jwtTokenizer, authorityUtils, memberService))  // (1)
            );

        return http.build();
    }

    @Bean
    CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("*"));
        configuration.setAllowedMethods(Arrays.asList("GET","POST", "PATCH", "DELETE"));
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("\/**", configuration); // ì£¼ì˜ ì‚¬í•­: ì»¨í…ì¸  í‘œì‹œ ì˜¤ë¥˜ë¡œ ì¸í•´ '/**'ë¥¼ '\/**'ë¡œ í‘œê¸°í–ˆìœ¼ë‹ˆ ì‹¤ì œ ì½”ë“œ êµ¬í˜„ ì‹œì—ëŠ” '\(ì—­ìŠ¬ë˜ì‹œ)'ë¥¼ ë¹¼ ì£¼ì„¸ìš”.

        return source;
    }
    
    // ì¶”ê°€
    public class CustomFilterConfigurer extends AbstractHttpConfigurer<CustomFilterConfigurer, HttpSecurity> {
        @Override
        public void configure(HttpSecurity builder) throws Exception {
            JwtVerificationFilter jwtVerificationFilter = new JwtVerificationFilter(jwtTokenizer, authorityUtils);
            
            builder.addFilterAfter(jwtVerificationFilter, OAuth2LoginAuthenticationFilter.class); // (2)
        }
    }
}
```
[ì½”ë“œ 4-107] SecurityConfiguration


ì½”ë“œ 4-107ì—ì„œ // ì¶”ê°€ë¼ê³  í‘œì‹œëœ ì½”ë“œë“¤ì€ ì—¬ëŸ¬ë¶„ë“¤ì´ ê¸°ì–µ ì†ì—ì„œ ë– ì˜¤ë¥´ì§€ ì•Šì„ì§€ë„ ëª¨ë¥´ì§€ë§Œ JWT ìœ ë‹›ì—ì„œ ëª¨ë‘ ì„¤ëª…í•œ ì½”ë“œì…ë‹ˆë‹¤. ^^


ì•„ì§ ì–¸ê¸‰í•˜ì§€ ì•Šì€ ì½”ë“œì— ëŒ€í•´ì„œë§Œ ê°„ë‹¨íˆ ì„¤ëª…í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

(1)ì—ì„œëŠ” OAuth 2 ë¡œê·¸ì¸ ì„¤ì •ì— .successHandler()ë¥¼ í†µí•´ OAuth 2 ì¸ì¦ì´ ì„±ê³µí•œ ë’¤ ì‹¤í–‰ë˜ëŠ” í•¸ë“¤ëŸ¬ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. OAuth2MemberSuccessHandler ê°ì²´ë¥¼ ìƒì„±í•˜ë©´ì„œ OAuth2MemberSuccessHandlerì—ì„œ í•„ìš”í•œ ì˜ì¡´ ê°ì²´ë¥¼ DI í•˜ê³  ìˆëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

(2)ì™€ ê°™ì´ JwtVerificationFilterë¥¼ OAuth2LoginAuthenticationFilter ë’¤ì— ì¶”ê°€í•©ë‹ˆë‹¤.


OAuth 2 ì¸ì¦ì„ ì‚¬ìš©í•˜ë¯€ë¡œ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ ìª½ì—ì„œëŠ” MemberControllerë¥¼ ì‚¬ìš©í•  ì¼ì´ í˜„ì¬ë¡œì„œëŠ” ì—†ìœ¼ë¯€ë¡œ MemberControllerì˜ í•¸ë“¤ëŸ¬ ë©”ì„œë“œ ìª½ URIì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì€ ì£¼ì„ ì²˜ë¦¬ë¥¼ í–ˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¸°ì–µí•˜ì„¸ìš”.



5ï¸âƒ£ ê¸°íƒ€ ìˆ˜ì •ëœ ì½”ë“œ
ê¸°íƒ€ ìˆ˜ì •ëœ ì½”ë“œëŠ” íšŒì› ì •ë³´ì™€ ê´€ë ¨ëœ ì½”ë“œì…ë‹ˆë‹¤.

ì œì‚¼ìì¸ ì¨ë“œ íŒŒí‹° ì• í”Œë¦¬ì¼€ì´ì…˜(Google ì„œë¹„ìŠ¤)ì˜ OAuth 2 ì¸ì¦ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— íšŒì› ì •ë³´ë¥¼ ë“±ë¡í•˜ê±°ë‚˜ ìˆ˜ì •í•  í•„ìš”ê°€ ì—†ìœ¼ë¯€ë¡œ ì´ì™€ ê´€ë ¨ëœ MemberController, MemberDto, MemberService, Member ì—”í‹°í‹° í´ë˜ìŠ¤ì—ì„œ íšŒì› ì •ë³´ë¥¼ ë“±ë¡ ë° ìˆ˜ì •í•˜ëŠ” ë¡œì§ì˜ ëŒ€ë¶€ë¶„ì´ ì œê±°ë˜ê±°ë‚˜ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.


ìˆ˜ì •ëœ ë¶€ë¶„ì— ëŒ€í•´ì„œ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´ ë ˆí¼ëŸ°ìŠ¤ ì½”ë“œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.



ì• í”Œë¦¬ì¼€ì´ì…˜ í…ŒìŠ¤íŠ¸
ì´ì œ êµ¬í˜„ì€ ë§ˆë¬´ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.

Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì„ IDEì—ì„œ ì‹¤í–‰í•˜ê³ , Frontend ìª½ ì•„íŒŒì¹˜ ì›¹ì„œë²„ê°€ ì‹¤í–‰ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•œ í›„, ì›¹ ë¸Œë¼ìš°ì €ì— http://localhostë¥¼ ì…ë ¥í•´ì„œ Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ í™”ë©´ì„ ì˜¤í”ˆí•©ë‹ˆë‹¤.



[ê·¸ë¦¼ 4-41] Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ í™”ë©´


[ê·¸ë¦¼ 4-41]ì€ Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë©”ì¸ í˜ì´ì§€ì…ë‹ˆë‹¤.

ì•„ì£¼ ì•„ì£¼ ì‹¬í”Œí•œ í™”ë©´ì´ì§€ë§Œ í™”ë©´ì˜ ë””ìì¸ë³´ë‹¤ OAuth 2 ì¸ì¦ê³¼ JWT êµ¬í˜„ ë¡œì§ì´ ì˜ ë™ì‘í•˜ëŠ”ì§€ê°€ ì¤‘ìš”í•˜ë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¸°ì–µí•˜ë©´ì„œ [Googleë¡œ ë¡œê·¸ì¸] ë²„íŠ¼ì„ í´ë¦­í•´ ë³´ì„¸ìš”.


êµ¬ê¸€ ë¡œê·¸ì¸ ì¸ì¦ í™”ë©´ì´ í‘œì‹œë˜ê³ , ë¡œê·¸ì¸ ì¸ì¦ì— ì„±ê³µí•˜ë©´ ì•„ë˜ì˜ [ê·¸ë¦¼ 4-42]ì™€ ê°™ì´ JWTì˜ Access Tokenê³¼ Refresh Tokenì´ í‘œì‹œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.



[ê·¸ë¦¼ 4-42] JWT Access Tokenê³¼ Refresh Tokenì´ í™”ë©´ì— í‘œì‹œëœ ëª¨ìŠµ


[ê·¸ë¦¼ 4-42]ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆëŠ” JWT Access Tokenì€ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ Resourceë¥¼ ìš”ì²­í•˜ëŠ” CoffeeControllerì™€ OrderControllerì˜ í•¸ë“¤ëŸ¬ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ë•Œ Authorization headerì— ì¶”ê°€í•´ì„œ ì‚¬ìš©í•˜ë©°, Refresh Tokenì€ Access Tokenì´ ë§Œë£Œë˜ì—ˆì„ ë•Œ, Access Tokenì„ ìƒˆë¡œ ë°œê¸‰ë°›ê³ ì í•  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


ì´ Access Tokenê³¼ Refresh Tokenì„ ì–¼ë§ˆë‚˜ ì•ˆì „í•˜ê²Œ ì˜ ë³´ê´€í•˜ê³  ì‚¬ìš©í•˜ëŠ”ì§€ëŠ” ì´ì œ ì „ì ìœ¼ë¡œ Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì±…ì„ ì˜ì—­ì…ë‹ˆë‹¤.


Backend ê°œë°œìê°€ ë  ì—¬ëŸ¬ë¶„ì€ ì—¬ê¸°ê¹Œì§€ë§Œ êµ¬í˜„í•˜ê³  FrontendëŠ” ë” ì´ìƒ ì‹ ê²½ ì“°ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤. ^^


ìš°ë¦¬ê°€ ì§€ê¸ˆê» í•™ìŠµí•œ OAuth 2 ì¸ì¦ ë°©ì‹ì€ Googleì˜ OAuth 2 ì¸ì¦ ì‹œìŠ¤í…œì„ ì´ìš©í•œ ë°©ì‹ì´ì—ˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ Googleê³¼ ê°™ì€ OAuth 2 ì¸ì¦ ì‹œìŠ¤í…œì„ ìì²´ì ìœ¼ë¡œ êµ¬ì¶•í•˜ê¸° ìœ„í•´ Authorization Serverì™€ Resource Serverë¥¼ êµ¬í˜„í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

ì´ ê²½ìš°, Authorization Serverì™€ Resource Server ê°„ì—ë„ JWTë¥¼ ì´ìš©í•  ìˆ˜ ìˆìœ¼ë©°, Spring Securityì—ì„œëŠ” Authorization Serverì™€ Resource Server ê°„ì˜ í†µì‹ ì— JWTë¥¼ ì´ìš©í•  ìˆ˜ ìˆëŠ” APIë¥¼ ì œê³µí•©ë‹ˆë‹¤.

ì•„ìš¸ëŸ¬ ìš°ë¦¬ê°€ ì§€ê¸ˆê» JWTì— ëŒ€í•œ ì„œëª…ì„ ëŒ€ì¹­í‚¤ ë°©ì‹ìœ¼ë¡œ ì§„í–‰í–ˆì§€ë§Œ Authorization Serverì™€ Resource Server ê°„ì— ì£¼ê³ ë°›ëŠ” JWTì˜ ë³´ì•ˆì„±ì„ ê°•í™”í•˜ê¸° ìœ„í•´ ë¹„ëŒ€ì¹­í‚¤ ë°©ì‹ì˜ ì„œëª…ë„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¸°ì–µí•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

ğŸ’¡ ë¹„ëŒ€ì¹­í‚¤ë¡œ JWTë¥¼ ì•”ë³µí˜¸í™”í•˜ëŠ” ë°©ì‹ì€ ìš°ë¦¬ê°€ ì•ì—ì„œ í•™ìŠµí–ˆë˜ OAuth2MemberSuccessHandlerì—ì„œ Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ ìª½ìœ¼ë¡œ JWTë¥¼ ì¿¼ë¦¬íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€í•œ ë’¤ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•  ê²½ìš°ì—ë„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¸°ì–µí•˜ì„¸ìš”.



í•µì‹¬ í¬ì¸íŠ¸
Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ OAuth 2 ì¸ì¦ ì²˜ë¦¬ íë¦„ì—ì„œ Backend ì• í”Œë¦¬ì¼€ì´ì…˜ì´ Authorization Server, Resource Serverì™€ ì¸í„°ë™ì…˜ í•˜ëŠ” ê³¼ì •ì€ Spring Securityì—ì„œ ë‚´ë¶€ì ìœ¼ë¡œ ëŒ€ì‹  ì²˜ë¦¬í•´ ì¤€ë‹¤.

OAuth2MemberSuccessHandler í´ë˜ìŠ¤ëŠ” OAuth 2 ì¸ì¦ í›„, Frontend ì• í”Œë¦¬ì¼€ì´ì…˜ ìª½ìœ¼ë¡œ JWTë¥¼ ì „ì†¡í•˜ëŠ” í•µì‹¬ ì—­í• ì„ ë‹´ë‹¹í•œë‹¤.

JWTì˜ ë³´ì•ˆì„±ì„ ê°•í™”í•˜ê¸° ìœ„í•´ ë¹„ëŒ€ì¹­í‚¤ ë°©ì‹ì˜ ì„œëª…ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.



ì‹¬í™” í•™ìŠµ
OAuth2ClientAuthenticationProcessingFilterì— ëŒ€í•´ì„œ ë” ì•Œì•„ë³´ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ë§í¬ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

https://docs.spring.io/spring-security/oauth/apidocs/org/springframework/security/oauth2/client/filter/OAuth2ClientAuthenticationProcessingFilter.html
