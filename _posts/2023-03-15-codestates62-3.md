---
title: Spring Security ê¸°ë³¸ êµ¬ì¡°
excerpt: Spring Security ê¸°ë³¸ êµ¬ì¡°(2)
categories: Spring
tags: [codestates, Spring]
toc: true
toc_sticky: true
author_profile: true
sidebar_main: true
published : true
---

## íšŒì› ê°€ì… í¼ì„ í†µí•œ InMemory User ë“±ë¡

### PasswordEncoder Bean ë“±ë¡
- PasswordEncoder : Spring Securityì—ì„œ ì œê³µí•˜ëŠ” íŒ¨ìŠ¤ì›Œë“œ ì•”í˜¸í™” ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ì»´í¬ë„ŒíŠ¸
  - íšŒì› ê°€ì… í¼ì„ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì „ë‹¬ë˜ëŠ” íŒ¨ìŠ¤ì›Œë“œëŠ” ì•”í˜¸í™”ë˜ì§€ ì•Šì€ í”Œë ˆì¸ í…ìŠ¤íŠ¸(Plain Text)
    - InMemory Userë¡œ ë“±ë¡í•˜ê¸° ì „ì— ì•”í˜¸í™” 

```java
@Configuration
public class SecurityConfiguration {
    ...
    ...

    @Bean
    public UserDetailsManager userDetailsService() {
        UserDetails user =
                User.withDefaultPasswordEncoder()
                        .username("kevin@gmail.com")
                        .password("1111")
                        .roles("USER")
                        .build();

        UserDetails admin =
                User.withDefaultPasswordEncoder()
                        .username("admin@gmail.com")
                        .password("2222")
                        .roles("ADMIN")
                        .build();

        return new InMemoryUserDetailsManager(user, admin);
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return PasswordEncoderFactories.createDelegatingPasswordEncoder(); 
    }
}
```
<div style = "text-align : center"> PasswordEncoder Bean ë“±ë¡ </div><br>

- PasswordEncoderFactories.createDelegatingPasswordEncoder()ë¥¼ í†µí•´ DelegatingPasswordEncoderë¥¼ ë¨¼ì € ìƒì„± 
  - DelegatingPasswordEncodeê°€ PasswordEncoder êµ¬í˜„ ê°ì²´ë¥¼ ìƒì„±
  - userDetailsService() ë©”ì„œë“œì—ì„œ ë¯¸ë¦¬ ìƒì„±í•˜ëŠ” InMemoryUserì˜ íŒ¨ìŠ¤ì›Œë“œëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ë””í´íŠ¸ PasswordEncoderë¥¼ í†µí•´ ì•”í˜¸í™”

### MemberService Bean ë“±ë¡ì„ ìœ„í•œ JavaConfiguration êµ¬ì„±
```java
public interface MemberService {
    Member createMember(Member member);
}
```
<div style = "text-align : center"> MemberService ì¸í„°í˜ì´ìŠ¤ </div><br>

```java
public class InMemoryMemberService implements MemberService {
    public Member createMember(Member member) {

        return null;
    }
}
```
<div style = "text-align : center"> InMemory User ë“±ë¡ì„ ìœ„í•œ InMemoryMemberService í´ë˜ìŠ¤ </div><br>

```java
@Transactional
public class DBMemberService implements MemberService {
    public Member createMember(Member member) {
         return null;
    }
}
```
<div style = "text-align : center"> ë°ì´í„°ë² ì´ìŠ¤ì— Userë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•œ DBMemberService í´ë˜ìŠ¤ </div><br>

```java
@Configuration
public class JavaConfiguration {
    @Bean
    public MemberService inMemoryMemberService(UserDetailsManager userDetailsManager, 
PasswordEncoder passwordEncoder) {
        return new InMemoryMemberService(userDetailsManager, passwordEncoder);
    }
}
```
<div style = "text-align : center"> MemberService Bean ë“±ë¡ì„ ìœ„í•œ JavaConfiguration êµ¬ì„± </div><br>


- ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì—†ì´ ë©”ëª¨ë¦¬ì— Spring Securityì˜ Userë¥¼ ë“±ë¡í•˜ê³ , User ë“±ë¡ ì‹œ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•˜ê³  ë“±ë¡í•˜ê¸° ìœ„í•œ ê°ì²´ í•„ìš”  
  - UserDetailsManager,  PasswordEncoder DI

### InMemoryMemberService êµ¬í˜„
```java
public class InMemoryMemberService implements MemberService {  // (1)
    private final UserDetailsManager userDetailsManager;
    private final PasswordEncoder passwordEncoder;

    // (2)
    public InMemoryMemberService(UserDetailsManager userDetailsManager, PasswordEncoder passwordEncoder) {
        this.userDetailsManager = userDetailsManager;
        this.passwordEncoder = passwordEncoder;
    }

    public Member createMember(Member member) {
        // (3)
        List<GrantedAuthority> authorities = createAuthorities(Member.MemberRole.ROLE_USER.name());

        // (4)
        String encryptedPassword = passwordEncoder.encode(member.getPassword());

        // (5)
        UserDetails userDetails = new User(member.getEmail(), encryptedPassword, authorities);

        // (6)
        userDetailsManager.createUser(userDetails);

        return member;
    }

    private List<GrantedAuthority> createAuthorities(String... roles) {
        // (3-1)
        return Arrays.stream(roles)
                .map(role -> new SimpleGrantedAuthority(role))
                .collect(Collectors.toList());
    }
}
```
- (1) : InMemoryMemberService í´ë˜ìŠ¤ëŠ” MemberService ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” êµ¬í˜„ í´ë˜ìŠ¤ì´ë¯€ë¡œ implements MemberService
  - @Serviceë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , JavaConfigurationì„ ì´ìš©í•´ Bean ë“±ë¡
- (2) : UserDetailsManagerì™€ PasswordEncoder DI 
  - UserDetailsManagerëŠ” Spring Securityì˜ Userë¥¼ ê´€ë¦¬í•˜ëŠ” ê´€ë¦¬ì ì—­í• 
    - SecurityConfiguration ì—ì„œ Beanìœ¼ë¡œ ë“±ë¡í•œ UserDetailsManagerëŠ” InMemoryUserDetailsManager ì´ë¯€ë¡œ ì—¬ê¸°ì„œ DI ë°›ì€ UserDetailsManager ì¸í„°í˜ì´ìŠ¤ì˜ í•˜ìœ„ íƒ€ì…ì€ InMemoryUserDetailsManager
  - PasswordEncoder ëŠ” Spring Security Userë¥¼ ë“±ë¡í•  ë•Œ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•´ ì£¼ëŠ” í´ë˜ìŠ¤
    - Spring Security 5 ì—ì„œëŠ” InMemory Userë„ íŒ¨ìŠ¤ì›Œë“œì˜ ì•”í˜¸í™”ê°€ í•„ìˆ˜   
    ë”°ë¼ì„œ DI ë°›ì€ PasswordEncoder ë¥¼ ì´ìš©í•´ Userì˜ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™” í•´ì£¼ì–´ì•¼ í•¨
- (3) : Spring Securityì—ì„œ Userë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•´ì„œëŠ” í•´ë‹¹ Userì˜ ê¶Œí•œ(Authority)ì„ ì§€ì •í•´ ì£¼ì–´ì•¼ í•¨
  - createAuthorities(Member.MemberRole.ROLE_USER.name());ë¥¼ ì´ìš©í•´ Userì˜ ê¶Œí•œ ëª©ë¡ì„ List\<GrantedAuthority>ë¡œ ìƒì„±
    - Member í´ë˜ìŠ¤ì—ëŠ” MemberRole ì´ë¼ëŠ” enumì´ ì •ì˜ë˜ì–´ ìˆê³ , ROLE_USERì™€ ROLE_ADMINì´ë¼ëŠ” enum íƒ€ì…ì´ ì •ì˜ë˜ì–´ ìˆìŒ
  - Spring Securityì—ì„œëŠ” SimpleGrantedAuthority ë¥¼ ì‚¬ìš©í•´ Role ë² ì´ìŠ¤ í˜•íƒœì˜ ê¶Œí•œì„ ì§€ì •í•  ë•Œ â€˜ROLE_â€™ + ê¶Œí•œ ëª… í˜•íƒœë¡œ ì§€ì •í•´ ì£¼ì–´ì•¼ í•¨. ê·¸ë ‡ì§€ ì•Šì„ ê²½ìš° ì ì ˆí•œ ê¶Œí•œ ë§¤í•‘ì´ ì´ë£¨ì–´ì§€ì§€ ì•ŠìŒ
    - (3-1) : Javaì˜ Stream APIë¥¼ ì´ìš©í•´ ìƒì„±ì íŒŒë¼ë¯¸í„°ë¡œ í•´ë‹¹ Userì˜ Roleì„ ì „ë‹¬í•˜ë©´ì„œ SimpleGrantedAuthority ê°ì²´ë¥¼ ìƒì„±í•œ í›„, List\<SimpleGrantedAuthority> í˜•íƒœë¡œ ë¦¬í„´
  - (4) : PasswordEncoder ë¥¼ ì´ìš©í•´ ë“±ë¡í•  Userì˜ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”
    - íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•˜ì§€ ì•Šê³  Userë¥¼ ë“±ë¡í•œë‹¤ë©´ User ë“±ë¡ì€ ë˜ì§€ë§Œ ë¡œê·¸ì¸ ì¸ì¦ ì‹œ, ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ë¥¼ ë§Œë‚˜ê²Œ ë˜ë¯€ë¡œ Userì˜ íŒ¨ìŠ¤ì›Œë“œëŠ” ë°˜ë“œì‹œ ì•”í˜¸í™”ê°€ í•„ìš”
  - (5) :  Spring Security Userë¡œ ë“±ë¡í•˜ê¸° ìœ„í•œ UserDetails ìƒì„±
    -  Spring Securityì—ì„œëŠ” Spring Securityì—ì„œ ê´€ë¦¬í•˜ëŠ” User ì •ë³´ë¥¼ UserDetailsë¡œ ê´€ë¦¬
  - (6) : UserDetailsManagerì˜ createUser() ë©”ì„œë“œë¥¼ ì´ìš©í•´ì„œ Userë¥¼ ë“±ë¡

 íšŒì› ê°€ì… ë©”ë‰´ì—ì„œ íšŒì› ì •ë³´ë¥¼ ë“±ë¡í•œ í›„, ë“±ë¡í•œ íšŒì› ì •ë³´ë¡œ ë¡œê·¸ì¸ì„ ìˆ˜í–‰í•˜ë©´ ì •ìƒì ìœ¼ë¡œ ë¡œê·¸ì¸ì´ ë¨

 ## ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ì„ í†µí•œ ë¡œê·¸ì¸ ì¸ì¦

 ### Custom UserDetailsServiceë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•

 #### SecurityConfigurationì˜ ì„¤ì • ë³€ê²½ ë° ì¶”ê°€
- ë¡œê·¸ì¸ ì¸ì¦ì„ ìœ„í•´ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì–´ ìˆëŠ” ì¸ì¦ ì •ë³´ ì‚¬ìš©
- InMemory Userë¥¼ ìœ„í•œ ì„¤ì •ë“¤ì€ ë” ì´ìƒ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ì œê±°
 ```java
 @Configuration
public class SecurityConfiguration {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .headers().frameOptions().sameOrigin() // (1)
            .and()
            .csrf().disable()
            .formLogin()
            .loginPage("/auths/login-form")
            .loginProcessingUrl("/process_login")
            .failureUrl("/auths/login-form?error")
            .and()
            .logout()
            .logoutUrl("/logout")
            .logoutSuccessUrl("/")
            .and()
            .exceptionHandling().accessDeniedPage("/auths/access-denied")
            .and()
            .authorizeHttpRequests(authorize -> authorize
                    .antMatchers("/orders/**").hasRole("ADMIN")
                    .antMatchers("/members/my-page").hasRole("USER")
                    .antMatchers("â„**").permitAll()
            );
        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
    }
}
 ```
 (1) : ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ H2 ì›¹ ì½˜ì†”ì„ ì •ìƒì ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì„¤ì •


 #################################





[ê¸°ë³¸] Hello, Spring Securityë¡œ ì•Œì•„ë³´ëŠ” Spring Securityì˜ ê¸°ë³¸ êµ¬ì¡° (2)
ì´ì „ ì±•í„°ì—ì„œ InMemory Userë¥¼ ì´ìš©í•´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œ, ë©”ëª¨ë¦¬ì— ë‘ ê°œì˜ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¯¸ë¦¬ ë“±ë¡(kevin@gmail.com, admin@gmail.com)í•œ í›„ ì‚¬ìš©ìì˜ ê¶Œí•œ ë³„ë¡œ request URLì˜ ì ‘ê·¼ì´ ì œí•œë˜ëŠ”ì§€ ì—¬ë¶€ ë“±ì„ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.


ê·¸ëŸ°ë° ì§€ë‚œ ì±•í„°ê¹Œì§€ í•™ìŠµí•œ ë‚´ìš©ë§Œìœ¼ë¡œëŠ” ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ì§€ ì•ŠëŠ” ê¸°ëŠ¥ì´ í•˜ë‚˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ê²ƒì€ ë°”ë¡œ íšŒì› ê°€ì…ì…ë‹ˆë‹¤.


ì—¬ëŸ¬ë¶„ë“¤ì´ ì¼ë°˜ì ìœ¼ë¡œ ìƒê°í•˜ê¸°ë¡œ íšŒì› ê°€ì… í›„, ê°€ì…í•œ íšŒì› ì •ë³´ë¡œ ë‹¹ì—°íˆ ë¡œê·¸ì¸ì„ í•  ìˆ˜ ìˆì–´ì•¼ í•  í…ë° í˜„ì¬ ìƒíƒœë¡œëŠ” íšŒì› ê°€ì…ì´ ì—ëŸ¬ ì—†ì´ ì§„í–‰ë˜ëŠ” ê²ƒ ê°™ì§€ë§Œ ê°€ì…í•œ íšŒì› ì •ë³´ë¡œ ë¡œê·¸ì¸í•´ ë³´ë©´ ë¡œê·¸ì¸ ì¸ì¦ì— ì‹¤íŒ¨í•©ë‹ˆë‹¤.


ì™œ ì‹¤íŒ¨í• ê¹Œìš”?


ìš°ë¦¬ëŠ” ì•„ì§ Hello Spring Security ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ íšŒì› ê°€ì… ìš”ì²­ìœ¼ë¡œ ì „ë‹¬ë°›ì€ íšŒì› ì •ë³´ë¥¼ Spring Securityê°€ ì•Œ ìˆ˜ ìˆëŠ” ì–´ë– í•œ ì²˜ë¦¬ë„ í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.


ìš°ë¦¬ê°€ ì•„ì§ H2ë‚˜ MySQL ê°™ì€ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ë‹¨ìˆœíˆ ë©”ëª¨ë¦¬ì— ë¯¸ë¦¬ ë“±ë¡í•œ InMemory Userë¥¼ ì‚¬ìš©í•˜ê³  ìˆì§€ë§Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ë˜ê³  ë‚œ ì´í›„ì—ë„ InMemory Userë¥¼ ì¶”ê°€ì ìœ¼ë¡œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


ì´ì œ ë¬´ëŠ¬ë§Œ ìˆëŠ” ê¸°ëŠ¥ì¸ íšŒì› ê°€ì… ê¸°ëŠ¥ì„ ì œëŒ€ë¡œ ë™ì‘í•˜ë„ë¡ ì½”ë“œë¥¼ ìˆ˜ì •í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.



ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì—†ëŠ” ë¡œê·¸ì¸ ì¸ì¦
```java
package com.codestates.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.factory.PasswordEncoderFactories;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.provisioning.UserDetailsManager;

@Configuration
public class SecurityConfiguration {
    ...
    ...

    @Bean
    public UserDetailsManager userDetailsService() {
        UserDetails user =
                User.withDefaultPasswordEncoder()
                        .username("kevin@gmail.com")
                        .password("1111")
                        .roles("USER")
                        .build();

        UserDetails admin =
                User.withDefaultPasswordEncoder()
                        .username("admin@gmail.com")
                        .password("2222")
                        .roles("ADMIN")
                        .build();

        return new InMemoryUserDetailsManager(user, admin);
    }
}
```
[ì½”ë“œ 4-15] ë“±ë¡ëœ ë‘ ê°œì˜ InMemory User


ì½”ë“œ 4-15ëŠ” ì´ì „ ì±•í„°ì—ì„œ ì„¤ì •í•œ InMemory User ë“±ë¡ì„ ìœ„í•œ ì½”ë“œì…ë‹ˆë‹¤.

ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ë˜ë©´, ì½”ë“œ 4-15ì˜ userDetailsService() ë©”ì„œë“œì—ì„œ ì„¤ì •í•œ ë‘ ê°œì˜ Userê°€ InMemory Userë¡œ ë“±ë¡ë©ë‹ˆë‹¤.


ì´ì œ ìƒˆë¡œìš´ Userë¥¼ ë“±ë¡í•˜ëŠ” ì‘ì—…ì„ ì¶”ê°€í•´ ë´…ì‹œë‹¤.


â­ ìŠì§€ ë§ˆì„¸ìš”â—

ì—¬ê¸°ì—ì„œ User ë“±ë¡ì€ ë°ì´í„°ë² ì´ìŠ¤ì— íšŒì› ì •ë³´ë¥¼ ë“±ë¡í•˜ëŠ” ê²Œ ì•„ë‹™ë‹ˆë‹¤.

ìš°ë¦¬ëŠ” ì•„ì§ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì—°ë™í•˜ì§€ ì•Šê³ , Spring Securityì—ì„œ ì§€ì›í•˜ëŠ” InMemory Userë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¸°ì–µí•˜ì„¸ìš”!


ê·¸ë ‡ë‹¤ë©´ ì—¬ê¸°ì„œ ì˜ë¯¸í•˜ëŠ” User ë“±ë¡ì€?


ë§ìŠµë‹ˆë‹¤. ë°”ë¡œ ë©”ëª¨ë¦¬ì— ë“±ë¡í•˜ëŠ” InMemory Userì…ë‹ˆë‹¤.



âœ… íšŒì› ê°€ì… í¼ì„ í†µí•œ InMemory User ë“±ë¡
íšŒì› ê°€ì… í¼ì„ í†µí•´ InMemory Userë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•œ ì‘ì—… ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

PasswordEncoder Bean ë“±ë¡

MemberService Bean ë“±ë¡ì„ ìœ„í•œ JavaConfiguration êµ¬ì„±

InMemoryMemberService í´ë˜ìŠ¤ êµ¬í˜„


1ï¸âƒ£ PasswordEncoder Bean ë“±ë¡

PasswordEncoderëŠ” Spring Securityì—ì„œ ì œê³µí•˜ëŠ” íŒ¨ìŠ¤ì›Œë“œ ì•”í˜¸í™” ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.

ìš°ë¦¬ê°€ íšŒì› ê°€ì… í¼ì„ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì „ë‹¬ë˜ëŠ” íŒ¨ìŠ¤ì›Œë“œëŠ” ì•”í˜¸í™”ë˜ì§€ ì•Šì€ í”Œë ˆì¸ í…ìŠ¤íŠ¸(Plain Text)ì…ë‹ˆë‹¤.

ë”°ë¼ì„œ íšŒì› ê°€ì… í¼ì—ì„œ ì „ë‹¬ë°›ì€ íŒ¨ìŠ¤ì›Œë“œëŠ” InMemory Userë¡œ ë“±ë¡í•˜ê¸° ì „ì— ì•”í˜¸í™”ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.


PasswordEncoderëŠ” ë‹¤ì–‘í•œ ì•”í˜¸í™” ë°©ì‹ì„ ì œê³µí•˜ë©°, Spring Securityì—ì„œ ì§€ì›í•˜ëŠ” PasswordEncoderì˜ ë””í´íŠ¸ ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜ì€ bcryptì…ë‹ˆë‹¤.

PasswordEncoderì™€ bcrypt ì•Œê³ ë¦¬ì¦˜ì— ëŒ€í•´ì„œ ë” ì•Œì•„ë³´ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ì˜ [ì‹¬í™” í•™ìŠµ]ì„ ì°¸ê³ í•˜ì„¸ìš”.


```java
package com.codestates.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.factory.PasswordEncoderFactories;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.provisioning.UserDetailsManager;

@Configuration
public class SecurityConfiguration {
    ...
    ...

    @Bean
    public UserDetailsManager userDetailsService() {
        UserDetails user =
                User.withDefaultPasswordEncoder()
                        .username("kevin@gmail.com")
                        .password("1111")
                        .roles("USER")
                        .build();

        UserDetails admin =
                User.withDefaultPasswordEncoder()
                        .username("admin@gmail.com")
                        .password("2222")
                        .roles("ADMIN")
                        .build();

        return new InMemoryUserDetailsManager(user, admin);
    }

    // (1)
    @Bean
    public PasswordEncoder passwordEncoder() {
        return PasswordEncoderFactories.createDelegatingPasswordEncoder();  // (1-1)
    }
}
```
[ì½”ë“œ 4-16] PasswordEncoder Bean ë“±ë¡


ì½”ë“œ 4-16ì—ì„œëŠ” (1)ê³¼ ê°™ì´ SecurityConfiguration í´ë˜ìŠ¤ì—ì„œ PasswordEncoderë¥¼ Beanìœ¼ë¡œ ë“±ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.


(1-1)ì˜ PasswordEncoderFactories.createDelegatingPasswordEncoder();ë¥¼ í†µí•´ DelegatingPasswordEncoderë¥¼ ë¨¼ì € ìƒì„±í•˜ëŠ”ë°, ì´ DelegatingPasswordEncoderê°€ ì‹¤ì§ˆì ìœ¼ë¡œ PasswordEncoder êµ¬í˜„ ê°ì²´ë¥¼ ìƒì„±í•´ ì¤ë‹ˆë‹¤.


ìš°ë¦¬ê°€ userDetailsService() ë©”ì„œë“œì—ì„œ ë¯¸ë¦¬ ìƒì„±í•˜ëŠ” InMemoryUserì˜ íŒ¨ìŠ¤ì›Œë“œëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ë””í´íŠ¸ PasswordEncoderë¥¼ í†µí•´ ì•”í˜¸í™”ëœë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¸°ì–µí•˜ì„¸ìš”!



2ï¸âƒ£ MemberService Bean ë“±ë¡ì„ ìœ„í•œ JavaConfiguration êµ¬ì„±

ì—¬ëŸ¬ë¶„ë“¤ì´ ì„¹ì…˜ 3ì—ì„œ ìµìˆ™í•˜ê²Œ ì‚¬ìš©í•œ MemberServiceëŠ” í´ë˜ìŠ¤ì´ì§€ë§Œ ì—¬ê¸°ì„œëŠ” í•™ìŠµ ëª©ì ì„ ìœ„í•´ í¸ì˜ìƒ ì½”ë“œ 4-17ê³¼ ê°™ì´ í´ë˜ìŠ¤ê°€ ì•„ë‹Œ MemberService ì¸í„°í˜ì´ìŠ¤ë¡œ êµ¬í˜„í•©ë‹ˆë‹¤.

```java
package com.codestates.member;

public interface MemberService {
    Member createMember(Member member);
}
```
[4-17] MemberService ì¸í„°í˜ì´ìŠ¤


Hello Spring Security ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ íšŒì› ê°€ì… í¼ì—ì„œ ì „ë‹¬ë°›ì€ ì •ë³´ë¥¼ ì´ìš©í•´ ìƒˆë¡œìš´ ì‚¬ìš©ìë¥¼ ì¶”ê°€í•˜ëŠ” ê¸°ëŠ¥ë§Œ ìˆìœ¼ë©´ ë˜ë¯€ë¡œ createMember() í•˜ë‚˜ë§Œ êµ¬í˜„í•˜ëŠ” êµ¬í˜„ì²´ê°€ ìˆìœ¼ë©´ ë©ë‹ˆë‹¤.


ì´ì œ ì´ MemberService ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” êµ¬í˜„ í´ë˜ìŠ¤ê°€ ìˆì–´ì•¼ í•˜ê² ì£ ?


âœ” InMemory User ë“±ë¡ì„ ìœ„í•œ InMemoryMemberService í´ë˜ìŠ¤

```java
package com.codestates.member;

public class InMemoryMemberService implements MemberService {
    public Member createMember(Member member) {

        return null;
    }
}
```
[ì½”ë“œ 4-18] InMemory User ë“±ë¡ì„ ìœ„í•œ InMemoryMemberService í´ë˜ìŠ¤


ì½”ë“œ 4-18ì€ InMemory Userë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•œ MemberService ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ í´ë˜ìŠ¤ì¸ InMemoryMemberService í´ë˜ìŠ¤ì…ë‹ˆë‹¤.


InMemoryMemberService í´ë˜ìŠ¤ì˜ createMember()ëŠ” ì ì‹œ ë’¤ì— êµ¬í˜„í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.



âœ” ë°ì´í„°ë² ì´ìŠ¤ì— Userë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•œ DBMemberService í´ë˜ìŠ¤

```java
package com.codestates.member;

import org.springframework.transaction.annotation.Transactional;

@Transactional
public class DBMemberService implements MemberService {
    public Member createMember(Member member) {
         return null;
    }
}
```
[ì½”ë“œ 4-19] ë°ì´í„°ë² ì´ìŠ¤ì— Userë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•œ DBMemberService í´ë˜ìŠ¤


ì½”ë“œ 4-19ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— Userë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•œ MemberService ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ í´ë˜ìŠ¤ì¸ DBMemberService í´ë˜ìŠ¤ì…ë‹ˆë‹¤.


DBMemberService í´ë˜ìŠ¤ëŠ” InMemory User ë“±ë¡ í•™ìŠµì´ ëë‚œ ë‹¤ìŒ ì´ì–´ì„œ ë°”ë¡œ êµ¬í˜„í•´ ë³¼ ì˜ˆì •ì´ë‹ˆ ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!ğŸ˜Š



âœ” JavaConfiguration êµ¬ì„±

```java
package com.codestates.config;

import com.codestates.member.InMemoryMemberService;
import com.codestates.member.MemberService;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.provisioning.UserDetailsManager;

@Configuration
public class JavaConfiguration {
    // (1)
    @Bean
    public MemberService inMemoryMemberService(UserDetailsManager userDetailsManager, 
                                               PasswordEncoder passwordEncoder) {
        return new InMemoryMemberService(userDetailsManager, passwordEncoder);
    }
}
```
[ì½”ë“œ 4-20] MemberService Bean ë“±ë¡ì„ ìœ„í•œ JavaConfiguration êµ¬ì„±


ì½”ë“œ 4-20 JavaConfiguration í´ë˜ìŠ¤ì—ì„œëŠ” MemberService ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ í´ë˜ìŠ¤ì¸ InMemoryMemberServiceë¥¼ Spring Beanìœ¼ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.

(1)ì—ì„œëŠ” MemberService ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ì¸ InMemoryMemberService í´ë˜ìŠ¤ì˜ Bean ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

InMemoryMemberService í´ë˜ìŠ¤ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì—†ì´ ë©”ëª¨ë¦¬ì— Spring Securityì˜ Userë¥¼ ë“±ë¡í•´ì•¼ í•˜ë¯€ë¡œ UserDetailsManager ê°ì²´ê°€ í•„ìš”í•©ë‹ˆë‹¤.

ë˜í•œ User ë“±ë¡ ì‹œ, íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•œ í›„ì— ë“±ë¡í•´ì•¼ í•˜ë¯€ë¡œ Spring Securityì—ì„œ ì œê³µí•˜ëŠ” PasswordEncoder ê°ì²´ê°€ í•„ìš”í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ ì´ ë‘ ê°ì²´ë¥¼ InMemoryMemberService ê°ì²´ ìƒì„± ì‹œ, DI í•´ ì¤ë‹ˆë‹¤.



3ï¸âƒ£ InMemoryMemberService êµ¬í˜„

```java
package com.codestates.member;

import com.codestates.auth.utils.AuthorityUtils;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.provisioning.UserDetailsManager;

import java.util.List;

public class InMemoryMemberService implements MemberService {  // (1)
    private final UserDetailsManager userDetailsManager;
    private final PasswordEncoder passwordEncoder;

    // (2)
    public InMemoryMemberService(UserDetailsManager userDetailsManager, PasswordEncoder passwordEncoder) {
        this.userDetailsManager = userDetailsManager;
        this.passwordEncoder = passwordEncoder;
    }

    public Member createMember(Member member) {
        // (3)
        List<GrantedAuthority> authorities = createAuthorities(Member.MemberRole.ROLE_USER.name());

        // (4)
        String encryptedPassword = passwordEncoder.encode(member.getPassword());

        // (5)
        UserDetails userDetails = new User(member.getEmail(), encryptedPassword, authorities);

        // (6)
        userDetailsManager.createUser(userDetails);

        return member;
    }

    private List<GrantedAuthority> createAuthorities(String... roles) {
        // (3-1)
        return Arrays.stream(roles)
                .map(role -> new SimpleGrantedAuthority(role))
                .collect(Collectors.toList());
    }
}
```
[ì½”ë“œ 4-21] ë©”ëª¨ë¦¬ì— Spring Security Userë¥¼ ë“±ë¡í•´ ì£¼ëŠ” InMemoryMemberService í´ë˜ìŠ¤


ì½”ë“œ 4-21ì€ íšŒì› ê°€ì… ì •ë³´ë¥¼ ì „ë‹¬ë°›ì•„ Spring Securityì˜ Userë¥¼ ë©”ëª¨ë¦¬ì— ë“±ë¡í•´ ì£¼ëŠ” InMemoryMemberService í´ë˜ìŠ¤ì˜ ì½”ë“œì…ë‹ˆë‹¤.


ì½”ë“œì˜ ì„¤ëª…ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

InMemoryMemberService í´ë˜ìŠ¤ëŠ” MemberService ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” êµ¬í˜„ í´ë˜ìŠ¤ì„ìœ¼ë¡œ (1)ê³¼ ê°™ì´ implements MemberServiceë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

ìš°ë¦¬ê°€ ì—¬íƒœê» @Service ì• ë„ˆí…Œì´ì…˜ì„ ì‚¬ìš©í•´ íŠ¹ì • ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ë¥¼ Beanìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•´ ì™”ì§€ë§Œ ì—¬ê¸°ì„œëŠ” @Serviceì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ , JavaConfigurationì„ ì´ìš©í•´ Beanì„ ë“±ë¡í•˜ê³  ìˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¸°ì–µí•˜ê¸°ë¥¼ ë°”ëë‹ˆë‹¤.


(2)ì—ì„œëŠ” UserDetailsManagerì™€ PasswordEncoderë¥¼ DI ë°›ìŠµë‹ˆë‹¤.

UserDetailsManagerëŠ” Spring Securityì˜ Userë¥¼ ê´€ë¦¬í•˜ëŠ” ê´€ë¦¬ì ì—­í• ì„ í•©ë‹ˆë‹¤. ìš°ë¦¬ê°€ SecurityConfigurationì—ì„œ Beanìœ¼ë¡œ ë“±ë¡í•œ UserDetailsManagerëŠ” InMemoryUserDetailsManagerì´ë¯€ë¡œ ì—¬ê¸°ì„œ DI ë°›ì€ UserDetailsManager ì¸í„°í˜ì´ìŠ¤ì˜ í•˜ìœ„ íƒ€ì…ì€InMemoryUserDetailsManagerë¼ëŠ” ì‚¬ì‹¤ì„ ê¸°ì–µí•˜ê¸°ë¥¼ ë°”ëë‹ˆë‹¤.

PasswordEncoderëŠ” Spring Security Userë¥¼ ë“±ë¡í•  ë•Œ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•´ ì£¼ëŠ” í´ë˜ìŠ¤ì…ë‹ˆë‹¤.

Spring Security 5ì—ì„œëŠ” InMemory Userë„ íŒ¨ìŠ¤ì›Œë“œì˜ ì•”í˜¸í™”ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤. ë”°ë¼ì„œ DI ë°›ì€ PasswordEncoderë¥¼ ì´ìš©í•´ Userì˜ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.


Spring Securityì—ì„œ Userë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•´ì„œëŠ” í•´ë‹¹ Userì˜ ê¶Œí•œ(Authority)ì„ ì§€ì •í•´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ (3)ì˜ createAuthorities(Member.MemberRole.ROLE_USER.name());ë¥¼ ì´ìš©í•´ Userì˜ ê¶Œí•œ ëª©ë¡ì„ List<GrantedAuthority>ë¡œ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.

Member í´ë˜ìŠ¤ì—ëŠ” MemberRoleì´ë¼ëŠ” enumì´ ì •ì˜ë˜ì–´ ìˆê³ , ROLE_USERì™€ ROLE_ADMINì´ë¼ëŠ” enum íƒ€ì…ì´ ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

â­ Spring Securityì—ì„œëŠ” SimpleGrantedAuthorityë¥¼ ì‚¬ìš©í•´ Role ë² ì´ìŠ¤ í˜•íƒœì˜ ê¶Œí•œì„ ì§€ì •í•  ë•Œ â€˜ROLE_â€™ + ê¶Œí•œ ëª… í˜•íƒœë¡œ ì§€ì •í•´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šì„ ê²½ìš° ì ì ˆí•œ ê¶Œí•œ ë§¤í•‘ì´ ì´ë£¨ì–´ì§€ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¸°ì–µí•˜ê¸°ë¥¼ ë°”ëë‹ˆë‹¤.

(3-1)ì—ì„œëŠ” Javaì˜ Stream APIë¥¼ ì´ìš©í•´ ìƒì„±ì íŒŒë¼ë¯¸í„°ë¡œ í•´ë‹¹ Userì˜ Roleì„ ì „ë‹¬í•˜ë©´ì„œ SimpleGrantedAuthority ê°ì²´ë¥¼ ìƒì„±í•œ í›„, List<SimpleGrantedAuthority> í˜•íƒœë¡œ ë¦¬í„´í•´ ì¤ë‹ˆë‹¤.

(4)ì—ì„œëŠ” PasswordEncoderë¥¼ ì´ìš©í•´ ë“±ë¡í•  Userì˜ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ë§Œì•½, íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•˜ì§€ ì•Šê³  Userë¥¼ ë“±ë¡í•œë‹¤ë©´ User ë“±ë¡ì€ ë˜ì§€ë§Œ ë¡œê·¸ì¸ ì¸ì¦ ì‹œ, ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ë¥¼ ë§Œë‚˜ê²Œ ë˜ë¯€ë¡œ Userì˜ íŒ¨ìŠ¤ì›Œë“œëŠ” ë°˜ë“œì‹œ ì•”í˜¸í™”í•´ì•¼ í•©ë‹ˆë‹¤.

java.lang.IllegalArgumentException: There is no PasswordEncoder mapped for the id "nullâ€


(5)ì—ì„œëŠ” Spring Security Userë¡œ ë“±ë¡í•˜ê¸° ìœ„í•´ UserDetailsë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

â­ Spring Securityì—ì„œëŠ” Spring Securityì—ì„œ ê´€ë¦¬í•˜ëŠ” User ì •ë³´ë¥¼ UserDetailsë¡œ ê´€ë¦¬í•œë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¼­ ê¸°ì–µí•˜ê¸°ë¥¼ ë°”ëë‹ˆë‹¤.


(6)ì—ì„œëŠ” UserDetailsManagerì˜ createUser() ë©”ì„œë“œë¥¼ ì´ìš©í•´ì„œ Userë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.

ì´ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ê³  [íšŒì› ê°€ì…] ë©”ë‰´ì—ì„œ íšŒì› ì •ë³´ë¥¼ ë“±ë¡í•œ í›„, ë“±ë¡í•œ íšŒì› ì •ë³´(ì´ë©”ì¼ ì£¼ì†Œ, íŒ¨ìŠ¤ì›Œë“œ)ë¡œ ë¡œê·¸ì¸ì„ ìˆ˜í–‰í•˜ë©´ ì •ìƒì ìœ¼ë¡œ ë¡œê·¸ì¸ì´ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.



ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ì„ í†µí•œ ë¡œê·¸ì¸ ì¸ì¦
ì•ì—ì„œ ì‚´í´ë³¸ ë¡œê·¸ì¸ ì¸ì¦ ë°©ì‹ì€ ì˜¤ë¡œì§€ Spring Securityì—ì„œ ì œê³µí•˜ëŠ” InMemory Userë¥¼ ì‚¬ìš©í•˜ëŠ” ì¸ì¦ ë°©ì‹ì…ë‹ˆë‹¤.


InMemory UserëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë‹¤ì‹œ ì‹œì‘í•˜ë©´ ë©”ëª¨ë¦¬ì— ë“±ë¡í–ˆë˜ User ì •ë³´ê°€ ëª¨ë‘ ì‚¬ë¼ì§€ê¸° ë•Œë¬¸ì— ì‹¤ë¬´ì—ì„œëŠ” ë‹¹ì—°íˆ ì‚¬ìš©í•˜ê¸° í˜ë“¤ê² ì£ ?


ì´ì œ ë°ì´í„°ë² ì´ìŠ¤ ê°™ì€ ì˜êµ¬ ì €ì¥ì†Œë¥¼ ì´ìš©í•´ ì‚¬ìš©ìì˜ ì¸ì¦ ì •ë³´ë¥¼ ê´€ë¦¬í•´ì•¼ ë  ì‹œì ì¸ ê²ƒ ê°™êµ°ìš”.


ìš°ë¦¬ê°€ ì—¬íƒœê» í•™ìŠµì„ ìœ„í•´ ë§Œë“¤ì–´ë³´ì•˜ë˜ ì»¤í”¼ ì£¼ë¬¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ Member í´ë˜ìŠ¤ ê°™ì€ ì—”í‹°í‹° í´ë˜ìŠ¤ë¡œ íšŒì› ì •ë³´ë¥¼ MEMBER í…Œì´ë¸”ì— ì €ì¥í–ˆë“¯ì´ Hello Spring Security ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œë„ ê°„ë‹¨í•œ Member ì—”í‹°í‹° í´ë˜ìŠ¤ë¥¼ ì´ìš©í•´ì„œ íšŒì›ì˜ ì¸ì¦ ì •ë³´ë¥¼ í¬í•¨í•œ íšŒì› ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì—ì„œ ê´€ë¦¬í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.


InMemory Userë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì€ í…ŒìŠ¤íŠ¸ í™˜ê²½ì´ë‚˜ ë°ëª¨ í™˜ê²½ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

ğŸ’¡ ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•˜ì§€ë„ ì•ŠëŠ” ë°©ì‹ì„ êµ³ì´ ì™œ ì„¤ëª…í•˜ëŠëƒê³  í•  ìˆ˜ë„ ìˆê² ì§€ë§Œ InMemory Userë¥¼ ì´ìš©í•œ ë¡œê·¸ì¸ ì¸ì¦ì— ëŒ€í•´ í•™ìŠµí•˜ë©´ì„œ ìš°ë¦¬ê°€ Spring Securityì˜ ê¸°ë³¸ êµ¬ì¡°ì™€ ì‚¬ìš©ë²• ë“±ì„ ë‹¨ê³„ì ìœ¼ë¡œ ìµíˆê³  ìˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¼­ ê¸°ì–µí•˜ê¸°ë¥¼ ë°”ëë‹ˆë‹¤.



âœ… Custom UserDetailsServiceë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•
Spring Securityì—ì„œëŠ” Userì˜ ì¸ì¦ ì •ë³´ë¥¼ í…Œì´ë¸”ì— ì €ì¥í•˜ê³ , í…Œì´ë¸”ì— ì €ì¥ëœ ì¸ì¦ ì •ë³´ë¥¼ ì´ìš©í•´ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆëŠ” ëª‡ ê°€ì§€ ë°©ë²•ì´ ì¡´ì¬í•˜ëŠ”ë° ê·¸ì¤‘ í•œ ê°€ì§€ ë°©ë²•ì´ ë°”ë¡œ Custom UserDetailsServiceë¥¼ ì´ìš©í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.


Custom UserDetailsServiceë¥¼ ì´ìš©í•´ Userì˜ ë¡œê·¸ì¸ ì¸ì¦ì„ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ëŠ”ì§€ ì§€ê¸ˆë¶€í„° ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.


ì¼ë°˜ì ìœ¼ë¡œ Spring Securityì—ì„œëŠ” ì¸ì¦ì„ ì‹œë„í•˜ëŠ” ì£¼ì²´ë¥¼ User(ë¹„ìŠ·í•œ ì˜ë¯¸ë¡œ Principalë„ ìˆìŒ)ë¼ê³  ë¶€ë¦…ë‹ˆë‹¤.

Principalì€ Userì˜ ë” êµ¬ì²´ì ì¸ ì •ë³´ë¥¼ ì˜ë¯¸í•˜ë©°, ì¼ë°˜ì ìœ¼ë¡œ Spring Securityì—ì„œì˜ Usernameì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” Member ì—”í‹°í‹° í´ë˜ìŠ¤ê°€ ë¡œê·¸ì¸ ì¸ì¦ ì •ë³´ë¥¼ í¬í•¨í•  í…ë° ì´ Member ì—”í‹°í‹°ê°€ Spring Securityì˜ User ì •ë³´ë¥¼ í¬í•¨í•œë‹¤ê³  ë³´ë©´ ë©ë‹ˆë‹¤.


1ï¸âƒ£ SecurityConfigurationì˜ ì„¤ì • ë³€ê²½ ë° ì¶”ê°€

ì§€ê¸ˆë¶€í„°ëŠ” ë¡œê·¸ì¸ ì¸ì¦ì„ ìœ„í•´ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì–´ ìˆëŠ” ì¸ì¦ ì •ë³´ë¥¼ ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.

ë”°ë¼ì„œ InMemory Userë¥¼ ìœ„í•œ ì„¤ì •ë“¤ì€ ë” ì´ìƒ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ì œê±°í•´ì•¼ í•©ë‹ˆë‹¤.

```java
package com.codestates.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.annotation.Order;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.factory.PasswordEncoderFactories;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.provisioning.UserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
public class SecurityConfiguration {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .headers().frameOptions().sameOrigin() // (1)
            .and()
            .csrf().disable()
            .formLogin()
            .loginPage("/auths/login-form")
            .loginProcessingUrl("/process_login")
            .failureUrl("/auths/login-form?error")
            .and()
            .logout()
            .logoutUrl("/logout")
            .logoutSuccessUrl("/")
            .and()
            .exceptionHandling().accessDeniedPage("/auths/access-denied")
            .and()
            .authorizeHttpRequests(authorize -> authorize
                    .antMatchers("/orders/**").hasRole("ADMIN")
                    .antMatchers("/members/my-page").hasRole("USER")
                    .antMatchers("â„**").permitAll()
            );
        return http.build();
    }

   // ======================================================== ì—¬ê¸°ë¶€í„°
   /**
    * InMemory Userë¥¼ ìœ„í•œ ì„¤ì •ì´ë¯€ë¡œ, ì œê±° ëŒ€ìƒ.
    */
    @Bean
    public UserDetailsManager userDetailsService() {    // (2)
        UserDetails user =
                User.withDefaultPasswordEncoder()
                        .username("kevin@gmail.com")
                        .password("1111")
                        .roles("USER")
                        .build();

        UserDetails admin =
                User.withDefaultPasswordEncoder()
                        .username("admin@gmail.com")
                        .password("2222")
                        .roles("ADMIN")
                        .build();

        return new InMemoryUserDetailsManager(user, admin);
    }
   // ======================================================== ì—¬ê¸°ê¹Œì§€ ì œê±°

    @Bean
    public PasswordEncoder passwordEncoder() {
        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
    }
}
```
[ì½”ë“œ 4-22] í˜„ì¬ ì‹œì ê¹Œì§€ ì‚¬ìš©í•˜ê³  ìˆëŠ” SecurityConfiguration(V1) í´ë˜ìŠ¤


ì½”ë“œ 4-22ì˜ SecurityConfiguration í´ë˜ìŠ¤ì—ì„œ (1)ì€ ì—¬ëŸ¬ë¶„ë“¤ì´ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ H2 ì›¹ ì½˜ì†”ì„ ì •ìƒì ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì„¤ì •ì…ë‹ˆë‹¤.

frameOptions()ëŠ” HTML íƒœê·¸ ì¤‘ì—ì„œ \<frame>ì´ë‚˜ \<iframe>, \<object> íƒœê·¸ì—ì„œ í˜ì´ì§€ë¥¼ ë Œë”ë§ í• ì§€ì˜ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ëŠ” ê¸°ëŠ¥ì„ í•©ë‹ˆë‹¤.

Spring Securityì—ì„œëŠ” Clickjacking ê³µê²©ì„ ë§‰ê¸° ìœ„í•´ ê¸°ë³¸ì ìœ¼ë¡œ frameOptions() ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©° ë””í´íŠ¸ ê°’ì€ DENYì…ë‹ˆë‹¤. ì¦‰, ìœ„ì—ì„œ ì–¸ê¸‰í•œ HTML íƒœê·¸ë¥¼ ì´ìš©í•œ í˜ì´ì§€ ë Œë”ë§ì„ í—ˆìš©í•˜ì§€ ì•Šê² ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.

(1)ê³¼ ê°™ì´ .frameOptions().sameOrigin()ì„ í˜¸ì¶œí•˜ë©´ ë™ì¼ ì¶œì²˜ë¡œë¶€í„° ë“¤ì–´ì˜¤ëŠ” requestë§Œ í˜ì´ì§€ ë Œë”ë§ì„ í—ˆìš©í•©ë‹ˆë‹¤.

H2 ì›¹ ì½˜ì†”ì˜ í™”ë©´ ìì²´ê°€ ë‚´ë¶€ì ìœ¼ë¡œ íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë¯€ë¡œ ê°œë°œ í™˜ê²½ì—ì„œëŠ” H2 ì›¹ ì½˜ì†”ì„ ì •ìƒì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ (1)ê³¼ ê°™ì´ ì„¤ì •í•˜ë©´ ë©ë‹ˆë‹¤.

Clickjacking ê³µê²©ì— ëŒ€í•´ì„œ ë” ì•Œì•„ë³´ê³  ì‹¶ì€ ë¶„ì€ ì•„ë˜ì˜ [ì‹¬í™” í•™ìŠµ]ì„ ì°¸ê³ í•˜ì„¸ìš”.


(2)ì˜ userDetailsService() ë©”ì„œë“œëŠ” InMemory Userë¥¼ ë“±ë¡í•˜ëŠ” ì—­í• ì„ í•˜ì§€ë§Œ ì´ì œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ Userë¥¼ ë“±ë¡í•˜ê³ , ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœ Userì˜ ì¸ì¦ ì •ë³´ë¥¼ ì‚¬ìš©í•  ê²ƒì´ë¯€ë¡œ userDetailsService() ë©”ì„œë“œë¥¼ ì œê±°í•©ë‹ˆë‹¤.


2ï¸âƒ£ JavaConfigurationì˜ Bean ë“±ë¡ ë³€ê²½

```java
@Configuration
public class JavaConfiguration {
    // (1)
    @Bean
    public MemberService dbMemberService(MemberRepository memberRepository,
                                         PasswordEncoder passwordEncoder) {
        return new DBMemberService(memberRepository, passwordEncoder); (1-1)
    }
}
```
[ì½”ë“œ 4-23] ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë³€ê²½ëœ JavaConfiguration í´ë˜ìŠ¤


ì½”ë“œ 4-23ì˜ (1)ê³¼ ê°™ì´ ë°ì´í„°ë² ì´ìŠ¤ì— Userì˜ ì •ë³´ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•´ MemberService ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ DBMemberServiceë¡œ ë³€ê²½í•©ë‹ˆë‹¤.

DBMemberServiceëŠ” ë‚´ë¶€ì—ì„œ ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê³ , íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•´ì•¼ í•˜ë¯€ë¡œ (1-1)ê³¼ ê°™ì´ MemberRepositoryì™€ PasswordEncoder ê°ì²´ë¥¼ DI í•´ì¤ë‹ˆë‹¤.



3ï¸âƒ£ DBMemberService êµ¬í˜„

ì´ì œ DBMemberServiceë¥¼ êµ¬í˜„í•´ ë³´ê² ìŠµë‹ˆë‹¤.


DBMemberServiceëŠ” Userì˜ ì¸ì¦ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” ì—­í• ì„ í•˜ëŠ”ë°, ì•ì—ì„œë„ ì–¸ê¸‰í–ˆì§€ë§Œ Spring Security ì…ì¥ì—ì„œ Userë¼ê³  ë¶€ë¥´ëŠ” ì •ë³´ëŠ” ìš°ë¦¬ê°€ íšŒì› ê°€ì… ì‹œ ë“±ë¡í•˜ëŠ” íšŒì› ì •ë³´ ì•ˆì— í¬í•¨ì´ ë˜ì–´ ìˆë‹¤ê³  ë³´ë©´ ë©ë‹ˆë‹¤.


ì—¬ëŸ¬ë¶„ë“¤ì´ Spring MVC ì„¹ì…˜ì—ì„œ ì‚¬ìš©í–ˆë˜ Member ì—”í‹°í‹° í´ë˜ìŠ¤ë¥¼ ìƒê°í•´ ë³´ì„¸ìš”. ì´ Member ì—”í‹°í‹° í´ë˜ìŠ¤ì˜ í•„ë“œì— ì¸ì¦ ì •ë³´ë¥¼ ë‹´ëŠ” password í•„ë“œê°€ í¬í•¨ëœë‹¤ê³  ìƒê°í•˜ë©´ ë˜ê² ìŠµë‹ˆë‹¤.


```java
package com.codestates.member;

import com.codestates.exception.BusinessLogicException;
import com.codestates.exception.ExceptionCode;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.transaction.annotation.Transactional;

import java.util.Optional;

@Transactional
public class DBMemberService implements MemberService {
    private final MemberRepository memberRepository;
    private final PasswordEncoder passwordEncoder;

    // (1)
    public DBMemberService(MemberRepository memberRepository,
                             PasswordEncoder passwordEncoder) {
        this.memberRepository = memberRepository;
        this.passwordEncoder = passwordEncoder;
    }

    public Member createMember(Member member) {
        verifyExistsEmail(member.getEmail());
        String encryptedPassword = passwordEncoder.encode(member.getPassword());  // (2)
        member.setPassword(encryptedPassword);    // (3)

        Member savedMember = memberRepository.save(member);

        System.out.println("# Create Member in DB");
        return savedMember;
    }
    
    ...
    ...
}
```
[ì½”ë“œ 4-24] íšŒì› ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ë“±ë¡í•˜ëŠ” DBMemberService í´ë˜ìŠ¤


ì½”ë“œ 4-24ëŠ” íšŒì› ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” DBMemberService í´ë˜ìŠ¤ì˜ ì½”ë“œì…ë‹ˆë‹¤.


ì½”ë“œ ì„¤ëª…ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

(1)ì˜ ìƒì„±ìë¥¼ í†µí•´ MemberRepositoryì™€ PasswordEncoder Bean ê°ì²´ë¥¼ DI ë°›ìŠµë‹ˆë‹¤.

(2)ì—ì„œ PasswordEncoderë¥¼ ì´ìš©í•´ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•©ë‹ˆë‹¤.

(3)ì—ì„œ ì•”í˜¸í™”ëœ íŒ¨ìŠ¤ì›Œë“œë¥¼ password í•„ë“œì— ë‹¤ì‹œ í• ë‹¹í•©ë‹ˆë‹¤.


ì´ ì™¸ì— ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ì—¬ëŸ¬ë¶„ë“¤ì´ Spring Data JPA ì‹œê°„ì— í•™ìŠµí–ˆë˜ ì½”ë“œë“¤ì´ê¸° ë•Œë¬¸ì— ì„¤ëª…ì€ ìƒëµí•˜ê² ìŠµë‹ˆë‹¤.


â­ íŒ¨ìŠ¤ì›Œë“œì˜ ì•”í˜¸í™”

íšŒì›ì˜ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” ê±´ ê°œë°œì ì…ì¥ì—ì„œëŠ” ì •ë§ ë‹¹ì—°í•œ ì´ì•¼ê¸°ì¸ë°ë„ ë¶ˆêµ¬í•˜ê³ , íšŒì› ë“±ë¡ ë¡œì§ì„ êµ¬í˜„í•  ë•Œ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì•”í˜¸í™”í•˜ì§€ ì•Šê³  í‰ë¬¸(Plain Text) ê·¸ëŒ€ë¡œ ì €ì¥í•˜ëŠ” ê²½ìš°ëŠ” ì‹¤ë¬´ì—ì„œë„ ì¢…ì¢… ë³¼ ìˆ˜ ìˆëŠ” ì¼ì…ë‹ˆë‹¤.

íŒ¨ìŠ¤ì›Œë“œ ê°™ì€ ë¯¼ê°í•œ(sensitive) ì •ë³´ëŠ” ë°˜ë“œì‹œ ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

ê¼­ ìŠì§€ ë§ì•„ ì£¼ì„¸ìš”!

ê·¸ë¦¬ê³  íŒ¨ìŠ¤ì›Œë“œëŠ” ì•”í˜¸í™”ëœ ìƒíƒœì—ì„œ ë³µí˜¸í™”í•  ì´ìœ ê°€ ì—†ìœ¼ë¯€ë¡œ ë‹¨ë°©í–¥ ì•”í˜¸í™” ë°©ì‹ìœ¼ë¡œ ì•”í˜¸í™”ë˜ì–´ì•¼ í•œë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¼­ ê¸°ì–µí•˜ì„¸ìš”!

ë‹¨ë°©í–¥ ì•”í˜¸í™”ì— ëŒ€í•´ì„œ ë” ì•Œì•„ë³´ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ì˜ [ì‹¬í™” í•™ìŠµ]ì„ ì°¸ê³ í•˜ì„¸ìš”.



4ï¸âƒ£ Custom UserDetailsService êµ¬í˜„

ë‹¤ìŒìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•œ Userì˜ ì¸ì¦ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” Custom UserDetailsServiceë¥¼ êµ¬í˜„í•´ ë´…ì‹œë‹¤.


â­ UserDetailsService

Spring Securityì—ì„œ ì œê³µí•˜ëŠ” ì»´í¬ë„ŒíŠ¸ ì¤‘ í•˜ë‚˜ì¸ UserDetailsServiceëŠ” User ì •ë³´ë¥¼ ë¡œë“œ(load)í•˜ëŠ” í•µì‹¬ ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.

ì—¬ê¸°ì„œ ë¡œë“œ(load)ì˜ ì˜ë¯¸ëŠ” ì¸ì¦ì— í•„ìš”í•œ User ì •ë³´ë¥¼ ì–´ë”˜ê°€ì—ì„œ ê°€ì§€ê³  ì˜¨ë‹¤ëŠ” ì˜ë¯¸ì´ë©°, ì—¬ê¸°ì„œ ë§í•˜ëŠ” â€˜ì–´ë”˜ê°€â€™ëŠ” ë©”ëª¨ë¦¬ê°€ ë  ìˆ˜ë„ ìˆê³ , DB ë“±ì˜ ì˜êµ¬ ì €ì¥ì†Œê°€ ë  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

ìš°ë¦¬ê°€ InMemory Userë¥¼ ë“±ë¡í•˜ëŠ” ë° ì‚¬ìš©í–ˆë˜ InMemoryUserDetailsManagerëŠ” UserDetailsManager ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ì´ê³ , UserDetailsManagerëŠ” UserDetailsServiceë¥¼ ìƒì†í•˜ëŠ” í™•ì¥ ì¸í„°í˜ì´ìŠ¤ë¼ëŠ” ì  ê¸°ì–µí•˜ê¸°ë¥¼ ë°”ëë‹ˆë‹¤.



âœ” HelloUserDetailsService

```java
package com.codestates.auth;

import com.codestates.auth.utils.HelloAuthorityUtils;
import com.codestates.exception.BusinessLogicException;
import com.codestates.exception.ExceptionCode;
import com.codestates.member.Member;
import com.codestates.member.MemberRepository;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Component;

import java.util.Collection;
import java.util.Optional;

@Component
public class HelloUserDetailsServiceV1 implements UserDetailsService {   // (1)
    private final MemberRepository memberRepository;
    private final HelloAuthorityUtils authorityUtils;

    // (2)
    public HelloUserDetailsServiceV1(MemberRepository memberRepository, HelloAuthorityUtils authorityUtils) {
        this.memberRepository = memberRepository;
        this.authorityUtils = authorityUtils;
    }

    // (3)
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        Optional<Member> optionalMember = memberRepository.findByEmail(username);
        Member findMember = optionalMember.orElseThrow(() -> new BusinessLogicException(ExceptionCode.MEMBER_NOT_FOUND));

        // (4)
        Collection<? extends GrantedAuthority> authorities = authorityUtils.createAuthorities(findMember.getEmail());

        // (5)   
        return new User(findMember.getEmail(), findMember.getPassword(), authorities);
    }
}
```
[ì½”ë“œ 4-25] ë°ì´í„°ë² ì´ìŠ¤ì˜ ì¸ì¦ ì •ë³´ë¡œ ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” Custom UserDetailsService


ì½”ë“œ 4-25ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•œ ì¸ì¦ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” Custom UserDetailsServiceì¸ HelloUserDetailsService í´ë˜ìŠ¤ì˜ ì½”ë“œì…ë‹ˆë‹¤.


ì½”ë“œì˜ ì„¤ëª…ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

HelloUserDetailsServiceì™€ ê°™ì€ Custom UserDetailsServiceë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” (1)ê³¼ ê°™ì´ UserDetailsService ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.
HelloUserDetailsServiceëŠ” V1 ~ V3ê¹Œì§€ ë§Œë“¤ì–´ì§€ê¸° ë•Œë¬¸ì— ê°ê° í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.
HelloUserDetailsServiceëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ Userë¥¼ ì¡°íšŒí•˜ê³ , ì¡°íšŒí•œ Userì˜ ê¶Œí•œ(Role) ì •ë³´ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ (2)ì™€ ê°™ì´ MemberRepositoryì™€ HelloAuthorityUtils í´ë˜ìŠ¤ë¥¼ DI ë°›ìŠµë‹ˆë‹¤.

UserDetailsService ì¸í„°í˜ì´ìŠ¤ë¥¼ implements í•˜ëŠ” êµ¬í˜„ í´ë˜ìŠ¤ëŠ” (3)ê³¼ ê°™ì´ loadUserByUsername(String username)ì´ë¼ëŠ” ì¶”ìƒ ë©”ì„œë“œë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.

(4)ì—ì„œëŠ” HelloAuthorityUtilsë¥¼ ì´ìš©í•´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•œ íšŒì›ì˜ ì´ë©”ì¼ ì •ë³´ë¥¼ ì´ìš©í•´ Role ê¸°ë°˜ì˜ ê¶Œí•œ ì •ë³´(GrantedAuthority) ì»¬ë ‰ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤. (HelloAuthorityUtils ì½”ë“œëŠ” ë°”ë¡œ ì•„ë˜ì—ì„œ ì„¤ëª…í•©ë‹ˆë‹¤)

ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•œ ì¸ì¦ ì •ë³´ì™€ (4)ì—ì„œ ìƒì„±í•œ ê¶Œí•œ ì •ë³´ë¥¼ Spring Securityì—ì„œëŠ” ì•„ì§ ì•Œì§€ ëª»í•˜ê¸° ë•Œë¬¸ì— Spring Securityì— ì´ ì •ë³´ë“¤ì„ ì œê³µí•´ ì£¼ì–´ì•¼ í•˜ë©°, (5)ì—ì„œëŠ” UserDetails ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ì¸ User í´ë˜ìŠ¤ì˜ ê°ì²´ë¥¼ í†µí•´ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤.

(5)ì™€ ê°™ì´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•œ User í´ë˜ìŠ¤ì˜ ê°ì²´ë¥¼ ë¦¬í„´í•˜ë©´ Spring Securityê°€ ì´ ì •ë³´ë¥¼ ì´ìš©í•´ ì¸ì¦ ì ˆì°¨ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

â­ ì¦‰, ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ Userì˜ ì¸ì¦ ì •ë³´ë§Œ Spring Securityì— ë„˜ê²¨ì£¼ê³ , ì¸ì¦ ì²˜ë¦¬ëŠ” Spring Securityê°€ ëŒ€ì‹ í•´ ì¤ë‹ˆë‹¤.


â­ UserDetails

UserDetailsëŠ” UserDetailsServiceì— ì˜í•´ ë¡œë“œ(load)ë˜ì–´ ì¸ì¦ì„ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” í•µì‹¬ User ì •ë³´ë¥¼ í‘œí˜„í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.

UserDetails ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ëŠ” Spring Securityì—ì„œ ë³´ì•ˆ ì •ë³´ ì œê³µì„ ëª©ì ìœ¼ë¡œ ì§ì ‘ ì‚¬ìš©ë˜ì§€ëŠ” ì•Šê³ , Authentication ê°ì²´ë¡œ ìº¡ìŠí™”ë˜ì–´ ì œê³µë©ë‹ˆë‹¤.



âœ” HelloAuthorityUtils

```java
package com.codestates.auth.utils;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.AuthorityUtils;
import org.springframework.stereotype.Component;
import java.util.List;

@Component
public class HelloAuthorityUtils {
    // (1)
    @Value("${mail.address.admin}")
    private String adminMailAddress;

    // (2)
    private final List<GrantedAuthority> ADMIN_ROLES = AuthorityUtils.createAuthorityList("ROLE_ADMIN", "ROLE_USER");

    // (3)
    private final List<GrantedAuthority> USER_ROLES = AuthorityUtils.createAuthorityList("ROLE_USER");
    
    public List<GrantedAuthority> createAuthorities(String email) {
        // (4)
        if (email.equals(adminMailAddress)) {
            return ADMIN_ROLES;
        }
        return USER_ROLES;
    }
}
```
[ì½”ë“œ 4-26] Userì˜ ê¶Œí•œì„ ë§¤í•‘, ìƒì„±í•˜ëŠ” HelloAuthorityUtils


ì½”ë“œ 4-26ì€ HelloUserDetailsService(ì½”ë“œ 4-25)ì—ì„œ Role ê¸°ë°˜ì˜ User ê¶Œí•œì„ ìƒì„±í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•œ HelloAuthorityUtils ì½”ë“œì…ë‹ˆë‹¤.


ì½”ë“œì˜ ì„¤ëª…ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

(1)ì€ application.ymlì— ì¶”ê°€í•œ í”„ë¡œí¼í‹°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í‘œí˜„ì‹ì…ë‹ˆë‹¤.

(1)ê³¼ ê°™ì´ @Value("${í”„ë¡œí¼í‹° ê²½ë¡œ}")ì˜ í‘œí˜„ì‹ í˜•íƒœë¡œ ì‘ì„±í•˜ë©´ application.ymlì— ì •ì˜ë˜ì–´ ìˆëŠ” í”„ë¡œí¼í‹°ì˜ ê°’ì„ í´ë˜ìŠ¤ ë‚´ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

(1)ì—ì„œëŠ” application.ymlì— ë¯¸ë¦¬ ì •ì˜í•œ ê´€ë¦¬ì ê¶Œí•œì„ ê°€ì§ˆ ìˆ˜ ìˆëŠ” ì´ë©”ì¼ ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.

application.yml íŒŒì¼ì— ì •ì˜í•œ ê´€ë¦¬ììš© ì´ë©”ì¼ ì£¼ì†ŒëŠ” íšŒì› ë“±ë¡ ì‹œ, íŠ¹ì • ì´ë©”ì¼ ì£¼ì†Œì— ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìˆëŠ”ì§€ë¥¼ ê²°ì •í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤. (4)ì—ì„œ ë‹¤ì‹œ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.

ğŸ’¡ application.yml íŒŒì¼ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ê´€ë¦¬ì ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì •ì˜í•´ì•¼ í•©ë‹ˆë‹¤.

```yml
...
...

mail:
  address:
    admin: admin@gmail.com
```

(2)ì—ì„œëŠ” Spring Securityì—ì„œ ì§€ì›í•˜ëŠ” AuthorityUtils í´ë˜ìŠ¤ë¥¼ ì´ìš©í•´ì„œ ê´€ë¦¬ììš© ê¶Œí•œ ëª©ë¡ì„ List<GrantedAuthority> ê°ì²´ë¡œ ë¯¸ë¦¬ ìƒì„±í•©ë‹ˆë‹¤.

ê´€ë¦¬ì ê¶Œí•œì˜ ê²½ìš°, ì¼ë°˜ ì‚¬ìš©ìì˜ ê¶Œí•œê¹Œì§€ ì¶”ê°€ë¡œ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

(3)ì—ì„œëŠ” Spring Securityì—ì„œ ì§€ì›í•˜ëŠ” AuthorityUtils í´ë˜ìŠ¤ë¥¼ ì´ìš©í•´ì„œ ì¼ë°˜ ì‚¬ìš© ê¶Œí•œ ëª©ë¡ì„ List<GrantedAuthority> ê°ì²´ë¡œ ë¯¸ë¦¬ ìƒì„±í•©ë‹ˆë‹¤.

(4)ì—ì„œëŠ” íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ë°›ì€ ì´ë©”ì¼ ì£¼ì†Œê°€ application.yml íŒŒì¼ì—ì„œ ê°€ì ¸ì˜¨ ê´€ë¦¬ììš© ì´ë©”ì¼ ì£¼ì†Œì™€ ë™ì¼í•˜ë‹¤ë©´ ê´€ë¦¬ììš© ê¶Œí•œì¸ List<GrantedAuthority> ADMIN_ROLESë¥¼ ë¦¬í„´í•©ë‹ˆë‹¤.


â­ ì‹¤ë¬´ì—ì„œëŠ” ë‹¹ì—°íˆ íšŒì› ê°€ì… ì‹œ, ì•„ë¬´ëŸ° ì¸ì¦ ì¥ì¹˜ë„ ì—†ì´ ì´ë©”ì¼ ì£¼ì†Œë§Œ ì…ë ¥í•´ì„œ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.

ê´€ë¦¬ì ê¶Œí•œì€ ì•„ë¬´ë¦¬ ê°•ì¡°í•´ë„ ì§€ë‚˜ì¹˜ì§€ ì•Šì„ ì •ë„ë¡œ ì¤‘ìš”í•˜ë‹ˆê¹Œìš”. ğŸ˜Š

ì•„ë§ˆë„ ê´€ë¦¬ìë¡œì„œ ë“±ë¡í•˜ê¸° ìœ„í•œ ì¶”ê°€ì ì¸ ì¸ì¦ ì ˆì°¨ê°€ ìˆì„ ê²ƒì…ë‹ˆë‹¤.

ìš°ë¦¬ëŠ” í•™ìŠµ ëª©ì ì´ë¯€ë¡œ í¸ì˜ìƒ ì´ë ‡ê²Œ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•œë‹¤ëŠ” ì‚¬ì‹¤ì„ ìŠì§€ ë§ˆì„¸ìš”!



5ï¸âƒ£ H2 ì›¹ ì½˜ì†”ì—ì„œ ë“±ë¡í•œ íšŒì› ì •ë³´ í™•ì¸ ë° ë¡œê·¸ì¸ ì¸ì¦ í…ŒìŠ¤íŠ¸

ì—¬ëŸ¬ë¶„ë“¤ì´ ì—¬ê¸°ê¹Œì§€ íƒ€ì´í•‘ì„ ì˜í–ˆë‹¤ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í›„, íšŒì› ê°€ì… ë©”ë‰´ì—ì„œ íšŒì›ì„ ë“±ë¡í•œ ë’¤ì— H2 ì›¹ ì½˜ì†”(http://localhost:8080/h2)ì— ì ‘ì†í•´ì„œ ì—¬ëŸ¬ë¶„ì´ ë“±ë¡í•œ íšŒì› ì •ë³´ë¥¼ í™•ì¸í•´ ë³´ì„¸ìš”.


ì•„ë˜ì˜ [ê·¸ë¦¼ 4-10]ê³¼ ë¹„ìŠ·í•œ í™”ë©´ì„ ë³¼ ìˆ˜ ìˆì„ ê²ë‹ˆë‹¤.



[ê·¸ë¦¼ 4-10] ì¸ì¦ ì •ë³´ê°€ í¬í•¨ëœ ë“±ë¡ëœ íšŒì› ì •ë³´


ìš°ë¦¬ê°€ ì—¬íƒœê» ì‚¬ìš©í•´ ë´¤ë˜ MEMBERì™€ í° ì°¨ì´ì ì€ ì—†ìŠµë‹ˆë‹¤.

ê·¸ëŸ°ë° [ê·¸ë¦¼ 4-10]ì—ì„œ ì£¼ëª©í•  ë¶€ë¶„ì€ ë§¨ ë§ˆì§€ë§‰ ì—´ì¸ PASSWORD ì—´ì„ ë³´ë©´ íšŒì› ê°€ì… ë©”ë‰´ì—ì„œ ì…ë ¥í–ˆë˜ íŒ¨ìŠ¤ì›Œë“œ ì •ë³´ê°€ ì•”í˜¸í™” ë˜ì–´ìˆë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.


íšŒì›ì˜ ì¸ì¦ ì •ë³´ë„ ì˜ ë“±ë¡ë˜ì–´ ìˆìœ¼ë‹ˆ ì´ì œ ë¡œê·¸ì¸ í™”ë©´ì—ì„œ ë“±ë¡í•œ íšŒì›ì˜ ì´ë©”ì¼ ì£¼ì†Œì™€ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì´ìš©í•´ ë¡œê·¸ì¸ í•´ë³´ë©´ ì •ìƒì ìœ¼ë¡œ ë¡œê·¸ì¸ì´ ë˜ëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


application.yml íŒŒì¼ì— ì •ì˜ë˜ì–´ ìˆëŠ” ê´€ë¦¬ììš© ì´ë©”ì¼ ì£¼ì†Œ(admin@gmail.com)ë¡œë„ íšŒì› ê°€ì…ì„ í•œ í›„, ë¡œê·¸ì¸ì´ ì˜ ë˜ëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”! ğŸ˜Š



6ï¸âƒ£ Custom UserDetails êµ¬í˜„

ì§€ê¸ˆê» ì‘ì„±í•œ ì½”ë“œë§Œìœ¼ë¡œë„ ë°ì´í„°ë² ì´ìŠ¤ì— íšŒì›ì˜ ì¸ì¦ ì •ë³´ë¥¼ ì €ì¥í•˜ê³ , ì €ì¥ëœ ì¸ì¦ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¡œê·¸ì¸ ì¸ì¦ì„ í•˜ëŠ” ë° í° ë¬¸ì œëŠ” ì—†ìŠµë‹ˆë‹¤.


í•˜ì§€ë§Œ ìš°ë¦¬ëŠ” ì¡°ê¸ˆ ë” ìœ ì—°í•˜ê³  ê¹”ë”í•œ ì½”ë“œì˜ êµ¬ì„±ì„ ìœ„í•´ ì•ì—ì„œ ì‘ì„±í•œ HelloUserDetailsService í´ë˜ìŠ¤ë¥¼ ì‚´ì§ ê°œì„ í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.


âœ” í˜„ì¬ê¹Œì§€ ì‘ì„±ëœ HelloUserDetailsService(V1)

```java
package com.codestates.auth;

import com.codestates.auth.utils.HelloAuthorityUtils;
import com.codestates.exception.BusinessLogicException;
import com.codestates.exception.ExceptionCode;
import com.codestates.member.Member;
import com.codestates.member.MemberRepository;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Component;

import java.util.Collection;
import java.util.Optional;

@Component
public class HelloUserDetailsServiceV1 implements UserDetailsService {
    private final MemberRepository memberRepository;
    private final HelloAuthorityUtils authorityUtils;

    public HelloUserDetailsServiceV1(MemberRepository memberRepository, HelloAuthorityUtils authorityUtils) {
        this.memberRepository = memberRepository;
        this.authorityUtils = authorityUtils;
    }

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        Optional<Member> optionalMember = memberRepository.findByEmail(username);
        Member findMember = optionalMember.orElseThrow(() -> new BusinessLogicException(ExceptionCode.MEMBER_NOT_FOUND));
        Collection<? extends GrantedAuthority> authorities = authorityUtils.createAuthorities(findMember);

        // (1) ê°œì„ í•˜ë©´ ì¢‹ì€ í¬ì¸íŠ¸
        return new User(findMember.getEmail(), findMember.getPassword(), authorities);
    }
}
```
[ì½”ë“œ 4-27] í˜„ì¬ê¹Œì§€ ì‘ì„±ëœ HelloUserDetailsService(V1)


ì½”ë“œ 4-27ì€ í˜„ì¬ê¹Œì§€ ì‘ì„±ëœ HelloUserDetailsServiceì˜ ì½”ë“œì…ë‹ˆë‹¤.

ì—¬ê¸°ì„œ ê°œì„ í•˜ë©´ ì¢‹ì€ ë¶€ë¶„ì€ ë°”ë¡œ (1)ê³¼ ê°™ì´ UserDetailsì˜ êµ¬í˜„ í´ë˜ìŠ¤ì¸ Userì˜ ê°ì²´ë¥¼ ì§ì ‘ì ìœ¼ë¡œ ìƒì„±í•´ì„œ ë¦¬í„´í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.


ì´ ë¶€ë¶„ì„ ì¡°ê¸ˆ ë” ìœ ì—°í•˜ê³  ê¹”ë”í•˜ê²Œ ì‘ì„±í•´ ë³´ë„ë¡ í•©ì‹œë‹¤!



âœ” ê°œì„ ëœ HelloUserDetailsService(V2)

```java
package com.codestates.auth;

import com.codestates.auth.utils.HelloAuthorityUtils;
import com.codestates.exception.BusinessLogicException;
import com.codestates.exception.ExceptionCode;
import com.codestates.member.Member;
import com.codestates.member.MemberRepository;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Component;

import java.util.Collection;
import java.util.Optional;

@Component
public class HelloUserDetailsServiceV2 implements UserDetailsService {
    private final MemberRepository memberRepository;
    private final HelloAuthorityUtils authorityUtils;

    public HelloUserDetailsServiceV2(MemberRepository memberRepository, HelloAuthorityUtils authorityUtils) {
        this.memberRepository = memberRepository;
        this.authorityUtils = authorityUtils;
    }

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        Optional<Member> optionalMember = memberRepository.findByEmail(username);
        Member findMember = optionalMember.orElseThrow(() -> new BusinessLogicException(ExceptionCode.MEMBER_NOT_FOUND));

        return new HelloUserDetails(findMember);  // (1) ê°œì„ ëœ ë¶€ë¶„
    }

    // (2) HelloUserDetails í´ë˜ìŠ¤ ì¶”ê°€
    private final class HelloUserDetails extends Member implements UserDetails { // (2-1)
        // (2-2)
        HelloUserDetails(Member member) {
            setMemberId(member.getMemberId());
            setFullName(member.getFullName());
            setEmail(member.getEmail());
            setPassword(member.getPassword());
        }

        @Override
        public Collection<? extends GrantedAuthority> getAuthorities() {
            return authorityUtils.createAuthorities(this.getEmail());  // (2-3) ë¦¬íŒ©í† ë§ í¬ì¸íŠ¸
        }

        // (2-4)
        @Override
        public String getUsername() {
            return getEmail();
        }

        @Override
        public boolean isAccountNonExpired() {
            return true;
        }

        @Override
        public boolean isAccountNonLocked() {
            return true;
        }

        @Override
        public boolean isCredentialsNonExpired() {
            return true;
        }

        @Override
        public boolean isEnabled() {
            return true;
        }
    }

}
```
[ì½”ë“œ 4-28] ìœ ì—°í•˜ê²Œ ê°œì„ ëœ HelloUserDetailsService(V2)


ì½”ë“œ 4-28ì€ ì½”ë“œ 4-27ì˜ ì½”ë“œë¥¼ ê°œì„ í•œ HelloUserDetailsService(V2)ì˜ ì½”ë“œì…ë‹ˆë‹¤.


ê¸°ì¡´ì—ëŠ” loadUserByUsername() ë©”ì„œë“œì˜ ë¦¬í„´ ê°’ìœ¼ë¡œ new User(findMember.getEmail(), findMember.getPassword(), authorities);ì„ ë¦¬í„´í–ˆì§€ë§Œ ê°œì„ ëœ ì½”ë“œì—ì„œëŠ” (1)ê³¼ ê°™ì´ new HelloUserDetails(findMember);ë¼ëŠ” Custom UserDetails í´ë˜ìŠ¤ì˜ ìƒì„±ìë¡œ findMemberë¥¼ ì „ë‹¬í•˜ë©´ì„œ ì½”ë“œê°€ ì¡°ê¸ˆ ë” ê¹”ë”í•´ì¡ŒìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  ì½”ë“œë¥¼ ìœ ì‹¬íˆ ë³´ë©´ ê¸°ì¡´ì—ëŠ” loadUserByUsername() ë©”ì„œë“œ ë‚´ë¶€ì—ì„œ Userì˜ ê¶Œí•œ ì •ë³´ë¥¼ ìƒì„±í•˜ëŠ” Collection<? extends GrantedAuthority> authorities = authorityUtils.createAuthorities(findMember); ì½”ë“œê°€ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.

ì´ ì½”ë“œëŠ” ì–´ë””ë¡œ ê°”ì„ê¹Œìš”?

ë°”ë¡œ (2)ì—ì„œ ì •ì˜í•œ HelloUserDetails í´ë˜ìŠ¤ ë‚´ë¶€ë¡œ í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤.


(2)ì˜ HelloUserDetails í´ë˜ìŠ¤ëŠ” UserDetails ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê³  ìˆê³  ë˜í•œ Member ì—”í‹°í‹° í´ë˜ìŠ¤ë¥¼ ìƒì†í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ğŸ’¡ ì´ë ‡ê²Œ êµ¬ì„±í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•œ íšŒì› ì •ë³´ë¥¼ Spring Securityì˜ User ì •ë³´ë¡œ ë³€í™˜í•˜ëŠ” ê³¼ì •ê³¼ Userì˜ ê¶Œí•œ ì •ë³´ë¥¼ ìƒì„±í•˜ëŠ” ê³¼ì •ì„ ìº¡ìŠí™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ğŸ’¡ ë˜í•œ HelloUserDetails í´ë˜ìŠ¤ëŠ” Member ì—”í‹°í‹° í´ë˜ìŠ¤ë¥¼ ìƒì†í•˜ê³  ìˆìœ¼ë¯€ë¡œ HelloUserDetailsë¥¼ ë¦¬í„´ ë°›ì•„ ì‚¬ìš©í•˜ëŠ” ì¸¡ì—ì„œëŠ” ë‘ ê°œ í´ë˜ìŠ¤ì˜ ê°ì²´ë¥¼ ëª¨ë‘ ë‹¤ ì†ì‰½ê²Œ ìºìŠ¤íŒ…í•´ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤ëŠ” ì¥ì ì´ ìˆìŠµë‹ˆë‹¤.


(2-3)ì—ì„œëŠ” HelloAuthorityUtilsì˜ createAuthorities() ë©”ì„œë“œë¥¼ ì´ìš©í•´ Userì˜ ê¶Œí•œ ì •ë³´ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ì´ ì½”ë“œëŠ” ê¸°ì¡´ì—ëŠ” loadUserByUsername() ë©”ì„œë“œ ë‚´ë¶€ì— ìˆì—ˆì§€ë§Œ ì§€ê¸ˆì€ HelloUserDetails í´ë˜ìŠ¤ ë‚´ë¶€ì—ì„œ ì‚¬ìš©ë˜ë„ë¡ ìº¡ìŠí™”ë˜ì—ˆìŠµë‹ˆë‹¤.


(2-4)ì—ì„œëŠ” Spring Securityì—ì„œ ì¸ì‹í•  ìˆ˜ ìˆëŠ” usernameì„ Member í´ë˜ìŠ¤ì˜ email ì£¼ì†Œë¡œ ì±„ìš°ê³  ìˆìŠµë‹ˆë‹¤. getUsername()ì˜ ë¦¬í„´ ê°’ì€ nullì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ê¸°íƒ€ UserDetails ì¸í„°í˜ì´ìŠ¤ì˜ ì¶”ìƒ ë©”ì„œë“œë¥¼ êµ¬í˜„í•œ ë¶€ë¶„ì€ ì§€ê¸ˆì€ í¬ê²Œ ì¤‘ìš”í•˜ì§€ ì•Šì€ ë¶€ë¶„ì´ë¯€ë¡œ ëª¨ë‘ trueê°’ì„ ë¦¬í„´í•˜ê³  ìˆìŠµë‹ˆë‹¤.


7ï¸âƒ£ Userì˜ Roleì„ DBì—ì„œ ê´€ë¦¬í•˜ê¸°

ì, ì—¬ëŸ¬ë¶„ ì´ì œ Custom UserDetailsServiceë¥¼ ì´ìš©í•œ ë¡œê·¸ì¸ ì¸ì¦ì˜ ë§ˆì§€ë§‰ ë‹¨ê³„ì…ë‹ˆë‹¤.


ì¼ë°˜ì ìœ¼ë¡œ Userì˜ ì¸ì¦ ì •ë³´ ê°™ì€ ë³´ì•ˆê³¼ ê´€ë ¨ëœ ì •ë³´ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ê°™ì€ ì˜êµ¬ ì €ì¥ì†Œì— ì•ˆì „í•˜ê²Œ ë³´ê´€í•©ë‹ˆë‹¤.


ê·¸ëŸ°ë° í˜„ì¬ê¹Œì§€ Userì˜ ê¶Œí•œ ì •ë³´ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•œ User ì •ë³´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì½”ë“œìƒì—ì„œ ì¡°ê±´ì— ë§ê²Œ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.


ì´ì œ Userì˜ ê¶Œí•œ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê´€ë¦¬í•˜ë„ë¡ ì½”ë“œë¥¼ ìˆ˜ì •í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.


Userì˜ ê¶Œí•œ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê´€ë¦¬í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.

Userì˜ ê¶Œí•œ ì •ë³´ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ í…Œì´ë¸” ìƒì„±

íšŒì› ê°€ì… ì‹œ, Userì˜ ê¶Œí•œ ì •ë³´(Role)ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” ì‘ì—…

ë¡œê·¸ì¸ ì¸ì¦ ì‹œ, Userì˜ ê¶Œí•œ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•˜ëŠ” ì‘ì—…


ì´ ì„¸ ê°€ì§€ ê³¼ì •ì„ í•˜ë‚˜ì”© ì ìš©í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.



âœ” Userì˜ ê¶Œí•œ ì •ë³´ í…Œì´ë¸” ìƒì„±

Userì˜ ê¶Œí•œ ì •ë³´ í…Œì´ë¸”ì„ ìƒì„±í•˜ê¸° ì „ì— Userì™€ Userì˜ ê¶Œí•œ ì •ë³´ ê°„ì— ê´€ê³„ë¥¼ ë¨¼ì € ìƒê°í•´ì•¼ í•©ë‹ˆë‹¤.


ì—¬ê¸°ì„œ ì˜ë¯¸í•˜ëŠ” â€˜ê´€ê³„â€™ëŠ” í…Œì´ë¸” ê°„ì˜ ì—°ê´€ ê´€ê³„ë¥¼ ì˜ë¯¸í•˜ë©°, ì´ í…Œì´ë¸” ê°„ì˜ ì—°ê´€ ê´€ê³„ëŠ” ìš°ë¦¬ê°€ ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©í•˜ê³  ìˆëŠ” ORM ê¸°ìˆ ì¸ JPAë¥¼ í†µí•´ ì†ì‰½ê²Œ ì—°ê´€ ê´€ê³„ë¥¼ ë§ºì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


ì´ì œ JPAë¥¼ ì´ìš©í•´ì„œ Userì™€ Userì˜ ê¶Œí•œ ì •ë³´ ê°„ì— ì—°ê´€ ê´€ê³„ë¥¼ ë§ºì–´ë³´ê² ìŠµë‹ˆë‹¤.


Member

```java
package com.codestates.member;

import com.codestates.audit.Auditable;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import javax.persistence.*;
import java.security.Principal;
import java.util.ArrayList;
import java.util.List;

@NoArgsConstructor
@Getter
@Setter
@Entity
public class Member extends Auditable implements Principal{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long memberId;

    @Column(length = 100, nullable = false)
    private String fullName;

    @Column(nullable = false, updatable = false, unique = true)
    private String email;

    @Column(length = 100, nullable = false)
    private String password;

    @Enumerated(value = EnumType.STRING)
    @Column(length = 20, nullable = false)
    private MemberStatus memberStatus = MemberStatus.MEMBER_ACTIVE;

    // (1) Userì˜ ê¶Œí•œ ì •ë³´ í…Œì´ë¸”ê³¼ ë§¤í•‘ë˜ëŠ” ì •ë³´
    @ElementCollection(fetch = FetchType.EAGER)
    private List<String> roles = new ArrayList<>();

    public Member(String email) {
        this.email = email;
    }

    public Member(String email, String fullName, String password) {
        this.email = email;
        this.fullName= fullName;
        this.password = password;
    }

    @Override
    public String getName() {
        return getEmail();
    }

    public enum MemberStatus {
        MEMBER_ACTIVE("í™œë™ì¤‘"),
        MEMBER_SLEEP("íœ´ë©´ ìƒíƒœ"),
        MEMBER_QUIT("íƒˆí‡´ ìƒíƒœ");

        @Getter
        private String status;

        MemberStatus(String status) {
           this.status = status;
        }
    }

    public enum MemberRole {
        ROLE_USER,
        ROLE_ADMIN
    }
}
```
[ì½”ë“œ 4-29] Spring Securityì˜ User ì—­í• ì„ í•˜ëŠ” Member ì—”í‹°í‹° í´ë˜ìŠ¤ì— User ê¶Œí•œ ì •ë³´ ë§¤í•‘


ì½”ë“œ 4-29ëŠ” Member ì—”í‹°í‹° í´ë˜ìŠ¤ì™€ Userì˜ ê¶Œí•œ ì •ë³´ë¥¼ ë§¤í•‘í•œ ì½”ë“œì…ë‹ˆë‹¤.

Member ì—”í‹°í‹° í´ë˜ìŠ¤ì™€ Userì˜ ê¶Œí•œ ì •ë³´ë¥¼ ë§¤í•‘í•˜ëŠ” ê²ƒì€ (1)ê³¼ ê°™ì´ ê°„ë‹¨í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


(1)ê³¼ ê°™ì´ List, Set ê°™ì€ ì»¬ë ‰ì…˜ íƒ€ì…ì˜ í•„ë“œëŠ” @ElementCollection ì• ë„ˆí…Œì´ì…˜ì„ ì¶”ê°€í•˜ë©´ User ê¶Œí•œ ì •ë³´ì™€ ê´€ë ¨ëœ ë³„ë„ì˜ ì—”í‹°í‹° í´ë˜ìŠ¤ë¥¼ ìƒì„±í•˜ì§€ ì•Šì•„ë„ ê°„ë‹¨í•˜ê²Œ ë§¤í•‘ ì²˜ë¦¬ê°€ ë©ë‹ˆë‹¤.


ì¦‰, ì´ ìƒíƒœì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ë©´ ì•„ë˜ì˜ [ê·¸ë¦¼ 4-11]ê³¼ ê°™ì€ í…Œì´ë¸”ì´ ìƒì„±ë©ë‹ˆë‹¤.



[ê·¸ë¦¼ 4-11] Userì˜ ê¶Œí•œ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” MEMBER_ROLES í…Œì´ë¸”


[ê·¸ë¦¼ 4-11]ì„ ë³´ë©´ Member ì—”í‹°í‹° í´ë˜ìŠ¤ì™€ ì—°ê´€ ê´€ê³„ ë§¤í•‘ì— ëŒ€í•œ í…Œì´ë¸”ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

í•œ ëª…ì˜ íšŒì›ì´ í•œ ê°œ ì´ìƒì˜ Roleì„ ê°€ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, MEMBER í…Œì´ë¸”ê³¼ MEMBER_ROLES í…Œì´ë¸”ì€ 1ëŒ€ Nì˜ ê´€ê³„ì…ë‹ˆë‹¤.


íšŒì› ê°€ì…ì„ í†µí•´ íšŒì› ì •ë³´ê°€ MEMBER í…Œì´ë¸”ì— ì €ì¥ë  ë•Œ, MEMBER_ROLES í…Œì´ë¸”ì˜ MEMBER_MEMBER_ID ì—´ì—ëŠ” MEMBER í…Œì´ë¸”ì˜ ê¸°ë³¸í‚¤ ê°’ì´ ê·¸ë¦¬ê³  ROLES ì—´ì—ëŠ” ê¶Œí•œ ì •ë³´ê°€ ì €ì¥ë  ê²ƒì…ë‹ˆë‹¤.




âœ” íšŒì› ê°€ì… ì‹œ, Userì˜ ê¶Œí•œ ì •ë³´(Role)ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥

Userì˜ ê¶Œí•œ ì •ë³´ë¥¼ ê´€ë¦¬í•˜ëŠ” í…Œì´ë¸”ë„ ë§Œë“¤ì–´ì¡Œìœ¼ë‹ˆ ì´ì œ íšŒì› ê°€ì… ì‹œ, í•´ë‹¹ íšŒì›ì˜ ê¶Œí•œ ì •ë³´ë¥¼ MEMBER_ROLES í…Œì´ë¸”ì— ì €ì¥í•´ ë´…ì‹œë‹¤.


DBMemberService

```java
package com.codestates.member;

import com.codestates.auth.utils.HelloAuthorityUtils;
import com.codestates.exception.BusinessLogicException;
import com.codestates.exception.ExceptionCode;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Optional;

@Transactional
public class DBMemberService implements MemberService {
    ...
    ...
  
    private final HelloAuthorityUtils authorityUtils;

    ...
    ...

    public Member createMember(Member member) {
        verifyExistsEmail(member.getEmail());
        String encryptedPassword = passwordEncoder.encode(member.getPassword());
        member.setPassword(encryptedPassword);

        // (1) Roleì„ DBì— ì €ì¥
        List<String> roles = authorityUtils.createRoles(member.getEmail());
        member.setRoles(roles);

        Member savedMember = memberRepository.save(member);

        return savedMember;
    }

    ...
    ...
}
```
[ì½”ë“œ 4-30] íšŒì› ë“±ë¡ ì‹œ, ê¶Œí•œ ì •ë³´ë¥¼ DBì— ì €ì¥


ì½”ë“œ 4-30ì—ì„œëŠ” DBMemberServiceì—ì„œ íšŒì› ë“±ë¡ ì‹œ, íšŒì›ì˜ ê¶Œí•œ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” ì½”ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.


(1)ì—ì„œëŠ” authorityUtils.createRoles(member.getEmail());ë¥¼ í†µí•´ íšŒì›ì˜ ê¶Œí•œ ì •ë³´(List<String> roles)ë¥¼ ìƒì„±í•œ ë’¤ member ê°ì²´ì— ë„˜ê²¨ì£¼ê³  ìˆìŠµë‹ˆë‹¤.


ì•„ë˜ì˜ ì½”ë“œ 4-31ì€ createRoles() ë©”ì„œë“œê°€ ì¶”ê°€ëœ HelloAuthorityUtils í´ë˜ìŠ¤ì˜ ì½”ë“œì…ë‹ˆë‹¤.

```java
package com.codestates.auth.utils;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.AuthorityUtils;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.stream.Collectors;

@Component
public class HelloAuthorityUtils {
    @Value("${mail.address.admin}")
    private String adminMailAddress;

    ...
    ...

    private final List<String> ADMIN_ROLES_STRING = List.of("ADMIN", "USER");
    private final List<String> USER_ROLES_STRING = List.of("USER");

    ...
    ...

    // (1) DB ì €ì¥ìš©
    public List<String> createRoles(String email) {
        if (email.equals(adminMailAddress)) {
            return ADMIN_ROLES_STRING;
        }
        return USER_ROLES_STRING;
    }
}
```
[ì½”ë“œ 4-31] íšŒì›ì˜ Role ì •ë³´ë¥¼ ìƒì„±í•˜ëŠ” createRoles() ë©”ì„œë“œê°€ ì¶”ê°€ëœ HelloAuthorityUtils


(1)ì—ì„œëŠ” íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ëœ ì´ë©”ì¼ ì£¼ì†Œê°€ application.yml íŒŒì¼ì˜ mail.address.admin í”„ë¡œí¼í‹°ì— ì •ì˜ëœ ì´ë©”ì¼ ì£¼ì†Œì™€ ë™ì¼í•˜ë©´ ê´€ë¦¬ì Role ëª©ë¡(ADMIN_ROLES_STRING)ì„ ë¦¬í„´í•˜ê³ , ê·¸ ì™¸ì—ëŠ” ì¼ë°˜ ì‚¬ìš©ì Role ëª©ë¡(USER_ROLES_STRING)ì„ ë¦¬í„´í•©ë‹ˆë‹¤.



âœ” ë¡œê·¸ì¸ ì¸ì¦ ì‹œ, Userì˜ ê¶Œí•œ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•˜ëŠ” ì‘ì—…

ì, ì´ì œ ë§ˆì§€ë§‰ ì‘ì—…ì€ ë¡œê·¸ì¸ ì¸ì¦ì— ì„±ê³µ ì‹œ, ì œê³µí•˜ëŠ” Userì˜ ê¶Œí•œ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì˜ í…Œì´ë¸”ì—ì„œ ê´€ë¦¬ë˜ëŠ” Roleì„ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.


ê°œì„ ëœ HelloUserDetailsService(V3)

```java
package com.codestates.auth;

import com.codestates.auth.utils.HelloAuthorityUtils;
import com.codestates.exception.BusinessLogicException;
import com.codestates.exception.ExceptionCode;
import com.codestates.member.Member;
import com.codestates.member.MemberRepository;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Component;

import java.util.Collection;
import java.util.Optional;

@Component
public class HelloUserDetailsServiceV3 implements UserDetailsService {
    private final MemberRepository memberRepository;
    private final HelloAuthorityUtils authorityUtils;

    public HelloUserDetailsServiceV3(MemberRepository memberRepository, HelloAuthorityUtils authorityUtils) {
        this.memberRepository = memberRepository;
        this.authorityUtils = authorityUtils;
    }

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        Optional<Member> optionalMember = memberRepository.findByEmail(username);
        Member findMember = optionalMember.orElseThrow(() -> new BusinessLogicException(ExceptionCode.MEMBER_NOT_FOUND));

        return new HelloUserDetails(findMember);
    }

    private final class HelloUserDetails extends Member implements UserDetails {
        HelloUserDetails(Member member) {
            setMemberId(member.getMemberId());
            setFullName(member.getFullName());
            setEmail(member.getEmail());
            setPassword(member.getPassword());
            setRoles(member.getRoles());        // (1)
        }

        @Override
        public Collection<? extends GrantedAuthority> getAuthorities() {
            // (2) DBì— ì €ì¥ëœ Role ì •ë³´ë¡œ User ê¶Œí•œ ëª©ë¡ ìƒì„±
            return authorityUtils.createAuthorities(this.getRoles());
        }

        ...
        ...
    }

}
```
[ì½”ë“œ 4-32] DBì—ì„œ ì¡°íšŒí•œ Roleì„ ê¸°ë°˜ìœ¼ë¡œ Userì˜ ê¶Œí•œ ì •ë³´ ìƒì„±


ì½”ë“œ 4-32ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì˜ MEMBER_ROLES í…Œì´ë¸”ì—ì„œ ì¡°íšŒí•œ Roleì„ ê¸°ë°˜ìœ¼ë¡œ Userì˜ ê¶Œí•œ ëª©ë¡(List<GrantedAuthority>)ì„ ìƒì„±í•˜ëŠ” ë¡œì§ì´ ì¶”ê°€ëœ HelloUserDetailsService í´ë˜ìŠ¤ì…ë‹ˆë‹¤.


ë¨¼ì € (1)ì—ì„œëŠ” HelloUserDetailsê°€ ìƒì†í•˜ê³  ìˆëŠ” Member(extends Member)ì— ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•œ List<String> rolesë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.

ê·¸ë¦¬ê³  (2)ì—ì„œ ë‹¤ì‹œ Member(extends Member)ì— ì „ë‹¬í•œ Role ì •ë³´ë¥¼ authorityUtils.createAuthorities() ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•´ì„œ ê¶Œí•œ ëª©ë¡(List<GrantedAuthority>)ì„ ìƒì„±í•©ë‹ˆë‹¤.


ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ Role ì •ë³´ë¥¼ ê°€ì§€ê³  ì˜¤ì§€ ì•Šì•˜ì„ ë•ŒëŠ” authorityUtils.createAuthorities(this.getRoles());ê°€ ì•„ë‹ˆë¼ authorityUtils.createAuthorities(this.getEmail());ì´ì—ˆìŠµë‹ˆë‹¤.

ìˆ˜ì •ëœ ë¶€ë¶„ì„ í˜¼ë™í•˜ì§€ ì•Šê¸¸ ë°”ëë‹ˆë‹¤.


ì•„ë˜ì˜ ì½”ë“œ 4-33ì€ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•œ Role ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Userì˜ ê¶Œí•œ ëª©ë¡ ìƒì„±í•˜ëŠ” createAuthorities(List<String> roles) ë©”ì„œë“œê°€ ì¶”ê°€ëœ HelloAuthorityUtils í´ë˜ìŠ¤ì˜ ì½”ë“œì…ë‹ˆë‹¤.


HelloAuthorityUtils

```java
package com.codestates.auth.utils;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.AuthorityUtils;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.stream.Collectors;

@Component
public class HelloAuthorityUtils {
    @Value("${mail.address.admin}")
    private String adminMailAddress;

    private final List<GrantedAuthority> ADMIN_ROLES = AuthorityUtils.createAuthorityList("ROLE_ADMIN", "ROLE_USER");
    private final List<GrantedAuthority> USER_ROLES = AuthorityUtils.createAuthorityList("ROLE_USER");
    private final List<String> ADMIN_ROLES_STRING = List.of("ADMIN", "USER");
    private final List<String> USER_ROLES_STRING = List.of("USER");

    // ë©”ëª¨ë¦¬ ìƒì˜ Roleì„ ê¸°ë°˜ìœ¼ë¡œ ê¶Œí•œ ì •ë³´ ìƒì„±.
    public List<GrantedAuthority> createAuthorities(String email) {
        if (email.equals(adminMailAddress)) {
            return ADMIN_ROLES;
        }
        return USER_ROLES;
    }

    // (1) DBì— ì €ì¥ëœ Roleì„ ê¸°ë°˜ìœ¼ë¡œ ê¶Œí•œ ì •ë³´ ìƒì„±
    public List<GrantedAuthority> createAuthorities(List<String> roles) {
       List<GrantedAuthority> authorities = roles.stream()
               .map(role -> new SimpleGrantedAuthority("ROLE_" + role)) // (2)
               .collect(Collectors.toList());
       return authorities;
    }

    ...
    ...
}
```
[ì½”ë“œ 4-33] ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•œ Role ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Userì˜ ê¶Œí•œ ëª©ë¡ ìƒì„±


ì½”ë“œ 4-33ì˜ (1)ì„ ë³´ë©´ ê¸°ì¡´ì—ëŠ” application.yml íŒŒì¼ì˜ mail.address.admin í”„ë¡œí¼í‹°ì— ì •ì˜ëœ ê´€ë¦¬ììš© ì´ë©”ì¼ ì£¼ì†Œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê´€ë¦¬ì Roleì„ ì¶”ê°€í–ˆì§€ë§Œ ì´ì œëŠ” ê·¸ëŸ´ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.


ë‹¨ìˆœíˆ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì§€ê³  ì˜¨ Role ëª©ë¡(List<String> roles)ì„ ê·¸ëŒ€ë¡œ ì´ìš©í•´ì„œ ê¶Œí•œ ëª©ë¡(authorities)ì„ ë§Œë“¤ë©´ ë˜ë‹ˆê¹Œìš”.


ğŸ’¡ ì£¼ì˜í•´ì•¼ í•  ê²ƒì€ (2)ì™€ ê°™ì´ SimpleGrantedAuthority ê°ì²´ë¥¼ ìƒì„±í•  ë•Œ ìƒì„±ì íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì£¼ëŠ” ê°’ì´ â€œ USER" ë˜ëŠ” â€œADMIN"ìœ¼ë¡œ ë„˜ê²¨ì£¼ë©´ ì•ˆ ë˜ê³  â€œROLE_USER" ë˜ëŠ” â€œROLE_ADMIN" í˜•íƒœë¡œ ë„˜ê²¨ì£¼ì–´ì•¼ í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.


ì´ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•œ ë’¤ íšŒì› ê°€ì… í›„, ë¡œê·¸ì¸ì„ í•´ë³´ì„¸ìš”. ì˜ ë™ì‘í•˜ë‚˜ìš”?

êµ¬í˜„ì— ì„±ê³µí–ˆê¸¸ ë°”ëë‹ˆë‹¤.



âœ… Custom AuthenticationProviderë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•
ì•ì—ì„œ Custom UserDetailsServiceë¥¼ ì‚¬ìš©í•´ ë¡œê·¸ì¸ ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì€ Spring Securityê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì¸ì¦ì„ ëŒ€ì‹  ì²˜ë¦¬í•´ ì£¼ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.


ì´ë²ˆì—ëŠ” ë§ˆì§€ë§‰ìœ¼ë¡œ Custom AuthenticationProviderë¥¼ ì´ìš©í•´ ìš°ë¦¬ê°€ ì§ì ‘ ë¡œê·¸ì¸ ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì„ ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.


ê·¸ëƒ¥ Spring Securityê°€ ë¡œê·¸ì¸ ì¸ì¦ì„ ëŒ€ì‹ í•´ ì£¼ëŠ” ë°©ì‹ì„ ì“°ë©´ ë˜ì§€ ë­£í•˜ëŸ¬ ì§ì ‘ ë¡œê·¸ì¸ ì¸ì¦ ì²˜ë¦¬ ë¡œì§ì„ ë§Œë“¤ì–´ì•¼ í•´?ë¼ê³  í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.


ë¬¼ë¡  Spring Securityê°€ ì¹œì ˆí•˜ê²Œ ëŒ€ì‹  ì¸ì¦í•´ ì£¼ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•´ë„ ë©ë‹ˆë‹¤.


í•˜ì§€ë§Œ ì—¬ëŸ¬ë¶„ì´ Custom AuthenticationProvider ë°©ì‹ì„ ì‚¬ìš©í•´ ë³´ëŠ” ê²ƒì€ Spring Securityì˜ í•µì‹¬ ì»´í¬ë„ŒíŠ¸ì¸ AuthenticationProviderë¥¼ ì´í•´í•˜ëŠ” ë° ë„ì›€ì´ ë˜ê³  ë˜í•œ ë³´ì•ˆ ìš”êµ¬ ì‚¬í•­ì— ë¶€í•©í•˜ëŠ” ì ì ˆí•œ ì¸ì¦ ë°©ì‹(ì˜ˆë¥¼ ë“¤ì–´ 2 Factor ì¸ì¦ ë“±)ì„ ì§ì ‘ êµ¬í˜„í•´ì•¼ í•  ê²½ìš°, Custom AuthenticationProviderê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ ì´ëŸ¬í•œ ê´€ì ìœ¼ë¡œ ì•„ë˜ì˜ Custom AuthenticationProvider êµ¬í˜„ ì½”ë“œë¥¼ ì‚´í´ë³´ê¸° ë°”ëë‹ˆë‹¤.


HelloUserAuthenticationProvider(V1)

```java
package com.codestates.auth;

import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Component;

import java.util.Collection;
import java.util.Optional;

@Component
public class HelloUserAuthenticationProvider implements AuthenticationProvider {   // (1)
    private final HelloUserDetailsService userDetailsService;
    private final PasswordEncoder passwordEncoder;

    public HelloUserAuthenticationProvider(HelloUserDetailsService userDetailsService, 
                                           PasswordEncoder passwordEncoder) {
        this.userDetailsService = userDetailsService;
        this.passwordEncoder = passwordEncoder;
    }


    // (3)
    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        UsernamePasswordAuthenticationToken authToken = (UsernamePasswordAuthenticationToken) authentication;  // (3-1)

        // (3-2)
        String username = authToken.getName();
        Optional.ofNullable(username).orElseThrow(() -> new UsernameNotFoundException("Invalid User name or User Password"));

        // (3-3)
        UserDetails userDetails = userDetailsService.loadUserByUsername(username);

        String password = userDetails.getPassword();
        verifyCredentials(authToken.getCredentials(), password);    // (3-4)

        Collection<? extends GrantedAuthority> authorities = userDetails.getAuthorities();  // (3-5)

        // (3-6)
        return UsernamePasswordAuthenticationToken.authenticated(username, password, authorities);
    }

    // (2) HelloUserAuthenticationProviderê°€ Username/Password ë°©ì‹ì˜ ì¸ì¦ì„ ì§€ì›í•œë‹¤ëŠ” ê²ƒì„ Spring Securityì— ì•Œë ¤ì¤€ë‹¤.
    @Override
    public boolean supports(Class<?> authentication) {
        return UsernamePasswordAuthenticationToken.class.equals(authentication);
    }

    private void verifyCredentials(Object credentials, String password) {
        if (!passwordEncoder.matches((String)credentials, password)) {
            throw new BadCredentialsException("Invalid User name or User Password");
        }
    }
}
```
[ì½”ë“œ 4-34] Custom AuthenticationProviderì¸ HelloUserAuthenticationProvider


ì½”ë“œ 4-34ëŠ” AuthenticationProviderë¥¼ HelloUserAuthenticationProviderì˜ ì½”ë“œì…ë‹ˆë‹¤.


ì½”ë“œ 4-34ì˜ ì„¤ëª…ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

(1)ê³¼ ê°™ì´ AuthenticationProvider ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ í´ë˜ìŠ¤ë¡œ ì •ì˜í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ ìš°ë¦¬ëŠ” AuthenticationProviderì˜ êµ¬í˜„ í´ë˜ìŠ¤ë¡œì¨ì˜ HelloUserAuthenticationProviderë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.

Spring SecurityëŠ” ì½”ë“œ 4-34ì™€ ê°™ì´ AuthenticationProviderë¥¼ êµ¬í˜„í•œ êµ¬í˜„ í´ë˜ìŠ¤ê°€ Spring Beanìœ¼ë¡œ ë“±ë¡ë˜ì–´ ìˆë‹¤ë©´ í•´ë‹¹ AuthenticationProviderë¥¼ ì´ìš©í•´ì„œ ì¸ì¦ì„ ì§„í–‰í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ í´ë¼ì´ì–¸íŠ¸ ìª½ì—ì„œ ë¡œê·¸ì¸ ì¸ì¦ì„ ì‹œë„í•˜ë©´ ìš°ë¦¬ê°€ êµ¬í˜„í•œ HelloUserAuthenticationProviderê°€ ì§ì ‘ ì¸ì¦ì„ ì²˜ë¦¬í•˜ê²Œ ë©ë‹ˆë‹¤.


AuthenticationProvider ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ í´ë˜ìŠ¤ëŠ” authenticate(Authentication authentication) ë©”ì„œë“œì™€ supports(Class<?> authentication) ë©”ì„œë“œë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.

ê·¸ì¤‘ì—ì„œ (2)ì˜ supports(Class<?> authentication) ë©”ì„œë“œëŠ” ìš°ë¦¬ê°€ êµ¬í˜„í•˜ëŠ” Custom AuthenticationProvider(HelloUserAuthenticationProvider)ê°€ Username/Password ë°©ì‹ì˜ ì¸ì¦ì„ ì§€ì›í•œë‹¤ëŠ” ê²ƒì„ Spring Securityì— ì•Œë ¤ì£¼ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

supports() ë©”ì„œë“œì˜ ë¦¬í„´ê°’ì´ trueì¼ ê²½ìš°, Spring SecurityëŠ” í•´ë‹¹ AuthenticationProviderì˜ authenticate() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ì„œ ì¸ì¦ì„ ì§„í–‰í•©ë‹ˆë‹¤.


(3)ì˜ authenticate(Authentication authentication)ì—ì„œ ìš°ë¦¬ê°€ ì§ì ‘ ì‘ì„±í•œ ì¸ì¦ ì²˜ë¦¬ ë¡œì§ì„ ì´ìš©í•´ ì‚¬ìš©ìì˜ ì¸ì¦ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.

(3-1)ì—ì„œ authenticationì„ ìºìŠ¤íŒ…í•˜ì—¬ UsernamePasswordAuthenticationTokenì„ ì–»ìŠµë‹ˆë‹¤.

ì´ UsernamePasswordAuthenticationToken ê°ì²´ì—ì„œ (3-2)ì™€ ê°™ì´ í•´ë‹¹ ì‚¬ìš©ìì˜ Usernameì„ ì–»ì€ í›„, ì¡´ì¬í•˜ëŠ”ì§€ ì²´í¬í•©ë‹ˆë‹¤.

Usernameì´ ì¡´ì¬í•œë‹¤ë©´ (3-3)ê³¼ ê°™ì´ userDetailsServiceë¥¼ ì´ìš©í•´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í•´ë‹¹ ì‚¬ìš©ìë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.

(3-4)ì—ì„œ ë¡œê·¸ì¸ ì •ë³´ì— í¬í•¨ëœ íŒ¨ìŠ¤ì›Œë“œ(authToken.getCredentials())ì™€ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœ ì‚¬ìš©ìì˜ íŒ¨ìŠ¤ì›Œë“œ ì •ë³´ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤.

(3-4)ì˜ ê²€ì¦ ê³¼ì •ì„ í†µê³¼í–ˆë‹¤ë©´ ë¡œê·¸ì¸ ì¸ì¦ì— ì„±ê³µí•œ ì‚¬ìš©ìì´ë¯€ë¡œ (3-5)ì™€ ê°™ì´ í•´ë‹¹ ì‚¬ìš©ìì˜ ê¶Œí•œì„ ìƒì„±í•©ë‹ˆë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ (3-6)ê³¼ ê°™ì´ ì¸ì¦ëœ ì‚¬ìš©ìì˜ ì¸ì¦ ì •ë³´ë¥¼ ë¦¬í„´ê°’ìœ¼ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.

ì´ ì¸ì¦ ì •ë³´ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ Spring Securityì—ì„œ ê´€ë¦¬í•˜ê²Œ ë©ë‹ˆë‹¤.


ì´ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ê³  íšŒì› ê°€ì…ì„ í•œ í›„, ë¡œê·¸ì¸ì„ í•´ ë³´ì„¸ìš”.

íšŒì› ê°€ì… ì‹œ ë“±ë¡í•œ ì´ë©”ì¼ ì£¼ì†Œ/íŒ¨ìŠ¤ì›Œë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ë©´ ì •ìƒì ìœ¼ë¡œ Hello, Spring Securityì˜ ë©”ì¸ í™”ë©´ì´ ë¸Œë¼ìš°ì €ì— í‘œì‹œí•  ê²ƒì…ë‹ˆë‹¤.

ê·¸ëŸ°ë° ë§Œì•½ íšŒì› ê°€ì…ì„ í•˜ì§€ ì•Šê³  ë¡œê·¸ì¸ì„ ì‹œë„í•  ê²½ìš°(íšŒì› ê°€ì… ì´í›„ì—ëŠ” ìƒê´€ì—†ìŠµë‹ˆë‹¤) ì¸ì¦ì— ì‹¤íŒ¨í•˜ê³ , ì•„ë˜ì˜ [ê·¸ë¦¼ 4-11-1]ê³¼ ê°™ì€ í•˜ì–€ ì—ëŸ¬ í™”ë©´ì„ ë§Œë‚˜ê²Œ ë©ë‹ˆë‹¤.



[ê·¸ë¦¼ 4-11-1] HelloAuthenticationProviderë¥¼ í†µí•œ ì¸ì¦ ì‹¤íŒ¨ ì‹œ í™”ë©´

ìš°ë¦¬ê°€ ì•ì—ì„œ HelloUserDetailsServiceë¥¼ ì´ìš©í•´ ì¸ì¦ì„ ì²˜ë¦¬í•  ê²½ìš°ì—ëŠ” ì¸ì¦ ì‹¤íŒ¨ ì‹œ, Spring Security ë‚´ë¶€ì—ì„œ ì¸ì¦ ì‹¤íŒ¨ì— ëŒ€í•œ ì „ìš© Exceptionì¸ AuthenticationExceptionì„ throw í•˜ê²Œ ë˜ê³  ì´ AuthenticationExceptionì´ throw ë˜ë©´ ê²°ê³¼ì ìœ¼ë¡œ SecurityConfigurationì—ì„œ ì„¤ì •í•œ .failureUrl("/auths/login-form?error") ì„ í†µí•´ ë¡œê·¸ì¸ í¼ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•˜ë©´ì„œ ì•„ë˜ì˜ [ê·¸ë¦¼ 4-11-2]ì™€ ê°™ì´ â€œë¡œê·¸ì¸ ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.â€ë¼ëŠ” ì¸ì¦ ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.



[ê·¸ë¦¼ 4-11-2] HelloUserDetailsServiceë¥¼ ì´ìš©í•´ ì¸ì¦ ì²˜ë¦¬ ì‹œ, ì¸ì¦ ì‹¤íŒ¨ í™”ë©´

ê·¸ëŸ°ë° Custom AuthenticationProviderë¥¼ ì´ìš©í•  ê²½ìš°ì—ëŠ” íšŒì›ê°€ì… ì „ ì¸ì¦ ì‹¤íŒ¨ ì‹œ, ì™œ [ê·¸ë¦¼ 4-11-2]ì™€ ê°™ì€ í™”ë©´ì´ í‘œì‹œë˜ì§€ ì•Šê³  [ê·¸ë¦¼ 4-11-1]ê³¼ ê°™ì€ â€œWhitelebel Error Pageâ€ê°€ í‘œì‹œë˜ëŠ” ê±¸ê¹Œìš”?

â­ ì´ìœ ëŠ” MemberServiceì—ì„œ ë“±ë¡ëœ íšŒì› ì •ë³´ê°€ ì—†ìœ¼ë©´, BusinessLogicExceptionì„ throw í•˜ëŠ”ë° ì´ BusinessLogicExceptionì´ Cusotm AuthenticationProviderë¥¼ ê±°ì³ ê·¸ëŒ€ë¡œ Spring Security ë‚´ë¶€ ì˜ì—­ìœ¼ë¡œ throw ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

Spring Securityì—ì„œëŠ” ì¸ì¦ ì‹¤íŒ¨ ì‹œ, AuthenticationExceptionì´ throw ë˜ì§€ ì•Šìœ¼ë©´ Exceptionì— ëŒ€í•œ ë³„ë„ì˜ ì²˜ë¦¬ë¥¼ í•˜ì§€ ì•Šê³ , ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆì¸ í†°ìº£ ìª½ìœ¼ë¡œ ì´ ì²˜ë¦¬ë¥¼ ë„˜ê¹ë‹ˆë‹¤.

ê²°êµ­ ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆ ì˜ì—­ì—ì„œ í•´ë‹¹ Exceptionì— ëŒ€í•´ â€œ/errorâ€ URLë¡œ í¬ì›Œë”©í•˜ëŠ”ë° ìš°ë¦¬ê°€ íŠ¹ë³„íˆ â€œ/errorâ€ URLë¡œ í¬ì›Œë”©ë˜ì—ˆì„ ë•Œ ë³´ì—¬ì¤„ ë·° í˜ì´ì§€ë¥¼ ë³„ë„ë¡œ êµ¬ì„±í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ë””í´íŠ¸ í˜ì´ì§€ì¸ â€œWhitelebel Error Pageâ€ë¥¼ ë¸Œë¼ìš°ì €ì— í‘œì‹œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

â­ í•´ê²°ì±…ì€ ê°„ë‹¨í•©ë‹ˆë‹¤. Cusotm AuthenticationProviderì—ì„œ Exceptionì´ ë°œìƒí•  ê²½ìš°, ì´ Exceptionì„ catch í•´ì„œ AuthenticationExceptionìœ¼ë¡œ rethrowë¥¼ í•´ì£¼ë©´ ë©ë‹ˆë‹¤.


ê°œì„ ëœ HelloUserAuthenticationProvider(V2)

```java
package com.codestates.auth;

import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Component;

import java.util.Collection;
import java.util.Optional;

@Component
public class HelloUserAuthenticationProvider implements AuthenticationProvider {
    private final HelloUserDetailsService userDetailsService;
    private final PasswordEncoder passwordEncoder;

    public HelloUserAuthenticationProvider(HelloUserDetailsService userDetailsService,
                                           PasswordEncoder passwordEncoder) {
        this.userDetailsService = userDetailsService;
        this.passwordEncoder = passwordEncoder;
    }

    // V2: AuthenticationExceptionì„ rethrow í•˜ëŠ” ê°œì„  ì½”ë“œ
    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        UsernamePasswordAuthenticationToken authToken = (UsernamePasswordAuthenticationToken) authentication;

        String username = authToken.getName();
        Optional.ofNullable(username).orElseThrow(() -> new UsernameNotFoundException("Invalid User name or User Password"));
        try {
            UserDetails userDetails = userDetailsService.loadUserByUsername(username);
            String password = userDetails.getPassword();
            verifyCredentials(authToken.getCredentials(), password);

            Collection<? extends GrantedAuthority> authorities = userDetails.getAuthorities();
            return UsernamePasswordAuthenticationToken.authenticated(username, password, authorities);
        } catch (Exception ex) {
            throw new UsernameNotFoundException(ex.getMessage()); // (1) AuthenticationExceptionìœ¼ë¡œ ë‹¤ì‹œ throw í•œë‹¤.
        }
    }

    @Override
    public boolean supports(Class<?> authentication) {
        return UsernamePasswordAuthenticationToken.class.equals(authentication);
    }

    private void verifyCredentials(Object credentials, String password) {
        if (!passwordEncoder.matches((String)credentials, password)) {
            throw new BadCredentialsException("Invalid User name or User Password");
        }
    }
}
```
ì½”ë“œ 4-34ì—ì„œëŠ” AuthenticationExceptionì´ ì•„ë‹Œ ë‹¤ë¥¸ Exceptionì´ ë°œìƒí•  ê²½ìš° AuthenticationExceptionìœ¼ë¡œ ë‹¤ì‹œ rethrow í•˜ë„ë¡ ê°œì„ ëœ HelloUserAuthenticationProvider ì½”ë“œì…ë‹ˆë‹¤.

(1)ì—ì„œ UsernameNotFoundExceptionì„ throw í•˜ë„ë¡ ìˆ˜ì •ë˜ì—ˆëŠ”ë°, UsernameNotFoundExceptionì€ AuthenticationExceptionì„ ìƒì†í•˜ëŠ” í•˜ìœ„ Exceptionì´ê¸° ë•Œë¬¸ì— ì´ UsernameNotFoundExceptionì´ throwë˜ë©´ Spring Security ìª½ì—ì„œ ì •ìƒì ìœ¼ë¡œ catchí•´ì„œ [ê·¸ë¦¼ 4-11-2]ì™€ ê°™ì´ ì •ìƒì ì¸ ì¸ì¦ ì‹¤íŒ¨ í™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œì¼œì¤ë‹ˆë‹¤.

â­ Custom AuthenticationProviderì—ì„œ AuthenticationExceptionì´ ì•„ë‹Œ Exceptionì´ ë°œìƒí•  ê²½ìš°ì—ëŠ” ê¼­ AuthenticationExceptionì„ rethrow í•˜ë„ë¡ ì½”ë“œë¥¼ êµ¬ì„±í•´ì•¼ í•œë‹¤ëŠ” ì‚¬ì‹¤ì„ ê¸°ì–µí•˜ê¸°ë¥¼ ë°”ëë‹ˆë‹¤.


â­ AuthenticationProvider
AuthenticationProviderëŠ” Spring Securityì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ì „ë‹¬ë°›ì€ ì¸ì¦ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¸ì¦ëœ ì‚¬ìš©ìì¸ì§€ì— ëŒ€í•œ ì¸ì¦ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•˜ëŠ” Spring Security ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.

AuthenticationProviderëŠ” ì¸í„°í˜ì´ìŠ¤ í˜•íƒœë¡œ ì •ì˜ë˜ì–´ ìˆìœ¼ë©°, Spring Securityì—ì„œëŠ” AnonymousAuthenticationProvider, DaoAuthenticationProvider, JwtAuthenticationProvider, RememberMeAuthenticationProvider, OAuth2LoginAuthenticationProvider ë“± ë‹¤ì–‘í•œ ìœ í˜•ì˜ AuthenticationProvider êµ¬í˜„ì²´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.



í•µì‹¬ í¬ì¸íŠ¸
Spring Securityì—ì„œ ì§€ì›í•˜ëŠ” InMemory UserëŠ” ë§ ê·¸ëŒ€ë¡œ ë©”ëª¨ë¦¬ì— ë“±ë¡ë˜ì–´ ì‚¬ìš©ë˜ëŠ” Userì´ë¯€ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ì´ ì¢…ë£Œë˜ë©´ InMember User ì—­ì‹œ ë©”ëª¨ë¦¬ì—ì„œ ì‚¬ë¼ì§„ë‹¤.

InMemory Userë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì€ í…ŒìŠ¤íŠ¸ í™˜ê²½ì´ë‚˜ ë°ëª¨ í™˜ê²½ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ë‹¤.

Spring SecurityëŠ” ì‚¬ìš©ìì˜ í¬ë¦¬ë´ì…œ(Credential, ìê²©ì¦ëª…ì„ ìœ„í•œ êµ¬ì²´ì ì¸ ìˆ˜ë‹¨)ì„ ì•”í˜¸í™”í•˜ê¸° ìœ„í•œ PasswordEncoderë¥¼ ì œê³µí•˜ë©°, PasswordEncoderëŠ” ë‹¤ì–‘í•œ ì•”í˜¸í™” ë°©ì‹ì„ ì œê³µí•˜ë©°, Spring Securityì—ì„œ ì§€ì›í•˜ëŠ” PasswordEncoderì˜ ë””í´íŠ¸ ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜ì€ bcryptì´ë‹¤.

íŒ¨ìŠ¤ì›Œë“œ ê°™ì€ ë¯¼ê°í•œ(sensitive) ì •ë³´ëŠ” ë°˜ë“œì‹œ ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
íŒ¨ìŠ¤ì›Œë“œëŠ” ë³µí˜¸í™”í•  ì´ìœ ê°€ ì—†ìœ¼ë¯€ë¡œ ë‹¨ë°©í–¥ ì•”í˜¸í™” ë°©ì‹ìœ¼ë¡œ ì•”í˜¸í™”ë˜ì–´ì•¼ í•œë‹¤.

Spring Securityì—ì„œ SimpleGrantedAuthorityë¥¼ ì‚¬ìš©í•´ Role ë² ì´ìŠ¤ í˜•íƒœì˜ ê¶Œí•œì„ ì§€ì •í•  ë•Œ â€˜ROLE_â€™ + ê¶Œí•œëª… í˜•íƒœë¡œ ì§€ì •í•´ ì£¼ì–´ì•¼ í•œë‹¤.

Spring Securityì—ì„œëŠ” Spring Securityì—ì„œ ê´€ë¦¬í•˜ëŠ” User ì •ë³´ë¥¼ UserDetailsë¡œ ê´€ë¦¬í•œë‹¤.

UserDetailsëŠ” UserDetailsServiceì— ì˜í•´ ë¡œë“œ(load)ë˜ëŠ” í•µì‹¬ User ì •ë³´ë¥¼ í‘œí˜„í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.

UserDetailsServiceëŠ” User ì •ë³´ë¥¼ ë¡œë“œ(load)í•˜ëŠ” í•µì‹¬ ì¸í„°í˜ì´ìŠ¤ì´ë‹¤.

ì¼ë°˜ì ìœ¼ë¡œ Spring Securityì—ì„œëŠ” ì¸ì¦ì„ ì‹œë„í•˜ëŠ” ì£¼ì²´ë¥¼ User(ë¹„ìŠ·í•œ ì˜ë¯¸ë¡œ Principalë„ ìˆìŒ)ë¼ê³  ë¶€ë¥¸ë‹¤. Principalì€ Userì˜ ë” êµ¬ì²´ì ì¸ ì •ë³´ë¥¼ ì˜ë¯¸í•˜ë©°, ì¼ë°˜ì ìœ¼ë¡œ Usernameì„ ì˜ë¯¸í•œë‹¤.

Custom UserDetailsServiceë¥¼ ì‚¬ìš©í•´ ë¡œê·¸ì¸ ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì€ Spring Securityê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì¸ì¦ì„ ëŒ€ì‹  ì²˜ë¦¬í•´ ì£¼ëŠ” ë°©ì‹ì´ë‹¤.

AuthenticationProviderëŠ” Spring Securityì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ì „ë‹¬ë°›ì€ ì¸ì¦ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¸ì¦ëœ ì‚¬ìš©ìì¸ì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” Spring Securityì˜ ì»´í¬ë„ŒíŠ¸ì´ë‹¤.



ì‹¬í™” í•™ìŠµ
Spring Securityì—ì„œ ì œê³µí•˜ëŠ” PasswordEncoderì—ì„œ ë” ì•Œì•„ë³´ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ë§í¬ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

https://docs.spring.io/spring-security/reference/features/authentication/password-storage.html#authentication-password-storage
bcrypt ì•Œê³ ë¦¬ì¦˜ì— ëŒ€í•´ì„œ ë” ì•Œì•„ë³´ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ë§í¬ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

https://ko.wikipedia.org/wiki/Bcrypt
ë‹¨ë°©í–¥ ì•”í˜¸í™”ì— ëŒ€í•´ì„œ ë” ì•Œì•„ë³´ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ë§í¬ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

https://en.citizendium.org/wiki/One-way_encryption
Clickjacking ê³µê²©ì— ëŒ€í•´ì„œ ë” ì•Œì•„ë³´ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ë§í¬ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

https://en.wikipedia.org/wiki/Clickjacking

https://ko.wikipedia.org/wiki/í´ë¦­ì¬í‚¹



 ##################################