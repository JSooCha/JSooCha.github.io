---
title: JWT ìƒì„± ë° ê²€ì¦ í…ŒìŠ¤íŠ¸
excerpt: JWT(Json Web Token)
categories: Spring
tags: [codestates, Spring]
toc: true
toc_sticky: true
author_profile: true
sidebar_main: true
published : false
---

### build.gradle ì„¤ì •
```
dependencies {
  // (1)
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.springframework.security:spring-security-test'
  // (2)
	implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
	runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.5'
	runtimeOnly	'io.jsonwebtoken:jjwt-jackson:0.11.5'
}
```
(1) : Spring Frameworkì™€ ê´€ê³„ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬
(2) : JWT ìƒì„± ë° ê²€ì¦ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ í•„ìš”í•œ JWT ë¼ì´ë¸ŒëŸ¬ë¦¬
  - JWTë¥¼ ìœ„í•œ ëŒ€í‘œì ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ : jjwt, Java JWT

### JWT ìƒì„±
```
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.io.Decoders;
import io.jsonwebtoken.io.Encoders;
import io.jsonwebtoken.security.Keys;

import java.nio.charset.StandardCharsets;
import java.security.Key;
import java.util.Date;
import java.util.Map;

public class JwtTokenizer {
    // (1)
    public String encodeBase64SecretKey(String secretKey) {
        return Encoders.BASE64.encode(secretKey.getBytes(StandardCharsets.UTF_8));
    }

    // (2)
    public String generateAccessToken(Map<String, Object> claims,
                                      String subject,
                                      Date expiration,
                                      String base64EncodedSecretKey) {
        Key key = getKeyFromBase64EncodedKey(base64EncodedSecretKey); // (2-1)

        return Jwts.builder()
                .setClaims(claims)          // (2-2)
                .setSubject(subject)        // (2-3)
                .setIssuedAt(Calendar.getInstance().getTime())   // (2-4)
                .setExpiration(expiration)  // (2-5)
                .signWith(key)              // (2-6)
                .compact();                 // (2-7)
    }

    // (3)
    public String generateRefreshToken(String subject, Date expiration, String base64EncodedSecretKey) {
        Key key = getKeyFromBase64EncodedKey(base64EncodedSecretKey);

        return Jwts.builder()
                .setSubject(subject)
                .setIssuedAt(Calendar.getInstance().getTime())
                .setExpiration(expiration)
                .signWith(key)
                .compact();
    }
    
    ...
    ...

    // (4)
    private Key getKeyFromBase64EncodedKey(String base64EncodedSecretKey) {
        byte[] keyBytes = Decoders.BASE64.decode(base64EncodedSecretKey);  // (4-1)
        Key key = Keys.hmacShaKeyFor(keyBytes);    // (4-2)

        return key;
    }
}
```
(1) : encodeBase64SecretKey() -  Plain Text í˜•íƒœì¸ Secret Keyì˜ byte[]ë¥¼ Base64 í˜•ì‹ì˜ ë¬¸ìì—´ë¡œ ì¸ì½”ë”©
  - jjwtê°€ ë²„ì „ì—… ë˜ë©´ì„œ Plain Text ìì²´ë¥¼ Secret Keyë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ì•”í˜¸í•™(cryptographic)ì ì¸ ì‘ì—…ì— ì‚¬ìš©ë˜ëŠ” Keyê°€ í•­ìƒ ë°”ì´ë„ˆë¦¬(byte array)ë¼ëŠ” ì‚¬ì‹¤ê³¼ ë§ì§€ ì•ŠëŠ” ê²ƒì„ ê°ì•ˆí•˜ì—¬ Plain Text ìì²´ë¥¼ Secret Keyë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•˜ì§€ ì•Šê³  ìˆìŒ

(2) : enerateAccessToken() -  ì¸ì¦ëœ ì‚¬ìš©ìì—ê²Œ JWTë¥¼ ìµœì´ˆë¡œ ë°œê¸‰í•´ì£¼ê¸° ìœ„í•œ JWT ìƒì„± ë©”ì„œë“œ
- (2-1) : Base64 í˜•ì‹ Secret Key ë¬¸ìì—´ì„ ì´ìš©í•´ Key(java.security.Key) ê°ì²´ë¥¼ ì–»ìŒ
- (2-2) : setClaims() - JWTì— í¬í•¨ ì‹œí‚¬ Custom Claims ì¶”ê°€
  - Custom Claimsì—ëŠ” ì£¼ë¡œ ì¸ì¦ëœ ì‚¬ìš©ìì™€ ê´€ë ¨ëœ ì •ë³´ë¥¼ ì¶”ê°€
- (2-3) : setSubject() - JWTì˜ ì œëª© ì¶”ê°€
- (2-4) : setIssuedAt() - JWT ë°œí–‰ ì¼ì ì„¤ì • 
  - íŒŒë¼ë¯¸í„° íƒ€ì…ì€ java.util.Date 
- (2-5) : setExpiration() - JWTì˜ ë§Œë£Œì¼ì‹œ ì§€ì • 
  - íŒŒë¼ë¯¸í„° íƒ€ì…ì€ java.util.Date
- (2-6) : signWith() - ì„œëª…ì„ ìœ„í•œ Key(java.security.Key) ê°ì²´ ì„¤ì •
- (2-7) : compact() - JWT ìƒì„± ë° ì§ë ¬í™”

(3) : generateRefreshToken() - Access Tokenì´ ë§Œë£Œë˜ì—ˆì„ ê²½ìš°, Access Tokenì„ ìƒˆë¡œ ìƒì„±í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” Refresh Token ìƒì„±
- Refresh Tokenì€ Access Tokenì„ ìƒˆë¡œ ë°œê¸‰í•´ì£¼ëŠ” ì—­í• ì„ í•˜ë¯€ë¡œ ë³„ë„ì˜ Custom ClaimsëŠ” ì¶”ê°€í•  í•„ìš”ê°€ ì—†ìŒ

(4) : getKeyFromBase64EncodedKey() - JWTì˜ ì„œëª…ì— ì‚¬ìš©í•  Secret Key ìƒì„±
- (4-1) : Decoders.BASE64.decode() - Base64 í˜•ì‹ìœ¼ë¡œ ì¸ì½”ë”©ëœ Secret Keyë¥¼ ë””ì½”ë”©í•œ í›„, byte array ë°˜í™˜
- (4-2) : Keys.hmacShaKeyFor() - key byte arrayë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì ì ˆí•œ HMAC ì•Œê³ ë¦¬ì¦˜ì„ ì ìš©í•œ Key(java.security.Key) ê°ì²´ ìƒì„±

ğŸ’¡ jjwt 0.9.x ë²„ì „ì—ì„œëŠ” ì„œëª… ê³¼ì •ì—ì„œ HMAC ì•Œê³ ë¦¬ì¦˜ì„ ì§ì ‘ ì§€ì •í•´ì•¼ í–ˆì§€ë§Œ ìµœì‹  ë²„ì „ì—ì„œëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ì ì ˆí•œ HMAC ì•Œê³ ë¦¬ì¦˜ ì§€ì •


### JWT ìƒì„± ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
```
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.TestInstance;

import java.util.*;

import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.is;
import static org.hamcrest.Matchers.notNullValue;

@TestInstance(TestInstance.Lifecycle.PER_CLASS) // í…ŒìŠ¤íŠ¸ í•™ìŠµì´ í•µì‹¬ì´ ì•„ë‹ˆë‹ˆ êµ¬ê¸€ì—ì„œ ê²€ìƒ‰í•´ì„œ í•™ìŠµí•˜ê¸°
public class JwtTokenizerTest {
    private static JwtTokenizer jwtTokenizer;
    private String secretKey;
    private String base64EncodedSecretKey;

    // (1)
    @BeforeAll
    public void init() {
        jwtTokenizer = new JwtTokenizer();
        secretKey = "kevin1234123412341234123412341234";  // encoded "a2V2aW4xMjM0MTIzNDEyMzQxMjM0MTIzNDEyMzQxMjM0"

        base64EncodedSecretKey = jwtTokenizer.encodeBase64SecretKey(secretKey);
    }

    // (2)
    @Test
    public void encodeBase64SecretKeyTest() {
        System.out.println(base64EncodedSecretKey);

        assertThat(secretKey, is(new String(Decoders.BASE64.decode(base64EncodedSecretKey))));
    }

    // (3)
    @Test
    public void generateAccessTokenTest() {
        Map<String, Object> claims = new HashMap<>();
        claims.put("memberId", 1);
        claims.put("roles", List.of("USER"));

        String subject = "test access token";
        Calendar calendar = Calendar.getInstance();
        calendar.add(Calendar.MINUTE, 10);
        Date expiration = calendar.getTime();

        String accessToken = jwtTokenizer.generateAccessToken(claims, subject, expiration, base64EncodedSecretKey);

        System.out.println(accessToken);

        assertThat(accessToken, notNullValue());
    }

    // (4)
    @Test
    public void generateRefreshTokenTest() {
        String subject = "test refresh token";
        Calendar calendar = Calendar.getInstance();
        calendar.add(Calendar.HOUR, 24);
        Date expiration = calendar.getTime();

        String refreshToken = jwtTokenizer.generateRefreshToken(subject, expiration, base64EncodedSecretKey);

        System.out.println(refreshToken);

        assertThat(refreshToken, notNullValue());
    }
}
```
(1) :  í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©í•  Secret Keyë¥¼ Base64 í˜•ì‹ìœ¼ë¡œ ì¸ì½”ë”©í•œ í›„, ì¸ì½”ë”©ëœ Secret Keyë¥¼ ê° í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì—ì„œ ì‚¬ìš©

(2) : Plain Textì¸ Secret Keyê°€ Base64 í˜•ì‹ìœ¼ë¡œ ì¸ì½”ë”©ì´ ì •ìƒì ìœ¼ë¡œ ìˆ˜í–‰ì´ ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸
  - Base64 í˜•ì‹ìœ¼ë¡œ ì¸ì½”ë”©ëœ Secret Keyë¥¼ ë””ì½”ë”©í•œ ê°’ì´ ì›ë³¸ Plain Text Secret Keyì™€ ì¼ì¹˜í•˜ëŠ”ì§€ë¥¼ í…ŒìŠ¤íŠ¸

(3) : JwtTokenizerê°€ Access Tokenì„ ì •ìƒì ìœ¼ë¡œ ìƒì„±í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸
  - JWTëŠ” ìƒì„±í•  ë•Œë§ˆë‹¤ ê·¸ ê°’ì´ ë°”ë€Œê¸° ë•Œë¬¸ì— ìš°ì„  ìƒì„±ëœ Access Tokenì´ nullì´ ì•„ë‹Œì§€ ì—¬ë¶€ë§Œ í…ŒìŠ¤íŠ¸

(4) :  JwtTokenizerê°€ Refresh Tokenì„ ì •ìƒì ìœ¼ë¡œ ìƒì„±í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸


### JWT ê²€ì¦
- ì¸ì¦ëœ ì‚¬ìš©ìê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ë•Œë§ˆë‹¤ requestì˜ headerì— í¬í•¨ëœ JWTë¥¼ ê²€ì¦í•  ë•Œ ì‚¬ìš©
```
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jws;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.io.Decoders;
import io.jsonwebtoken.io.Encoders;
import io.jsonwebtoken.security.Keys;

import java.nio.charset.StandardCharsets;
import java.security.Key;
import java.util.Calendar;
import java.util.Date;
import java.util.Map;

public class JwtTokenizer {
    ...
    ...

    public void verifySignature(String jws, String base64EncodedSecretKey) {
        Key key = getKeyFromBase64EncodedKey(base64EncodedSecretKey);

        Jwts.parserBuilder()
                .setSigningKey(key)     // (1)
                .build()
                .parseClaimsJws(jws);   // (2)
    }

    ...
    ...
}
```

JWTì— í¬í•¨ëœ Signatureë¥¼ ê²€ì¦í•¨ìœ¼ë¡œì¨ JWTì˜ ìœ„/ë³€ì¡° ì—¬ë¶€ë¥¼ í™•ì¸ ê°€ëŠ¥
jjwtì—ì„œëŠ” JWTë¥¼ ìƒì„±í•  ë•Œ ì„œëª…ì— ì‚¬ìš©ëœ Secret Keyë¥¼ ì´ìš©í•´ ë‚´ë¶€ì ìœ¼ë¡œ Signatureë¥¼ ê²€ì¦í•œ í›„, ê²€ì¦ì— ì„±ê³µí•˜ë©´ JWTë¥¼ íŒŒì‹±í•´ì„œ Claimsë¥¼ ì–»ì„ ìˆ˜ ìˆìŒ

(1) : setSigningKey() - ì„œëª…ì— ì‚¬ìš©ëœ Secret Key ì„¤ì •
(2) : parseClaimsJws() - JWTë¥¼ íŒŒì‹±í•´ì„œ Claimsë¥¼ ì–»ìŒ
(verifySignature() ë©”ì„œë“œëŠ” Signatureë¥¼ ê²€ì¦í•˜ëŠ” ìš©ë„ì´ë¯€ë¡œ Claimsë¥¼ ë¦¬í„´í•  í•„ìš”ëŠ” ì—†ìŒ)
ğŸ’¡íŒŒë¼ë¯¸í„°ë¡œ ì‚¬ìš©í•œ jwsëŠ” Signatureê°€ í¬í•¨ëœ JWTë¼ëŠ” ì˜ë¯¸


### JWT ê²€ì¦ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
```
import io.jsonwebtoken.ExpiredJwtException;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.TestInstance;

import java.util.*;
import java.util.concurrent.TimeUnit;

import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;
import static org.junit.jupiter.api.Assertions.assertThrows;

@TestInstance(TestInstance.Lifecycle.PER_CLASS)
public class JwtTokenizerTest {
    private static JwtTokenizer jwtTokenizer;
    private String secretKey;
    private String base64EncodedSecretKey;

    ...
    ...

    // (1)
    @DisplayName("does not throw any Exception when jws verify")
    @Test
    public void verifySignatureTest() {
        String accessToken = getAccessToken(Calendar.MINUTE, 10);
        assertDoesNotThrow(() -> jwtTokenizer.verifySignature(accessToken, base64EncodedSecretKey));
    }

    // (2)
    @DisplayName("throw ExpiredJwtException when jws verify")
    @Test
    public void verifyExpirationTest() throws InterruptedException {
        String accessToken = getAccessToken(Calendar.SECOND, 1);
        assertDoesNotThrow(() -> jwtTokenizer.verifySignature(accessToken, base64EncodedSecretKey));

        TimeUnit.MILLISECONDS.sleep(1500);

        assertThrows(ExpiredJwtException.class, () -> jwtTokenizer.verifySignature(accessToken, base64EncodedSecretKey));
    }
    
    ...
    ...

    private String getAccessToken(int timeUnit, int timeAmount) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("memberId", 1);
        claims.put("roles", List.of("USER"));

        String subject = "test access token";
        Calendar calendar = Calendar.getInstance();
        calendar.add(timeUnit, timeAmount);
        Date expiration = calendar.getTime();
        String accessToken = jwtTokenizer.generateAccessToken(claims, subject, expiration, base64EncodedSecretKey);

        return accessToken;
    }
}
```
(1) : JwtTokenizerì˜ verifySignature() ë©”ì„œë“œê°€ Signatureë¥¼ ì˜ ê²€ì¦í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸
  - ìƒì„±ëœ JWTë¥¼ verifySignature()ë¡œ ì „ë‹¬í•´ì„œ Exceptionì´ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ Signatureì— ëŒ€í•œ ê²€ì¦ì´ ì˜ ìˆ˜í–‰ëœ ê²ƒìœ¼ë¡œ ë³¼ ìˆ˜ ìˆìŒ

(2) : JWT ìƒì„± ì‹œ ì§€ì •í•œ ë§Œë£Œì¼ì‹œê°€ ì§€ë‚˜ë©´ JWTê°€ ë§Œë£Œë˜ëŠ”ì§€ë¥¼ í…ŒìŠ¤íŠ¸
  - ìƒì„±ë˜ëŠ” JWTì˜ ë§Œë£Œ ì£¼ê¸°ë¥¼ ì•„ì£¼ ì§§ê²Œ ì¤€ í›„ì— ì²« ë²ˆì§¸ Signature ê²€ì¦ì„ ìˆ˜í–‰í•˜ê³ , ë§Œë£Œì¼ì‹œê°€ ì§€ë‚˜ë„ë¡ ì§€ì—°ì‹œê°„ì„ ì¤€ ë’¤, ë‘ ë²ˆì§¸ Signature ê²€ì¦ì„ ìˆ˜í–‰í–ˆì„ ê²½ìš° ExpiredJwtExceptionì´ ë°œìƒí•˜ë©´ JWTê°€ ì •ìƒì ìœ¼ë¡œ ë§Œë£Œëœë‹¤ê³  ë³¼ ìˆ˜ ìˆìŒ