---
title: 엔티티 간의 연관 관계 매핑
excerpt: JPA 엔티티(Entity) 매핑과 연관 관계 매핑
categories: Spring
tags: [codestates, Spring]
toc: true
toc_sticky: true
author_profile: true
sidebar_main: true
published : true
---

## 방향성에 따른 연관 관계

### 단방향 연관 관계

<p align="center">
<img src="https://github.com/user-attachments/assets/e261d230-a01f-425b-a6aa-633428887755">

<p align="center"> [ Member가 Order를 참조할 수 있는 단방향 관계 ] </p>
</p>

- Member 클래스가 Order 객체를 원소로 포함하고 있는 List 객체를 가지고 있으므로, Order를 참조 가능
  - Member는 참조 객체 orders 를 통해 Order의 정보를 알 수 있지만, Order는 Member의 참조 값이 없으므로 Member 정보를 알 수 없음

<br>

<p align="center">
<img src="https://github.com/user-attachments/assets/577835bc-5829-4852-a26a-6a0dc5437d59">

<p align="center"> [ Order가 Member를 참조할 수 있는 단방향 관계 ]</p>
</p>

- Order 는 참조 객체 member 를 통해 Order의 정보를 알 수 있지만, Member는 Order 의 참조 값이 없으므로 Order 정보를 알 수 없음

<br>

### 양방향 연관 관계

<p align="center">
<img src="https://github.com/user-attachments/assets/c7bb88b5-9e18-4986-a6db-9662f5c7a3d7">

<p align="center"> [ Member 와 Order 가 서로 참조 가능한 양방향 관계 ]</p>
</p>

- 두 클래스 모두 서로의 참조 객체를 통해 정보를 알 수 있음

※ Spring Data JDBC는 단방향 연관 관계만 가능

<br>

## 객체 수에 따른 연관 관계

### 일대다(1:N) 단방향 연관 관계

일(1)에 해당하는 클래스가 다(N)에 해당하는 객체를 참조할 수 있는 관계

<p align="center">
<img src="https://github.com/user-attachments/assets/33e4f135-59e0-4a2b-a0f4-734f2877308e">

</p>

- 일대다(1:N) : 한 명의 회원이 여러 건의 주문을 할 수 있음
- 단방향 관계 : Member 만 List\<Order> 객체를 참조 가능

※ 일대다 단방향 매핑은 잘 사용하지 않음

- 테이블 간 관계에서 '다'에 해당하는 테이블이 '일'에 해당하는 테이블의 기본키를 외래키로 가짐
  - Order 클래스가 외래키에 해당하는 Member 클래스의 참조값을 가지고 있지 않음
    - 일반적인 테이블 간의 관계를 정상적으로 표현하지 못함
      - Order 클래스의 정보를 테이블에 저장하더라도 외래키에 해당하는 Member 클래스의 memberId 값이 빈 채로 저장됨
    - 다대일 단방향 매핑을 먼저 한 후, 필요한 경우에 일대다(1:N) 단방향 매핑을 추가하여 양방향 연관 관계를 만듦


<br>

### 다대일(N:1) 연관 관계

다(N)에 해당하는 클래스가 일(1)에 해당하는 객체를 참조할 수 있는 관계

<p align="center">
<img src="https://github.com/user-attachments/assets/bc88a66a-2fb6-4fec-ba1b-256975625050">

</p>

- 다대일(N:1) : 여러 건의 주문은 한 명의 회원에 속할 수 있음
- 단방향 관계 : Order만 Member 객체를 참조 가능

- Order 클래스가 Member 객체를 외래키처럼 가지고 있음
  - 테이블 간의 관계처럼 자연스러운 매핑 방식
    - JPA의 엔티티 연관 관계 중에서 가장 기본으로 사용되는 매핑 방식


#### ✔ 코드로 보는 다대일 연관 관계 매핑 방법

##### Order 클래스

```java
@NoArgsConstructor
@Getter
@Setter
@Entity(name = "ORDERS")
public class Order {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long orderId;

    ...

    @ManyToOne   // 
    @JoinColumn(name = "MEMBER_ID")  // 
    private Member member;

    public void addMember(Member member) {
        this.member = member;
    }
}
```

- @ManyToOne : 다대일(N:1)의 관계 명시
- @JoinColumn : 테이블 조인 시 사용되는 외래키에 해당하는 열 이름 지정
  - 일반적으로 부모 테이블에서 기본키로 설정된 열 이름과 동일하게 외래키 열을 만듦
- 다대일 단방향 연관 관계이므로 다(N) 에서만 매핑 작업을 하면 됨


#### ✔ 다대일 매핑을 이용한 회원과 주문 정보 저장

```java
@Configuration
public class JpaManyToOneUniDirectionConfig {
    private EntityManager em;
    private EntityTransaction tx;

    @Bean
    public CommandLineRunner testJpaManyToOneRunner(EntityManagerFactory emFactory) {
        this.em = emFactory.createEntityManager();
        this.tx = em.getTransaction();

        return args -> {
            mappingManyToOneUniDirection();
        };
    }

    private void mappingManyToOneUniDirection() {
        tx.begin();
        Member member = new Member("Hong Gil Dong");

        em.persist(member);   // 회원 정보 저장

        Order order = new Order();
        order.addMember(member);   // order 객체에 member 객체 저장(외래키)
        em.persist(order);     // 주문 정보 저장

        tx.commit();
	
        Order findOrder = em.find(Order.class, 1L);  // 1차 캐시에서 주문 정보 조회

        // 회원 정보 출력
        // 객체 그래프 탐색 : 객체를 통해 다른 객체의 정보를 얻는 것
        System.out.println("findOrder: " + findOrder.getMember().getMemberId() +
                        ", " + findOrder.getMember().getName());
    }
}
```

<br>

#### ✔ 다대일 매핑에 일대다 매핑 추가

다대일 매핑만으로는 자신이 주문한 목록을 회원이 확인할 수 없음 

##### Member 클래스
```java
@NoArgsConstructor
@Getter
@Setter
@Entity
public class Member {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long memberId;

    ...

    @OneToMany(mappedBy = "member") //
    private List<Order> orders = new ArrayList<>();

    public void addOrder(Order order) {
        orders.add(order);
    }
}
```
- @OneToMany : 일대다(1:N)의 관계 명시
- (mappedBy = "member")
  - 관계를 소유하고 있는 필드를 지정
    - 다(N)에 해당하는 클래스에서 외래키 역할을 하는 필드

※ 일대다 단방향 매핑은 참조할 대상이 없으므로 mappedBy 값이 필요없음



#### ✔ 다대일 매핑에 일대다 매핑을 추가하여 주문 정보 조회

```java
@Configuration
public class JpaManyToOneBiDirectionConfig {
    private EntityManager em;
    private EntityTransaction tx;

    @Bean
    public CommandLineRunner testJpaManyToOneRunner(EntityManagerFactory emFactory) {
        this.em = emFactory.createEntityManager();
        this.tx = em.getTransaction();

        return args -> {
            mappingManyToOneBiDirection();
        };
    }

    private void mappingManyToOneBiDirection() {
        tx.begin();
        Member member = new Member("Hong Gil Dong");
        Order order = new Order();

        member.addOrder(order); // (1) member 객체에 order 객체 저장
        order.addMember(member); // order 객체에 member 객체 저장(외래키)

        em.persist(member);   // 회원 정보 저장
        em.persist(order);    // 주문 정보 저장

        tx.commit();

				
        Member findMember = em.find(Member.class, 1L);  // 1차 캐시에서 회원 정보 조회

        // 객체 그래프 탐색을 통해 주문 정보에 접근 가능
        findMember
                .getOrders()
                .stream()
                .forEach(findOrder -> {
                    System.out.println("findOrder: " + findOrder.getOrderId());
                });
    }
}
```
- (1) : member 객체에 order 객체를 저장하지 않아도 테이블에는 member 와 order 정보가 정상적으로 저장이 됨
  - 하지만 member 객체에 order 객체를 추가해주지 않으면, findMember 객체로 order 객체를 조회할 수 없음
    - find() 메서드로 member 객체 조회 시, 1차 캐시에 저장된 member 객체가 order를 가지고 있지 않기 때문

<br>

### 다대다 연관 관계

커피 주문 시, 하나의 주문에 여러 개의 커피가 속할 수 있고, 하나의 커피는 여러 주문에 속할 수 있음

<p align="center">
<img src="https://github.com/user-attachments/assets/1a32a2b9-5f70-48f6-a19d-4e9efc88b150">

</p>

- 연결 테이블(조인 테이블)을 추가해서 두 개의 일대다 관계로 표현
  - JPA 에서 @ManyToMany 를 통해 다대다(N:M) 연관 관계를 제공하지만, 사용하지 않는 것을 추천
- 일대다 단방향 매핑은 외래키를 포함하지 않기 때문에 자주 사용되지 않는 매핑 방법이므로, 먼저 다대일 매핑을 한 후, 객체 그래프 탐색으로 객체를 조회할 수 없을 때 일대다 양방향 매핑 추가 

<br>
 
### 일대일 연관 관계

- @OneToOne 애너테이션 사용
  - 다대일 단방향 연관 관계 매핑과 동일
  - 양방향 매핑 : 다대일에 일대다 매핑을 추가하는 방식과 동일


### 엔티티 간의 연관 관계 매핑 권장방법
- 다대일 단방향 매핑부터 적용
- 객체 그래프 탐색으로 조회할 수 없는 정보가 있는 경우, 일대다 양방향 매핑 적용


## 추가 학습

- 엔티티 클래스의 연관 관계
  - https://docs.jboss.org/hibernate/orm/5.6/userguide/html_single/Hibernate_User_Guide.html#associations
- JPA에서의 FETCH와 FETCH 방식
  - https://docs.jboss.org/hibernate/orm/5.6/userguide/html_single/Hibernate_User_Guide.html#fetching
- JPA에서의 CASCADE
  - https://docs.jboss.org/hibernate/orm/5.6/userguide/html_single/Hibernate_User_Guide.html#pc-cascade

